var q=Object.defineProperty;var Z=(i,e,t)=>e in i?q(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var p=(i,e,t)=>Z(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function C(){const i=globalThis.Phaser;if(!i)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return i}const J=C();class Q extends J.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}const b=C(),ee={Grunzer:4942970,Sp√§her:5018988,Captain:16765286,Anf√ºhrer:15681391,Herausforderer:10258872,K√∂nig:1149618};function H(i){const t=i.split(" ")[0]??i;return t.length>12?`${t.slice(0,11)}‚Ä¶`:t}class te{constructor(e){p(this,"scene");p(this,"container");p(this,"circle");p(this,"nameText");p(this,"detailText");p(this,"hover");p(this,"blur");p(this,"currentOfficer");this.scene=e.scene,this.hover=e.onHover,this.blur=e.onBlur,this.currentOfficer=e.officer,this.container=this.scene.add.container(e.x,e.y),this.container.setSize(110,110),this.container.setDepth(1);const t=new b.Geom.Circle(0,0,48);this.container.setInteractive({hitArea:t,hitAreaCallback:b.Geom.Circle.Contains,useHandCursor:!0}),this.circle=this.scene.add.circle(0,0,30,16777215,1),this.circle.setStrokeStyle(2,858922,.6),this.nameText=this.scene.add.text(0,-6,H(e.officer.name),{fontFamily:"monospace",fontSize:"12px",color:"#f7f9fc",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.detailText=this.scene.add.text(0,24,"",{fontFamily:"monospace",fontSize:"10px",color:"#a9b7c6",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.container.add([this.circle,this.nameText,this.detailText]),this.container.on("pointerover",()=>{this.container.setDepth(2),this.scene.input.setDefaultCursor("pointer"),this.hover&&this.hover(this.currentOfficer)}),this.container.on("pointerout",()=>{this.container.setDepth(1),this.scene.input.setDefaultCursor("default"),this.blur&&this.blur()}),this.update(e.officer,{highlight:e.highlight})}update(e,t={}){this.currentOfficer=e,this.nameText.setText(H(e.name)),this.detailText.setText(`${e.rank} ‚Ä¢ Lv ${e.level}`);const n=e.status==="ALIVE",s=n?ee[e.rank]:3093559;this.circle.setFillStyle(s,n?1:.35),this.container.setAlpha(n?1:.45),this.scene.tweens.killTweensOf(this.container);let r=n?858922:2825503,o=n?.6:.9,a=2;t.highlight&&n?(r=16170336,o=.95,a=3,this.scene.tweens.add({targets:this.container,duration:240,scale:1.1,yoyo:!0,ease:b.Math.Easing.Sine.InOut})):this.container.setScale(1),this.circle.setStrokeStyle(a,r,o)}setPosition(e,t,n={}){if(n.immediate){this.container.setPosition(e,t);return}const s=b.Math.Distance.Between(this.container.x,this.container.y,e,t);if(s<4){this.container.setPosition(e,t);return}this.scene.tweens.add({targets:this.container,x:e,y:t,duration:200+s*.4,ease:b.Math.Easing.Sine.InOut})}getPosition(){return{x:this.container.x,y:this.container.y}}destroy(){this.container.destroy(!0)}}function ie(i){const e=new Set;return i&&(i.newWarcalls.forEach(t=>{e.add(t.initiator),t.participants.forEach(n=>e.add(n)),t.hiddenRoles.forEach(n=>e.add(n.who))}),i.resolved.forEach(t=>{const{warcall:n}=t;e.add(n.initiator),n.participants.forEach(s=>e.add(s)),t.victorious.forEach(s=>e.add(s)),t.defeated.forEach(s=>e.add(s)),t.casualties.forEach(s=>e.add(s.officerId))}),i.replacements.forEach(t=>e.add(t.id))),e}const P=Object.freeze({columns:5,cellWidth:120,cellHeight:110,originX:120,originY:120});function B(i,e,t){let n=e,s=t;return s<n&&([n,s]=[s,n]),Math.min(Math.max(i,n),s)}function U(i,e){const t=Math.max(1,Math.floor(e));if(!Number.isFinite(i.width)||!Number.isFinite(i.height)||i.width<=0||i.height<=0)return P;const n=Math.max(i.width,1),s=Math.max(i.height,1),r=B(n*.1,48,n/2),o=B(s*.1,48,s/2),a=Math.max(1,n-r*2),l=Math.max(1,s-o*2);if(a<1||l<1)return P;const c=Math.max(1,Math.floor(a/96)),h=Math.max(1,Math.floor(l/110)),f=Math.max(1,Math.min(6,c,t)),u=Math.ceil(Math.sqrt(t));let m=B(u,1,f);const g=Math.max(1,Math.min(f,Math.ceil(t/h)));m<g&&(m=g);let E=Math.max(1,Math.ceil(t/m));for(;E>h&&m<f;)m+=1,E=Math.max(1,Math.ceil(t/m));const S=a/m,T=l/E,A=i.x+r+S/2,d=i.y+o+T/2;return{columns:m,cellWidth:S,cellHeight:T,originX:A,originY:d}}function K(i,e=P){return Array.from({length:i},(t,n)=>{const s=n%e.columns,r=Math.floor(n/e.columns);return{x:e.originX+s*e.cellWidth,y:e.originY+r*e.cellHeight}})}class se{constructor(e){p(this,"state");this.state=e>>>0}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967295}int(e,t){return Math.floor(this.next()*(t-e+1))+e}chance(e){return this.next()<e}pick(e){if(e.length===0)throw new Error("Cannot pick from empty array");return e[this.int(0,e.length-1)]}shuffle(e){const t=[...e];for(let n=t.length-1;n>0;n--){const s=this.int(0,n);[t[n],t[s]]=[t[s],t[n]]}return t}}const j=20,ne=2,re=4,oe=10,ae={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Sp√§her:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anf√ºhrer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},K√∂nig:{promoteAtMerit:null,demoteBelowMerit:260}},ce={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},le={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},he=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],de=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],N=["Schlackengrube","Sch√§delh√ºgel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],ue=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],fe=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],pe=["Bestienj√§ger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"],me=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],ye=["Leder","Ketten","Schuppen","Sch√§delplatten"],ge=["Blutring","Schlackenfetisch","K√∂nigszahn","Sturmsiegel"],Ee=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function w(i){return Math.max(0,Math.min(1,i))}function Se(i){return`${i.pick(ue)}${i.pick(fe)}`}function Te(i){return{aggression:w(i.next()),loyalty:w(i.next()),opportunism:w(i.next()),ambition:w(i.next())}}function Ae(i){const e=i.chance(.3)?2:1;return i.shuffle(he).slice(0,e)}function xe(i){const e=i.shuffle(Ee),t=i.chance(.25)?2:1;return e.slice(0,t)}function be(i){const e=i.chance(.5)?i.pick(ge):void 0;return{weapon:i.pick(me),armor:i.pick(ye),trinket:e}}function Oe(i){switch(i){case"Grunzer":return 10;case"Sp√§her":return 40;case"Captain":return 80;case"Anf√ºhrer":return 140;case"Herausforderer":return 210;case"K√∂nig":return 320}}function Me(i){return i.chance(.3)?[i.pick(pe)]:[]}function R(i,e={}){const t=e.rank??"Grunzer",n=e.id??`orc_${Math.round(i.next()*1e9)}`,s=e.equipment??be(i),r=e.level??i.int(t==="K√∂nig"?8:1,t==="K√∂nig"?12:6),o=e.merit??Math.max(0,Math.round(Oe(t)+i.int(-15,20)));return{id:n,name:e.name??Se(i),clan:e.clan??i.pick(de),titles:e.titles??Me(i),level:r,rank:t,merit:o,combatStyle:e.combatStyle??xe(i),traits:e.traits??Ae(i),equipment:s,gearScore:e.gearScore??i.int(8,16),status:e.status??"ALIVE",personality:e.personality??Te(i),relationships:e.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:e.memories??[],territory:e.territory??[i.pick(N)],lastBloodOathCycle:e.lastBloodOathCycle}}function v(i,e,t=12){const n=[...i.memories,e].slice(-t);return{...i,memories:n}}function ke(i,e){return{...i,merit:Math.max(0,i.merit+e)}}function V(i){return{...i,status:"DEAD"}}function we(i,e){return i.relationships.bloodOathWith?i.lastBloodOathCycle!==void 0&&e-i.lastBloodOathCycle<=oe:!1}class Le{constructor(e,t){this.rng=e,this.state=t}getAlive(){return this.state.officers.filter(e=>e.status==="ALIVE")}getById(e){return this.state.officers.find(t=>t.id===e)}registerDeath(e,t){const n=[],s=[],r=this.state.officers.map(a=>a.id!==e?a:(n.push({officerId:e,status:"DEAD",reason:"BATTLE"}),s.push({id:`death_${e}_${t}`,cycle:t,text:`${a.name} f√§llt im Kampf`,tags:["DEATH"]}),V(a))),o=r.find(a=>a.id===e);if(o&&o.relationships.bloodOathWith){const a=o.relationships.bloodOathWith,l=r.findIndex(c=>c.id===a);if(l>=0){const c=r[l];c.status==="ALIVE"&&we(c,t)&&(n.push({officerId:c.id,status:"DEAD",reason:"BLOOD_OATH"}),s.push({id:`blood_${c.id}_${t}`,cycle:t,text:`${c.name} stirbt durch den Blutschwur mit ${o.name}`,tags:["DEATH","BLOODOATH"]}),r[l]=V(c))}}return this.state.officers=r,{updatedOfficers:r,casualties:n,feed:s}}rewardMerit(e,t,n,s){this.state.officers=this.state.officers.map(r=>{if(r.id!==e)return r;const o=ke(r,t);return v(o,{cycle:n,type:"WARCALL",notes:s})})}ensureRoster(e){const t=[];for(;this.getAlive().length<j;){const n=R(this.rng,{rank:"Grunzer"}),s=v(n,{cycle:e,type:"WARCALL",notes:"Frisch rekrutiert"});t.push(s),this.state.officers.push(s)}return t}registerBloodOath(e,t,n){this.state.officers=this.state.officers.map(s=>s.id===e?{...s,relationships:{...s.relationships,bloodOathWith:t},lastBloodOathCycle:n}:s.id===t?{...s,relationships:{...s.relationships,bloodOathWith:e},lastBloodOathCycle:n}:s)}detectCycleTrigger(e){return this.getAlive().length<e?"OFFICER_DEATH":null}}function $(i,e){let t=10+i.level*4+i.gearScore+i.merit*.15;for(const s of i.traits){const r=ce[s]??1;t*=r;const o=le[s]??0;if(o>0){const a=e.filter(l=>l.traits.includes(s)).length;t*=1+a*o}}i.relationships.bloodOathWith&&e.some(s=>s.id===i.relationships.bloodOathWith)&&(t*=1.15);const n=e.filter(s=>i.relationships.friends.includes(s.id)).length;return t*=1+n*.05,i.relationships.rivals.some(s=>e.some(r=>r.id===s))&&(t*=.9),t*=.95+i.personality.aggression*.1,t*=.9+i.personality.loyalty*.1,t}function k(i,e){const t=i,n=i.reduce((r,o)=>r+$(o,t),0),s=.9+e.next()*.2;return n*s}function Re(i,e,t){let n=.05+e.personality.opportunism*.25-e.personality.loyalty*.2;return e.relationships.rivals.includes(t.id)&&(n+=.15),e.relationships.bloodOathWith===t.id&&(n=0),n>0&&i.chance(Math.min(.8,Math.max(0,n)))}function y(i,e,t,n){return{id:`feed_${e}_${Math.round(i.next()*1e9)}`,cycle:e,text:t,tags:n}}function ve(i,e){return e.map(t=>i.getById(t)).filter(t=>!!(t&&t.status==="ALIVE"))}function I(i,e,t,n,s){e.forEach(r=>i.rewardMerit(r.id,n,t,s))}function x(i,e,t){const{casualties:n,feed:s}=i.registerDeath(e.id,t);return{casualties:n,feed:s}}function Y(i,e,t,n,s,r,o){const a=[];if(k(s,i)>=r){I(n,s,t.cycle,e.rewards.merit,o);const f=y(i,t.cycle,`${s[0].name}s Gruppe triumphiert bei ${e.location}`,[e.type,"SUCCESS"]);return a.push(f),{warcall:e,victorious:s.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:a}}const c=i.pick(s),h=x(n,c,t.cycle);return a.push(y(i,t.cycle,`${c.name} kehrt nicht von ${e.location} zur√ºck`,[e.type,"DEATH"])),{warcall:e,victorious:[],defeated:[c.id],betrayals:[],casualties:h.casualties,feedEntries:[...a,...h.feed]}}function Ie(i,e,t,n,s){const r=[],o=e.hiddenRoles.find(u=>u.role==="ASSASSIN"),a=o?s.find(u=>u.id===o.who):s[0],l=s.find(u=>u.id!==(a==null?void 0:a.id));if(!a||!l)return r.push(y(i,t.cycle,`Attentat ${e.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const c=$(a,[a]),h=$(l,[l]),f=(i.next()-.5)*4;if(c+f>h){const u=x(n,l,t.cycle);return n.rewardMerit(a.id,e.rewards.merit,t.cycle,"Gelungenes Attentat"),r.push(y(i,t.cycle,`${a.name} meuchelt ${l.name} in ${e.location}`,["ASSASSINATION","SUCCESS"])),{warcall:e,victorious:[a.id],defeated:[l.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}if(i.chance(.5)){const u=x(n,a,t.cycle);return r.push(y(i,t.cycle,`${a.name} stirbt beim gescheiterten Attentat auf ${l.name}`,["ASSASSINATION","DEATH"])),{warcall:e,victorious:[l.id],defeated:[a.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}return r.push(y(i,t.cycle,`${l.name} wehrt ${a.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:e,victorious:[l.id],defeated:[],betrayals:[],casualties:[],feedEntries:r}}function We(i,e,t,n,s){const r=[],o=s.find(d=>d.id===e.initiator);if(!o)return r.push(y(i,t.cycle,`√úberfall ${e.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=s.filter(d=>d.id!==o.id);if(a.length===0)return r.push(y(i,t.cycle,`${o.name} findet keine Gegner f√ºr den √úberfall`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const l=Math.max(1,Math.floor(a.length/2)),c=[o,...a.slice(0,l)],h=a.slice(l);if(h.length===0)return r.push(y(i,t.cycle,`${o.name} vertreibt Pl√ºnderer ohne Widerstand`,["OVERFALL","NO_DEF"])),I(n,c,t.cycle,Math.round(e.rewards.merit/2),"Leichter √úberfall"),{warcall:e,victorious:c.map(d=>d.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const f=[];for(const d of c.slice(1))Re(i,d,o)&&(h.push(d),c.splice(c.indexOf(d),1),f.push(d.id));const u=k(c,i),m=k(h,i),g=u>=m,E=g?h:c,S=g?c:h;I(n,S,t.cycle,e.rewards.merit,"√úberfall-Erfolg");const T=i.pick(E),A=x(n,T,t.cycle);return r.push(y(i,t.cycle,`${S[0].name}s Seite siegt bei ${e.location}`,["OVERFALL",g?"SUCCESS":"FAIL"])),{warcall:e,victorious:S.map(d=>d.id),defeated:E.map(d=>d.id),betrayals:f,casualties:A.casualties,feedEntries:[...r,...A.feed]}}function Ce(i,e,t,n,s){const r=[],o=s.find(d=>d.id===e.initiator);if(!o)return r.push(y(i,t.cycle,`S√§uberung ${e.id} scheitert ohne K√∂nig`,["PURGE","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=s.filter(d=>d.id===o.id||e.hiddenRoles.some(G=>G.who===d.id&&G.role==="LOYALIST")),l=s.filter(d=>!a.includes(d));if(l.length===0)return r.push(y(i,t.cycle,`${o.name} erzwingt neue Treueschw√ºre`,["PURGE","LOYALTY"])),I(n,a,t.cycle,Math.round(e.rewards.merit/2),"Treueeid"),{warcall:e,victorious:a.map(d=>d.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const c=l.filter(d=>i.chance(.4)),h=l.filter(d=>!c.includes(d)),f=h.map(d=>d.id);if(h.length===0)return r.push(y(i,t.cycle,`${o.name} erkl√§rt ${c.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:e,victorious:a.map(d=>d.id),defeated:c.map(d=>d.id),betrayals:f,casualties:[],feedEntries:r};const u=k(a,i),m=k(h,i),g=u>=m,E=g?h:a,S=g?a:h,T=i.pick(E),A=x(n,T,t.cycle);return r.push(y(i,t.cycle,`${S[0].name} entscheidet die S√§uberung`,["PURGE",g?"SUCCESS":"REBELLION"])),{warcall:e,victorious:S.map(d=>d.id),defeated:E.map(d=>d.id),betrayals:f,casualties:A.casualties,feedEntries:[...r,...A.feed]}}function Ne(i,e,t,n,s){const r=[];s.forEach(a=>n.rewardMerit(a.id,Math.round(e.rewards.merit/2),t.cycle,"Feast-Bindung"));const o=y(i,t.cycle,`${s[0].name} richtet ein heikles Festmahl in ${e.location}`,["FEAST","BOND"]);if(r.push(o),s.length>1&&i.chance(.15)){const a=i.pick(s.slice(1)),l=i.pick(s.filter(h=>h.id!==a.id)),c=x(n,l,t.cycle);return r.push(y(i,t.cycle,`${a.name} vergiftet ${l.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:e,victorious:[a.id],defeated:[l.id],betrayals:[a.id],casualties:c.casualties,feedEntries:[...r,...c.feed]}}return{warcall:e,victorious:s.map(a=>a.id),defeated:[],betrayals:[],casualties:[],feedEntries:r}}function Be(i,e,t,n){const s=ve(n,e.participants);if(s.length===0)return{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[y(i,t.cycle,`Warcall ${e.id} entf√§llt mangels Teilnehmer`,["EMPTY"])]};switch(e.type){case"HUNT":return Y(i,e,t,n,s,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return Y(i,e,t,n,s,26,"Monster bezwungen");case"ASSASSINATION":return Ie(i,e,t,n,s);case"OVERFALL":return We(i,e,t,n,s);case"PURGE":return Ce(i,e,t,n,s);case"FEAST":default:return Ne(i,e,t,n,s)}}function D(i,e){return`wc_${i.cycle}_${i.warcalls.length}_${Math.round(e.next()*1e6)}`}function Pe(i){const e=i.next();return e<.5?"AGENDA":e<.8?"RANDOM":"PLAYER"}function $e(i){return i.personality.aggression>.7?"OVERFALL":i.personality.opportunism>.6?"ASSASSINATION":i.rank==="K√∂nig"?"PURGE":"FEAST"}function De(i){return i.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function F(i,e,t,n,s){const r=e.officers.filter(h=>h.status==="ALIVE"&&h.id!==t.id),o=i.shuffle(r);if(o.length===0)return[t];const a=Math.max(1,Math.min(n,o.length)),l=i.int(1,a),c=o.slice(0,l);if(s){const h=e.officers.find(f=>f.id===e.playerId&&f.status==="ALIVE");h&&!c.some(f=>f.id===h.id)&&h.id!==t.id&&(c[c.length-1]=h)}return[t,...c]}function _(i,e,t){return e==="ASSASSINATION"?[{who:i.pick(t).id,role:"ASSASSIN"}]:e==="PURGE"?t.slice(1).map(n=>({who:n.id,role:i.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function z(i){switch(i){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienj√§ger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function Fe(i,e,t){const n=$e(t),s=F(i,e,t,n==="PURGE"?5:3,!1);return{id:D(e,i),type:n,source:"AGENDA",initiator:t.id,participants:s.map(r=>r.id),hiddenRoles:_(i,n,s),location:i.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:z(n),state:"ANNOUNCED"}}function _e(i,e){const t=e.officers.filter(o=>o.status==="ALIVE"),n=i.pick(t),s=De(i),r=F(i,e,n,3,!1);return{id:D(e,i),type:s,source:"RANDOM",initiator:n.id,participants:r.map(o=>o.id),hiddenRoles:_(i,s,r),location:i.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:z(s),state:"ANNOUNCED"}}function ze(i,e){const t=e.officers.find(r=>r.id===e.playerId&&r.status==="ALIVE");if(!t)return null;const n=t.rank==="Grunzer"?"HUNT":"OVERFALL",s=F(i,e,t,2,!0);return{id:D(e,i),type:n,source:"PLAYER",initiator:t.id,participants:s.map(r=>r.id),hiddenRoles:_(i,n,s),location:i.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:z(n),state:"ANNOUNCED"}}function Ge(i,e){const t=e.warcalls.filter(o=>o.state!=="RESOLVED"),n=i.int(ne,re),s=Math.max(0,n-t.length),r=[];for(let o=0;o<s;o++){const a=Pe(i),l=e.officers.filter(h=>h.status==="ALIVE");if(l.length<2)break;let c=null;if(a==="AGENDA"){const h=[...l].sort((f,u)=>u.personality.ambition-f.personality.ambition);c=Fe(i,e,h[0])}else a==="RANDOM"?c=_e(i,e):c=ze(i,e);c&&(r.push(c),e.warcalls.push(c))}return r}function He(i,e,t){const n=[];for(const s of e.warcalls){if(s.state==="RESOLVED"||e.cycle<s.deadlineCycle)continue;s.state="IN_PROGRESS";const r=Be(i,s,e,t);s.state="RESOLVED",n.push(r)}return n}const M=["Grunzer","Sp√§her","Captain","Anf√ºhrer","Herausforderer","K√∂nig"];function Ue(i){const e=M.indexOf(i);return e===-1||e>=M.length-1?null:M[e+1]}function Ke(i){const e=M.indexOf(i);return e<=0?null:M[e-1]}function W(i,e,t,n){return{id:`cycle_${e}_${Math.round(i.next()*1e9)}`,cycle:e,text:t,tags:n}}function Ve(i,e){const t=[],n=[];return e.officers=e.officers.map(s=>{if(s.status!=="ALIVE")return s;const r=ae[s.rank],o=r.promoteAtMerit!==null&&s.merit>=r.promoteAtMerit?Ue(s.rank):null;if(o)return t.push({officerId:s.id,from:s.rank,to:o}),n.push(W(i,e.cycle,`${s.name} steigt zum ${o} auf`,["PROMOTION"])),v({...s,rank:o},{cycle:e.cycle,type:"PROMOTION",notes:`Aufstieg zu ${o}`});const a=r.demoteBelowMerit!==null&&s.merit<r.demoteBelowMerit?Ke(s.rank):null;return a?(t.push({officerId:s.id,from:s.rank,to:a}),n.push(W(i,e.cycle,`${s.name} f√§llt zum ${a} zur√ºck`,["DEMOTION"])),v({...s,rank:a},{cycle:e.cycle,type:"DEMOTION",notes:`R√ºckstufung zu ${a}`})):s}),{changes:t,feed:n}}function Ye(i){return i.flatMap(e=>e.feedEntries)}function Xe(i,e,t="DEBUG"){const n=new Le(i,e),s=n.getAlive().length;e.cycle+=1;const r=He(i,e,n),o=Ve(i,e),a=n.ensureRoster(e.cycle),l=Ge(i,e),c=[];c.push(...Ye(r)),c.push(...o.feed),a.forEach(u=>{c.push(W(i,e.cycle,`${u.name} tritt als Rekrut bei`,["RECRUIT"]))}),l.forEach(u=>{c.push(W(i,e.cycle,`Neuer Warcall ${u.type} bei ${u.location}`,["WARCALL","NEW"]))}),e.feed=[...e.feed,...c].slice(-60);const f=n.detectCycleTrigger(s)??t;return{cycle:e.cycle,trigger:f,newWarcalls:l,resolved:r,hierarchyChanges:o.changes,replacements:a,feed:c}}function je(i){return Array.from({length:j},(t,n)=>n===0?R(i,{rank:"K√∂nig",titles:["K√∂nig"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):n===1?R(i,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):R(i,{}))}class X{constructor(e){p(this,"state");p(this,"rng");this.rng=new se(e.seed);const t=je(this.rng),n=t[0].id,s=t[1].id;this.state={cycle:0,officers:t,warcalls:[],kingId:n,playerId:s,feed:[]}}runCycle(e="DEBUG"){return Xe(this.rng,this.state,e)}}const O=C(),qe={WARCALL_COMPLETED:"Warcall abgeschlossen",FREE_ROAM_TIMEOUT:"Freies Spiel (Timeout)",OFFICER_DEATH:"Offizier gefallen",DEBUG:"Debug"};function Ze(i){const e=i.split(" ")[0]??i;return e.length>10?`${e.slice(0,9)}‚Ä¶`:e}class Je extends O.Scene{constructor(){super("Play");p(this,"world");p(this,"officerTokens",new Map);p(this,"cycleText");p(this,"triggerText");p(this,"feedLabel");p(this,"feedText");p(this,"warcallLabel");p(this,"warcallsText");p(this,"detailLabel");p(this,"detailText");p(this,"controlsText");p(this,"boardBg");p(this,"sidebarBg");p(this,"connections");p(this,"boardArea",{x:120,y:120,width:620,height:500});p(this,"sidebarArea",{x:660,y:36,width:280,height:520});p(this,"sidebarPadding",24)}create(){this.world=new X({seed:Date.now()}),this.boardBg=this.add.rectangle(0,0,10,10,1054496,.92).setOrigin(0,0),this.boardBg.setStrokeStyle(2,2568767,.85),this.sidebarBg=this.add.rectangle(0,0,10,10,857114,.92).setOrigin(0,0),this.sidebarBg.setStrokeStyle(1,2041907,.6),this.connections=this.add.graphics(),this.connections.setDepth(.5),this.cycleText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"22px",color:"#f1f2f6"}),this.triggerText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#cbd0d6"}),this.feedLabel=this.add.text(0,0,"Welt-Feed",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.feedText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.warcallLabel=this.add.text(0,0,"Aktive Warcalls",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.warcallsText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.detailLabel=this.add.text(0,0,"Details",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.detailText=this.add.text(0,0,"Fahre mit der Maus √ºber ein Portr√§t oder tippe es an.",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:4}).setWordWrapWidth(240),this.controlsText=this.add.text(0,0,"E: Cycle simulieren   R: Welt neu generieren",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}),this.scale.on(O.Scale.Events.RESIZE,this.configureLayout,this),this.configureLayout(),this.refreshScene(),this.input.keyboard.on("keydown-E",()=>this.advanceCycle()),this.input.keyboard.on("keydown-R",()=>this.resetWorld()),this.events.once(O.Scenes.Events.SHUTDOWN,()=>{this.officerTokens.forEach(t=>t.destroy()),this.officerTokens.clear(),this.scale.off(O.Scale.Events.RESIZE,this.configureLayout,this)})}update(t,n){}advanceCycle(){const t=this.world.runCycle();this.refreshScene(t)}resetWorld(){this.officerTokens.forEach(t=>t.destroy()),this.officerTokens.clear(),this.world=new X({seed:Date.now()}),this.refreshScene()}refreshScene(t){const n=ie(t);this.cycleText.setText(`Cycle ${this.world.state.cycle}`);const s=t?this.formatTrigger(t.trigger):"Start der Kampagne";this.triggerText.setText(`Ausl√∂ser: ${s}`),this.syncOfficerTokens(n,t),this.refreshFeed(t),this.refreshWarcalls(t),this.drawConnections(t),this.updateSidebarFlow()}formatTrigger(t){return qe[t]??t}syncOfficerTokens(t,n){const s=this.world.state.officers.length,r=U(this.boardArea,s),o=K(s,r),a=new Set,l=!n;this.world.state.officers.forEach((c,h)=>{const f=o[h],u=t.has(c.id);let m=this.officerTokens.get(c.id);m?(m.setPosition(f.x,f.y,{immediate:l}),m.update(c,{highlight:u})):(m=new te({scene:this,x:f.x,y:f.y,officer:c,highlight:u,onHover:g=>this.showOfficerDetails(g),onBlur:()=>this.clearOfficerDetails()}),this.officerTokens.set(c.id,m)),a.add(c.id)}),this.officerTokens.forEach((c,h)=>{a.has(h)||(c.destroy(),this.officerTokens.delete(h))})}refreshFeed(t){const n=new Set((t==null?void 0:t.feed.map(o=>o.id))??[]),s=this.world.state.feed.slice(-6);if(s.length===0){this.feedText.setText("Keine Meldungen ‚Äì starte einen Warcall!");return}const r=s.map(o=>`${n.has(o.id)?"¬ª":"‚Ä¢"} [${o.cycle}] ${o.text}`);this.feedText.setText(r.join(`

`))}refreshWarcalls(t){const n=this.world.state.warcalls.filter(o=>o.state!=="RESOLVED");if(n.length===0){this.warcallsText.setText("Keine aktiven Warcalls.");return}const s=new Set((t==null?void 0:t.newWarcalls.map(o=>o.id))??[]),r=n.map(o=>this.describeWarcall(o,s.has(o.id)));this.warcallsText.setText(r.join(`

`))}describeWarcall(t,n){const s=n?"¬ª":"‚Ä¢",r=[t.initiator,...t.participants].map(o=>this.getOfficerShortName(o)).join(", ");return`${s} ${t.type} @ ${t.location}
   ${r}`}drawConnections(t){this.connections.clear();const n=(r,o,a,l)=>{const c=this.officerTokens.get(r.initiator);if(!c)return;const h=c.getPosition();r.participants.forEach(f=>{const u=this.officerTokens.get(f);if(!u)return;const m=u.getPosition();this.connections.lineStyle(l,o,a),this.connections.strokeLineShape(new O.Geom.Line(h.x,h.y,m.x,m.y))})};this.world.state.warcalls.filter(r=>r.state!=="RESOLVED").forEach(r=>n(r,5032432,.35,2)),t&&(t.newWarcalls.forEach(r=>n(r,16170336,.65,3)),t.resolved.forEach(r=>n(r.warcall,15681391,.55,3)))}configureLayout(){const t=Math.max(this.scale.gameSize.width,1),n=Math.max(this.scale.gameSize.height,1),s=Math.max(24,Math.round(Math.min(t,n)*.04));this.cycleText.setPosition(s,s),this.triggerText.setPosition(s,s+28),this.controlsText.setPosition(s,n-s-this.controlsText.height);const r=Math.max(t-s*3,0);let o=Math.min(Math.max(r*.64,0),r),a=r-o;if(r>0){const S=Math.min(Math.max(220,r*.28),r);a<S&&(a=S,o=r-a);const T=Math.min(Math.max(320,r*.55),r);o<T&&(o=T,a=r-o)}const l=s+72,c=this.controlsText.y,h=Math.max(l+220,c-16);let f=Math.max(320,h-l);f>h-l&&(f=h-l);const u=s,m=Math.max(l,h-f);this.boardBg.setPosition(u,m),this.boardBg.setDisplaySize(o,f);const g=u+o+s,E=Math.max(200,n-s*2);this.sidebarBg.setPosition(g,s),this.sidebarBg.setDisplaySize(a,E),this.boardArea={x:u,y:m,width:o,height:f},this.sidebarArea={x:g,y:s,width:a,height:E},this.sidebarPadding=Math.max(20,Math.round(a*.08)),this.reflowOfficerPositions(),this.drawConnections(),this.updateSidebarFlow()}reflowOfficerPositions(){if(!this.world||this.officerTokens.size===0)return;const t=this.world.state.officers.length,n=U(this.boardArea,t),s=K(t,n);this.world.state.officers.forEach((r,o)=>{const a=this.officerTokens.get(r.id);a&&a.setPosition(s[o].x,s[o].y,{immediate:!0})})}updateSidebarFlow(){if(this.sidebarArea.width<=0||this.sidebarArea.height<=0)return;const t=this.sidebarArea.x+this.sidebarPadding,n=this.sidebarArea.y+this.sidebarPadding,s=Math.max(160,this.sidebarArea.width-this.sidebarPadding*2);this.feedLabel.setPosition(t,n),this.feedText.setPosition(t,this.feedLabel.y+this.feedLabel.height+6),this.feedText.setWordWrapWidth(s);let o=this.feedText.getBounds().bottom+24;this.warcallLabel.setPosition(t,o),this.warcallsText.setPosition(t,this.warcallLabel.y+this.warcallLabel.height+6),this.warcallsText.setWordWrapWidth(s),o=this.warcallsText.getBounds().bottom+24;const l=this.sidebarArea.y+this.sidebarArea.height-this.sidebarPadding;o+this.detailLabel.height+6>l&&(o=Math.max(n,l-(this.detailLabel.height+6))),this.detailLabel.setPosition(t,o);const c=this.detailLabel.y+this.detailLabel.height+6;this.detailText.setPosition(t,c);const h=Math.max(0,l-c);this.detailText.setWordWrapWidth(s),this.detailText.setFixedSize(s,h)}showOfficerDetails(t){const n=t.traits.length>0?t.traits.join(", "):"Keine bekannten Traits",s=t.relationships.bloodOathWith?`Blutschwur: ${this.getOfficerShortName(t.relationships.bloodOathWith)}`:void 0,r=t.relationships.loyalToKing?"Loyal zum K√∂nig":void 0,o=t.relationships.friends.length>0?`Freunde: ${t.relationships.friends.length}`:void 0,a=t.relationships.rivals.length>0?`Rivalen: ${t.relationships.rivals.length}`:void 0,l=[s,r,o,a].filter(Boolean).join(" ‚Ä¢ ")||"Ungebunden";this.detailText.setText(`${t.name} (${t.rank}, Lv ${t.level})
Clan ${t.clan} ‚Ä¢ Merit ${t.merit}
Traits: ${n}
Beziehungen: ${l}`)}clearOfficerDetails(){this.detailText.setText("Fahre mit der Maus √ºber ein Portr√§t oder tippe es an.")}getOfficerShortName(t){const n=this.world.state.officers.find(r=>r.id===t);if(!n)return t.slice(0,6);const s=Ze(n.name);return n.rank==="K√∂nig"?`üëë ${s}`:s}}const L=C();class Qe extends L.Game{constructor(e){const t={type:L.AUTO,parent:e,backgroundColor:"#0b0d10",width:window.innerWidth,height:window.innerHeight,pixelArt:!0,scale:{mode:L.Scale.RESIZE,autoCenter:L.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[Q,Je]};super(t)}}new Qe(document.getElementById("app"));
