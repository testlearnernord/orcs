var W=Object.defineProperty;var z=(t,e,n)=>e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>z(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function C(){const t=globalThis.Phaser;if(!t)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return t}const V=C();class H extends V.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}class K{constructor(e){A(this,"state");this.state=e>>>0}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967295}int(e,n){return Math.floor(this.next()*(n-e+1))+e}chance(e){return this.next()<e}pick(e){if(e.length===0)throw new Error("Cannot pick from empty array");return e[this.int(0,e.length-1)]}shuffle(e){const n=[...e];for(let i=n.length-1;i>0;i--){const r=this.int(0,i);[n[i],n[r]]=[n[r],n[i]]}return n}}const U=20,Y=2,q=4,X=10,j={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Späher:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anführer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},König:{promoteAtMerit:null,demoteBelowMerit:260}},J={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},Q={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},Z=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],ee=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],N=["Schlackengrube","Schädelhügel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],te=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],ne=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],re=["Bestienjäger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"],ie=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],se=["Leder","Ketten","Schuppen","Schädelplatten"],oe=["Blutring","Schlackenfetisch","Königszahn","Sturmsiegel"],ce=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function g(t){return Math.max(0,Math.min(1,t))}function ae(t){return`${t.pick(te)}${t.pick(ne)}`}function le(t){return{aggression:g(t.next()),loyalty:g(t.next()),opportunism:g(t.next()),ambition:g(t.next())}}function ue(t){const e=t.chance(.3)?2:1;return t.shuffle(Z).slice(0,e)}function de(t){const e=t.shuffle(ce),n=t.chance(.25)?2:1;return e.slice(0,n)}function he(t){const e=t.chance(.5)?t.pick(oe):void 0;return{weapon:t.pick(ie),armor:t.pick(se),trinket:e}}function fe(t){switch(t){case"Grunzer":return 10;case"Späher":return 40;case"Captain":return 80;case"Anführer":return 140;case"Herausforderer":return 210;case"König":return 320}}function pe(t){return t.chance(.3)?[t.pick(re)]:[]}function k(t,e={}){const n=e.rank??"Grunzer",i=e.id??`orc_${Math.round(t.next()*1e9)}`,r=e.equipment??he(t),s=e.level??t.int(n==="König"?8:1,n==="König"?12:6),c=e.merit??Math.max(0,Math.round(fe(n)+t.int(-15,20)));return{id:i,name:e.name??ae(t),clan:e.clan??t.pick(ee),titles:e.titles??pe(t),level:s,rank:n,merit:c,combatStyle:e.combatStyle??de(t),traits:e.traits??ue(t),equipment:r,gearScore:e.gearScore??t.int(8,16),status:e.status??"ALIVE",personality:e.personality??le(t),relationships:e.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:e.memories??[],territory:e.territory??[t.pick(N)],lastBloodOathCycle:e.lastBloodOathCycle}}function L(t,e,n=12){const i=[...t.memories,e].slice(-n);return{...t,memories:i}}function me(t,e){return{...t,merit:Math.max(0,t.merit+e)}}function F(t){return{...t,status:"DEAD"}}function ye(t,e){return t.relationships.bloodOathWith?t.lastBloodOathCycle!==void 0&&e-t.lastBloodOathCycle<=X:!1}class Ae{constructor(e,n){this.rng=e,this.state=n}getAlive(){return this.state.officers.filter(e=>e.status==="ALIVE")}getById(e){return this.state.officers.find(n=>n.id===e)}registerDeath(e,n){const i=[],r=[],s=this.state.officers.map(o=>o.id!==e?o:(i.push({officerId:e,status:"DEAD",reason:"BATTLE"}),r.push({id:`death_${e}_${n}`,cycle:n,text:`${o.name} fällt im Kampf`,tags:["DEATH"]}),F(o))),c=s.find(o=>o.id===e);if(c&&c.relationships.bloodOathWith){const o=c.relationships.bloodOathWith,l=s.findIndex(a=>a.id===o);if(l>=0){const a=s[l];a.status==="ALIVE"&&ye(a,n)&&(i.push({officerId:a.id,status:"DEAD",reason:"BLOOD_OATH"}),r.push({id:`blood_${a.id}_${n}`,cycle:n,text:`${a.name} stirbt durch den Blutschwur mit ${c.name}`,tags:["DEATH","BLOODOATH"]}),s[l]=F(a))}}return this.state.officers=s,{updatedOfficers:s,casualties:i,feed:r}}rewardMerit(e,n,i,r){this.state.officers=this.state.officers.map(s=>{if(s.id!==e)return s;const c=me(s,n);return L(c,{cycle:i,type:"WARCALL",notes:r})})}ensureRoster(e){const n=[];for(;this.getAlive().length<U;){const i=k(this.rng,{rank:"Grunzer"}),r=L(i,{cycle:e,type:"WARCALL",notes:"Frisch rekrutiert"});n.push(r),this.state.officers.push(r)}return n}registerBloodOath(e,n,i){this.state.officers=this.state.officers.map(r=>r.id===e?{...r,relationships:{...r.relationships,bloodOathWith:n},lastBloodOathCycle:i}:r.id===n?{...r,relationships:{...r.relationships,bloodOathWith:e},lastBloodOathCycle:i}:r)}detectCycleTrigger(e){return this.getAlive().length<e?"OFFICER_DEATH":null}}function $(t,e){let n=10+t.level*4+t.gearScore+t.merit*.15;for(const r of t.traits){const s=J[r]??1;n*=s;const c=Q[r]??0;if(c>0){const o=e.filter(l=>l.traits.includes(r)).length;n*=1+o*c}}t.relationships.bloodOathWith&&e.some(r=>r.id===t.relationships.bloodOathWith)&&(n*=1.15);const i=e.filter(r=>t.relationships.friends.includes(r.id)).length;return n*=1+i*.05,t.relationships.rivals.some(r=>e.some(s=>s.id===r))&&(n*=.9),n*=.95+t.personality.aggression*.1,n*=.9+t.personality.loyalty*.1,n}function R(t,e){const n=t,i=t.reduce((s,c)=>s+$(c,n),0),r=.9+e.next()*.2;return i*r}function Ee(t,e,n){let i=.05+e.personality.opportunism*.25-e.personality.loyalty*.2;return e.relationships.rivals.includes(n.id)&&(i+=.15),e.relationships.bloodOathWith===n.id&&(i=0),i>0&&t.chance(Math.min(.8,Math.max(0,i)))}function p(t,e,n,i){return{id:`feed_${e}_${Math.round(t.next()*1e9)}`,cycle:e,text:n,tags:i}}function Se(t,e){return e.map(n=>t.getById(n)).filter(n=>!!(n&&n.status==="ALIVE"))}function I(t,e,n,i,r){e.forEach(s=>t.rewardMerit(s.id,i,n,r))}function E(t,e,n){const{casualties:i,feed:r}=t.registerDeath(e.id,n);return{casualties:i,feed:r}}function w(t,e,n,i,r,s,c){const o=[];if(R(r,t)>=s){I(i,r,n.cycle,e.rewards.merit,c);const f=p(t,n.cycle,`${r[0].name}s Gruppe triumphiert bei ${e.location}`,[e.type,"SUCCESS"]);return o.push(f),{warcall:e,victorious:r.map(h=>h.id),defeated:[],betrayals:[],casualties:[],feedEntries:o}}const a=t.pick(r),d=E(i,a,n.cycle);return o.push(p(t,n.cycle,`${a.name} kehrt nicht von ${e.location} zurück`,[e.type,"DEATH"])),{warcall:e,victorious:[],defeated:[a.id],betrayals:[],casualties:d.casualties,feedEntries:[...o,...d.feed]}}function Oe(t,e,n,i,r){const s=[],c=e.hiddenRoles.find(h=>h.role==="ASSASSIN"),o=c?r.find(h=>h.id===c.who):r[0],l=r.find(h=>h.id!==(o==null?void 0:o.id));if(!o||!l)return s.push(p(t,n.cycle,`Attentat ${e.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const a=$(o,[o]),d=$(l,[l]),f=(t.next()-.5)*4;if(a+f>d){const h=E(i,l,n.cycle);return i.rewardMerit(o.id,e.rewards.merit,n.cycle,"Gelungenes Attentat"),s.push(p(t,n.cycle,`${o.name} meuchelt ${l.name} in ${e.location}`,["ASSASSINATION","SUCCESS"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[],casualties:h.casualties,feedEntries:[...s,...h.feed]}}if(t.chance(.5)){const h=E(i,o,n.cycle);return s.push(p(t,n.cycle,`${o.name} stirbt beim gescheiterten Attentat auf ${l.name}`,["ASSASSINATION","DEATH"])),{warcall:e,victorious:[l.id],defeated:[o.id],betrayals:[],casualties:h.casualties,feedEntries:[...s,...h.feed]}}return s.push(p(t,n.cycle,`${l.name} wehrt ${o.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:e,victorious:[l.id],defeated:[],betrayals:[],casualties:[],feedEntries:s}}function Te(t,e,n,i,r){const s=[],c=r.find(u=>u.id===e.initiator);if(!c)return s.push(p(t,n.cycle,`Überfall ${e.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const o=r.filter(u=>u.id!==c.id);if(o.length===0)return s.push(p(t,n.cycle,`${c.name} findet keine Gegner für den Überfall`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const l=Math.max(1,Math.floor(o.length/2)),a=[c,...o.slice(0,l)],d=o.slice(l);if(d.length===0)return s.push(p(t,n.cycle,`${c.name} vertreibt Plünderer ohne Widerstand`,["OVERFALL","NO_DEF"])),I(i,a,n.cycle,Math.round(e.rewards.merit/2),"Leichter Überfall"),{warcall:e,victorious:a.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:s};const f=[];for(const u of a.slice(1))Ee(t,u,c)&&(d.push(u),a.splice(a.indexOf(u),1),f.push(u.id));const h=R(a,t),M=R(d,t),m=h>=M,S=m?d:a,y=m?a:d;I(i,y,n.cycle,e.rewards.merit,"Überfall-Erfolg");const v=t.pick(S),O=E(i,v,n.cycle);return s.push(p(t,n.cycle,`${y[0].name}s Seite siegt bei ${e.location}`,["OVERFALL",m?"SUCCESS":"FAIL"])),{warcall:e,victorious:y.map(u=>u.id),defeated:S.map(u=>u.id),betrayals:f,casualties:O.casualties,feedEntries:[...s,...O.feed]}}function Re(t,e,n,i,r){const s=[],c=r.find(u=>u.id===e.initiator);if(!c)return s.push(p(t,n.cycle,`Säuberung ${e.id} scheitert ohne König`,["PURGE","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const o=r.filter(u=>u.id===c.id||e.hiddenRoles.some(_=>_.who===u.id&&_.role==="LOYALIST")),l=r.filter(u=>!o.includes(u));if(l.length===0)return s.push(p(t,n.cycle,`${c.name} erzwingt neue Treueschwüre`,["PURGE","LOYALTY"])),I(i,o,n.cycle,Math.round(e.rewards.merit/2),"Treueeid"),{warcall:e,victorious:o.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:s};const a=l.filter(u=>t.chance(.4)),d=l.filter(u=>!a.includes(u)),f=d.map(u=>u.id);if(d.length===0)return s.push(p(t,n.cycle,`${c.name} erklärt ${a.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:e,victorious:o.map(u=>u.id),defeated:a.map(u=>u.id),betrayals:f,casualties:[],feedEntries:s};const h=R(o,t),M=R(d,t),m=h>=M,S=m?d:o,y=m?o:d,v=t.pick(S),O=E(i,v,n.cycle);return s.push(p(t,n.cycle,`${y[0].name} entscheidet die Säuberung`,["PURGE",m?"SUCCESS":"REBELLION"])),{warcall:e,victorious:y.map(u=>u.id),defeated:S.map(u=>u.id),betrayals:f,casualties:O.casualties,feedEntries:[...s,...O.feed]}}function ge(t,e,n,i,r){const s=[];r.forEach(o=>i.rewardMerit(o.id,Math.round(e.rewards.merit/2),n.cycle,"Feast-Bindung"));const c=p(t,n.cycle,`${r[0].name} richtet ein heikles Festmahl in ${e.location}`,["FEAST","BOND"]);if(s.push(c),r.length>1&&t.chance(.15)){const o=t.pick(r.slice(1)),l=t.pick(r.filter(d=>d.id!==o.id)),a=E(i,l,n.cycle);return s.push(p(t,n.cycle,`${o.name} vergiftet ${l.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[o.id],casualties:a.casualties,feedEntries:[...s,...a.feed]}}return{warcall:e,victorious:r.map(o=>o.id),defeated:[],betrayals:[],casualties:[],feedEntries:s}}function ke(t,e,n,i){const r=Se(i,e.participants);if(r.length===0)return{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[p(t,n.cycle,`Warcall ${e.id} entfällt mangels Teilnehmer`,["EMPTY"])]};switch(e.type){case"HUNT":return w(t,e,n,i,r,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return w(t,e,n,i,r,26,"Monster bezwungen");case"ASSASSINATION":return Oe(t,e,n,i,r);case"OVERFALL":return Te(t,e,n,i,r);case"PURGE":return Re(t,e,n,i,r);case"FEAST":default:return ge(t,e,n,i,r)}}function x(t,e){return`wc_${t.cycle}_${t.warcalls.length}_${Math.round(e.next()*1e6)}`}function Le(t){const e=t.next();return e<.5?"AGENDA":e<.8?"RANDOM":"PLAYER"}function Ie(t){return t.personality.aggression>.7?"OVERFALL":t.personality.opportunism>.6?"ASSASSINATION":t.rank==="König"?"PURGE":"FEAST"}function be(t){return t.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function D(t,e,n,i,r){const s=e.officers.filter(d=>d.status==="ALIVE"&&d.id!==n.id),c=t.shuffle(s);if(c.length===0)return[n];const o=Math.max(1,Math.min(i,c.length)),l=t.int(1,o),a=c.slice(0,l);if(r){const d=e.officers.find(f=>f.id===e.playerId&&f.status==="ALIVE");d&&!a.some(f=>f.id===d.id)&&d.id!==n.id&&(a[a.length-1]=d)}return[n,...a]}function B(t,e,n){return e==="ASSASSINATION"?[{who:t.pick(n).id,role:"ASSASSIN"}]:e==="PURGE"?n.slice(1).map(i=>({who:i.id,role:t.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function P(t){switch(t){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienjäger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function Ne(t,e,n){const i=Ie(n),r=D(t,e,n,i==="PURGE"?5:3,!1);return{id:x(e,t),type:i,source:"AGENDA",initiator:n.id,participants:r.map(s=>s.id),hiddenRoles:B(t,i,r),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(i),state:"ANNOUNCED"}}function Me(t,e){const n=e.officers.filter(c=>c.status==="ALIVE"),i=t.pick(n),r=be(t),s=D(t,e,i,3,!1);return{id:x(e,t),type:r,source:"RANDOM",initiator:i.id,participants:s.map(c=>c.id),hiddenRoles:B(t,r,s),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(r),state:"ANNOUNCED"}}function ve(t,e){const n=e.officers.find(s=>s.id===e.playerId&&s.status==="ALIVE");if(!n)return null;const i=n.rank==="Grunzer"?"HUNT":"OVERFALL",r=D(t,e,n,2,!0);return{id:x(e,t),type:i,source:"PLAYER",initiator:n.id,participants:r.map(s=>s.id),hiddenRoles:B(t,i,r),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(i),state:"ANNOUNCED"}}function $e(t,e){const n=e.warcalls.filter(c=>c.state!=="RESOLVED"),i=t.int(Y,q),r=Math.max(0,i-n.length),s=[];for(let c=0;c<r;c++){const o=Le(t),l=e.officers.filter(d=>d.status==="ALIVE");if(l.length<2)break;let a=null;if(o==="AGENDA"){const d=[...l].sort((f,h)=>h.personality.ambition-f.personality.ambition);a=Ne(t,e,d[0])}else o==="RANDOM"?a=Me(t,e):a=ve(t,e);a&&(s.push(a),e.warcalls.push(a))}return s}function Ce(t,e,n){const i=[];for(const r of e.warcalls){if(r.state==="RESOLVED"||e.cycle<r.deadlineCycle)continue;r.state="IN_PROGRESS";const s=ke(t,r,e,n);r.state="RESOLVED",i.push(s)}return i}const T=["Grunzer","Späher","Captain","Anführer","Herausforderer","König"];function xe(t){const e=T.indexOf(t);return e===-1||e>=T.length-1?null:T[e+1]}function De(t){const e=T.indexOf(t);return e<=0?null:T[e-1]}function b(t,e,n,i){return{id:`cycle_${e}_${Math.round(t.next()*1e9)}`,cycle:e,text:n,tags:i}}function Be(t,e){const n=[],i=[];return e.officers=e.officers.map(r=>{if(r.status!=="ALIVE")return r;const s=j[r.rank],c=s.promoteAtMerit!==null&&r.merit>=s.promoteAtMerit?xe(r.rank):null;if(c)return n.push({officerId:r.id,from:r.rank,to:c}),i.push(b(t,e.cycle,`${r.name} steigt zum ${c} auf`,["PROMOTION"])),L({...r,rank:c},{cycle:e.cycle,type:"PROMOTION",notes:`Aufstieg zu ${c}`});const o=s.demoteBelowMerit!==null&&r.merit<s.demoteBelowMerit?De(r.rank):null;return o?(n.push({officerId:r.id,from:r.rank,to:o}),i.push(b(t,e.cycle,`${r.name} fällt zum ${o} zurück`,["DEMOTION"])),L({...r,rank:o},{cycle:e.cycle,type:"DEMOTION",notes:`Rückstufung zu ${o}`})):r}),{changes:n,feed:i}}function Pe(t){return t.flatMap(e=>e.feedEntries)}function _e(t,e,n="DEBUG"){const i=new Ae(t,e),r=i.getAlive().length;e.cycle+=1;const s=Ce(t,e,i),c=Be(t,e),o=i.ensureRoster(e.cycle),l=$e(t,e),a=[];a.push(...Pe(s)),a.push(...c.feed),o.forEach(h=>{a.push(b(t,e.cycle,`${h.name} tritt als Rekrut bei`,["RECRUIT"]))}),l.forEach(h=>{a.push(b(t,e.cycle,`Neuer Warcall ${h.type} bei ${h.location}`,["WARCALL","NEW"]))}),e.feed=[...e.feed,...a].slice(-60);const f=i.detectCycleTrigger(r)??n;return{cycle:e.cycle,trigger:f,newWarcalls:l,resolved:s,hierarchyChanges:c.changes,replacements:o,feed:a}}function Fe(t){return Array.from({length:U},(n,i)=>i===0?k(t,{rank:"König",titles:["König"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):i===1?k(t,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):k(t,{}))}class we{constructor(e){A(this,"state");A(this,"rng");this.rng=new K(e.seed);const n=Fe(this.rng),i=n[0].id,r=n[1].id;this.state={cycle:0,officers:n,warcalls:[],kingId:i,playerId:r,feed:[]}}runCycle(e="DEBUG"){return _e(this.rng,this.state,e)}}const Ge=C();class Ue extends Ge.Scene{constructor(){super("Play");A(this,"world");A(this,"info")}create(){this.world=new we({seed:Date.now()}),this.info=this.add.text(8,8,"Cycle 0",{fontSize:"14px"}).setDepth(10),this.input.keyboard.on("keydown-E",()=>{const n=this.world.runCycle();this.info.setText(`Cycle ${n.cycle} | Feed: ${n.feed.length} | Resolved: ${n.resolved.length}`),console.table(n.feed.slice(-5))}),this.add.text(8,28,"Drück E für nächsten Cycle",{fontSize:"12px"})}update(n,i){}}const G=C();class We extends G.Game{constructor(e){const n={type:G.AUTO,parent:e,width:960,height:540,backgroundColor:"#0b0d10",pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[H,Ue]};super(n)}}new We(document.getElementById("app"));
