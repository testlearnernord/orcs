var ce=Object.defineProperty;var le=(i,t,e)=>t in i?ce(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var f=(i,t,e)=>le(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function _(){const i=globalThis.Phaser;if(!i)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return i}const he=_();class de extends he.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}const v=_(),ue={Grunzer:4942970,Sp√§her:5018988,Captain:16765286,Anf√ºhrer:15681391,Herausforderer:10258872,K√∂nig:1149618};function J(i){const e=i.split(" ")[0]??i;return e.length>12?`${e.slice(0,11)}‚Ä¶`:e}class fe{constructor(t){f(this,"scene");f(this,"container");f(this,"circle");f(this,"nameText");f(this,"detailText");f(this,"hover");f(this,"blur");f(this,"currentOfficer");this.scene=t.scene,this.hover=t.onHover,this.blur=t.onBlur,this.currentOfficer=t.officer,this.container=this.scene.add.container(t.x,t.y),this.container.setSize(110,110),this.container.setDepth(1);const e=new v.Geom.Circle(0,0,48);this.container.setInteractive({hitArea:e,hitAreaCallback:v.Geom.Circle.Contains,useHandCursor:!0}),this.circle=this.scene.add.circle(0,0,30,16777215,1),this.circle.setStrokeStyle(2,858922,.6),this.nameText=this.scene.add.text(0,-6,J(t.officer.name),{fontFamily:"monospace",fontSize:"12px",color:"#f7f9fc",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.detailText=this.scene.add.text(0,24,"",{fontFamily:"monospace",fontSize:"10px",color:"#a9b7c6",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.container.add([this.circle,this.nameText,this.detailText]),this.container.on("pointerover",()=>{this.container.setDepth(2),this.scene.input.setDefaultCursor("pointer"),this.hover&&this.hover(this.currentOfficer)}),this.container.on("pointerout",()=>{this.container.setDepth(1),this.scene.input.setDefaultCursor("default"),this.blur&&this.blur()}),this.update(t.officer,{highlight:t.highlight})}update(t,e={}){this.currentOfficer=t,this.nameText.setText(J(t.name)),this.detailText.setText(`${t.rank} ‚Ä¢ Lv ${t.level}`);const s=t.status==="ALIVE",n=s?ue[t.rank]:3093559;this.circle.setFillStyle(n,s?1:.35),this.container.setAlpha(s?1:.45),this.scene.tweens.killTweensOf(this.container);let r=s?858922:2825503,o=s?.6:.9,a=2;e.highlight&&s?(r=16170336,o=.95,a=3,this.scene.tweens.add({targets:this.container,duration:240,scale:1.1,yoyo:!0,ease:v.Math.Easing.Sine.InOut})):this.container.setScale(1),this.circle.setStrokeStyle(a,r,o)}setPosition(t,e,s={}){if(s.immediate){this.container.setPosition(t,e);return}const n=v.Math.Distance.Between(this.container.x,this.container.y,t,e);if(n<4){this.container.setPosition(t,e);return}this.scene.tweens.add({targets:this.container,x:t,y:e,duration:200+n*.4,ease:v.Math.Easing.Sine.InOut})}getPosition(){return{x:this.container.x,y:this.container.y}}destroy(){this.container.destroy(!0)}}const M={FEAST:"üçñ",OVERFALL:"‚öîÔ∏è",ASSASSINATION:"üó°Ô∏è",HUNT:"üèπ",MONSTER_HUNT:"üêâ",PURGE:"üî•"},L={FEAST:"Festmahl",OVERFALL:"√úberfall",ASSASSINATION:"Attentat",HUNT:"Jagd",MONSTER_HUNT:"Monsterjagd",PURGE:"S√§uberung"},me={FEAST:"Bindungen st√§rken",OVERFALL:"Beute sichern",ASSASSINATION:"Ziel ausschalten",HUNT:"Troph√§e erlegen",MONSTER_HUNT:"Bestie besiegen",PURGE:"Rivalen s√§ubern"};function ye(i,t){return i?i.relationships.friends.includes(t.id)||t.relationships.friends.includes(i.id):!1}function pe(i,t){return i?i.relationships.rivals.includes(t.id)||t.relationships.rivals.includes(i.id):!1}function ne(i,t,e){if(i.initiator===t.id)return"Ausrufer";const s=i.hiddenRoles.find(n=>n.who===t.id);if(s)switch(s.role){case"ASSASSIN":return"Assassine";case"TRAITOR":return"Rivale (verdeckt)";case"LOYALIST":return"Loyalist"}return pe(e,t)?"Rivale":ye(e,t)?"Verb√ºndeter":"Supporter"}function ge(i,t,e){return`${L[i]} @ ${t} (${e})`}function Se(i,t){return t.state==="RESOLVED"?!1:t.initiator===i.id?!0:t.participants.includes(i.id)}function Oe(i,t,e){const s=t.find(o=>Se(i,o));if(!s)return{summary:"Freies Spiel"};const n=e(s.initiator),r=ne(s,i,n);return{summary:ge(s.type,s.location,r),warcallId:s.id,role:r}}function Ae(i){const t=new Set;return i&&(i.newWarcalls.forEach(e=>{t.add(e.initiator),e.participants.forEach(s=>t.add(s)),e.hiddenRoles.forEach(s=>t.add(s.who))}),i.resolved.forEach(e=>{const{warcall:s}=e;t.add(s.initiator),s.participants.forEach(n=>t.add(n)),e.victorious.forEach(n=>t.add(n)),e.defeated.forEach(n=>t.add(n)),e.casualties.forEach(n=>t.add(n.officerId))}),i.replacements.forEach(e=>t.add(e.id))),t}const K=Object.freeze({columns:5,cellWidth:120,cellHeight:110,originX:120,originY:120});function U(i,t,e){let s=t,n=e;return n<s&&([s,n]=[n,s]),Math.min(Math.max(i,s),n)}function Q(i,t){const e=Math.max(1,Math.floor(t));if(!Number.isFinite(i.width)||!Number.isFinite(i.height)||i.width<=0||i.height<=0)return K;const s=Math.max(i.width,1),n=Math.max(i.height,1),r=U(s*.1,48,s/2),o=U(n*.1,48,n/2),a=Math.max(1,s-r*2),h=Math.max(1,n-o*2);if(a<1||h<1)return K;const c=Math.max(1,Math.floor(a/96)),l=Math.max(1,Math.floor(h/110)),d=Math.max(1,Math.min(6,c,e)),u=Math.ceil(Math.sqrt(e));let y=U(u,1,d);const p=Math.max(1,Math.min(d,Math.ceil(e/l)));y<p&&(y=p);let g=Math.max(1,Math.ceil(e/y));for(;g>l&&y<d;)y+=1,g=Math.max(1,Math.ceil(e/y));const S=a/y,A=h/g,E=i.x+r+S/2,m=i.y+o+A/2;return{columns:y,cellWidth:S,cellHeight:A,originX:E,originY:m}}function ee(i,t=K){return Array.from({length:i},(e,s)=>{const n=s%t.columns,r=Math.floor(s/t.columns);return{x:t.originX+n*t.cellWidth,y:t.originY+r*t.cellHeight}})}const re=20,Ee=2,Te=4,Ie=10,be={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Sp√§her:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anf√ºhrer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},K√∂nig:{promoteAtMerit:null,demoteBelowMerit:260}},xe={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},ve={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},Me=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],Le=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],G=["Schlackengrube","Sch√§delh√ºgel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],we=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],We=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],Be=["Bestienj√§ger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"];function Re(i,t,e){return t.filter(s=>s.id!==i.id&&s.traits.includes(e)).length}function W(i,t){let e=10+i.level*4+i.gearScore+i.merit*.15;for(const n of i.traits){const r=xe[n]??1;e*=r;const o=ve[n]??0;if(o>0){const a=Re(i,t,n);e*=1+a*o}}i.relationships.bloodOathWith&&t.some(n=>n.id===i.relationships.bloodOathWith)&&(e*=1.15);const s=t.filter(n=>i.relationships.friends.includes(n.id)).length;return s>0&&(e*=1+s*.05),i.relationships.rivals.some(n=>t.some(r=>r.id===n))&&(e*=.9),e*=.95+i.personality.aggression*.1,e*=.9+i.personality.loyalty*.1,e}function b(i){return i.length===0?0:i.reduce((t,e)=>t+W(e,i),0)}function Ce(i,t){return(t.participants.includes(t.initiator)?t.participants:[t.initiator,...t.participants]).map(s=>i.officers.find(n=>n.id===s&&n.status==="ALIVE")).filter(s=>!!s)}function ke(i,t){return i.officers.find(e=>e.id===t)}function I(i){return Number.isNaN(i)?.5:Number.isFinite(i)?Math.min(1,Math.max(0,i)):i>0?1:0}function oe(i,t){return t<=0?i>0?1:0:I(i/(i+t))}function De(i){return i==="MONSTER_HUNT"?26:16}function Ne(i,t,e){const s=t.hiddenRoles.find(c=>c.role==="ASSASSIN"),n=s?e.find(c=>c.id===s.who):e[0],o=e.filter(c=>c.id!==(n==null?void 0:n.id)).sort((c,l)=>l.level-c.level)[0];if(!n||!o)return .5;const a=W(n,[n]),h=W(o,[o]);return I(a/(h*1.15))}function Pe(i,t){let e=.05+i.personality.opportunism*.25-i.personality.loyalty*.2;return i.relationships.rivals.includes(t.id)&&(e+=.15),i.relationships.bloodOathWith===t.id&&(e=0),I(e)}function $e(i,t,e){const s=e.find(d=>d.id===t.initiator);if(!s)return .5;const n=e.filter(d=>d.id!==s.id);if(n.length===0)return .8;const r=Math.max(1,Math.floor(n.length/2)),o=[s,...n.slice(0,r)],a=n.slice(r);if(a.length===0)return .9;const h=o.slice(1).reduce((d,u)=>d+Pe(u,s),0),c=b(o)*(1-h*.2),l=b(a);return oe(c,l)}function Fe(i,t){const e=b(t),s=De(i.type)*t.length;return I(e/(s*1.1))}function He(i,t,e){const s=e.find(l=>l.id===t.initiator);if(!s)return .5;const n=e.filter(l=>l.id===s.id||t.hiddenRoles.some(d=>d.who===l.id&&d.role==="LOYALIST")),r=e.filter(l=>!n.includes(l));if(r.length===0)return .85;const o=b(n),a=b(r),h=oe(o,a),c=r.length*.05;return I(h*(1-c)+.1)}function ze(i){if(i.length<=1)return .95;const e=i.slice(1).map(s=>.15).reduce((s,n)=>s+n,0);return I(.95-e*.1)}function _e(i,t,e){switch(t.type){case"ASSASSINATION":return Ne(i,t,e);case"OVERFALL":return $e(i,t,e);case"PURGE":return He(i,t,e);case"HUNT":case"MONSTER_HUNT":return Fe(t,e);case"FEAST":default:return ze(e)}}function Ge(i,t){const e=Ce(i,t);if(e.length===0)return .5;const s=ke(i,t.initiator);return!s||s.status!=="ALIVE"?.5:I(_e(i,t,e))}class Ve{constructor(t){f(this,"state");this.state=t>>>0}next(){let t=this.state;return t^=t<<13,t^=t>>>17,t^=t<<5,this.state=t>>>0,this.state/4294967295}int(t,e){return Math.floor(this.next()*(e-t+1))+t}chance(t){return this.next()<t}pick(t){if(t.length===0)throw new Error("Cannot pick from empty array");return t[this.int(0,t.length-1)]}shuffle(t){const e=[...t];for(let s=e.length-1;s>0;s--){const n=this.int(0,s);[e[s],e[n]]=[e[n],e[s]]}return e}}const Ue=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],Ke=["Leder","Ketten","Schuppen","Sch√§delplatten"],Ye=["Blutring","Schlackenfetisch","K√∂nigszahn","Sturmsiegel"],je=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function N(i){return Math.max(0,Math.min(1,i))}function Xe(i){return`${i.pick(we)}${i.pick(We)}`}function qe(i){return{aggression:N(i.next()),loyalty:N(i.next()),opportunism:N(i.next()),ambition:N(i.next())}}function Ze(i){const t=i.chance(.3)?2:1;return i.shuffle(Me).slice(0,t)}function Je(i){const t=i.shuffle(je),e=i.chance(.25)?2:1;return t.slice(0,e)}function Qe(i){const t=i.chance(.5)?i.pick(Ye):void 0;return{weapon:i.pick(Ue),armor:i.pick(Ke),trinket:t}}function et(i){switch(i){case"Grunzer":return 10;case"Sp√§her":return 40;case"Captain":return 80;case"Anf√ºhrer":return 140;case"Herausforderer":return 210;case"K√∂nig":return 320}}function tt(i){return i.chance(.3)?[i.pick(Be)]:[]}function $(i,t={}){const e=t.rank??"Grunzer",s=t.id??`orc_${Math.round(i.next()*1e9)}`,n=t.equipment??Qe(i),r=t.level??i.int(e==="K√∂nig"?8:1,e==="K√∂nig"?12:6),o=t.merit??Math.max(0,Math.round(et(e)+i.int(-15,20)));return{id:s,name:t.name??Xe(i),clan:t.clan??i.pick(Le),titles:t.titles??tt(i),level:r,rank:e,merit:o,combatStyle:t.combatStyle??Je(i),traits:t.traits??Ze(i),equipment:n,gearScore:t.gearScore??i.int(8,16),status:t.status??"ALIVE",personality:t.personality??qe(i),relationships:t.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:t.memories??[],territory:t.territory??[i.pick(G)],lastBloodOathCycle:t.lastBloodOathCycle}}function F(i,t,e=12){const s=[...i.memories,t].slice(-e);return{...i,memories:s}}function it(i,t){return{...i,merit:Math.max(0,i.merit+t)}}function te(i){return{...i,status:"DEAD"}}function st(i,t){return i.relationships.bloodOathWith?i.lastBloodOathCycle!==void 0&&t-i.lastBloodOathCycle<=Ie:!1}class nt{constructor(t,e){this.rng=t,this.state=e}getAlive(){return this.state.officers.filter(t=>t.status==="ALIVE")}getById(t){return this.state.officers.find(e=>e.id===t)}registerDeath(t,e){const s=[],n=[],r=this.state.officers.map(a=>a.id!==t?a:(s.push({officerId:t,status:"DEAD",reason:"BATTLE"}),n.push({id:`death_${t}_${e}`,cycle:e,text:`${a.name} f√§llt im Kampf`,tags:["DEATH"]}),te(a))),o=r.find(a=>a.id===t);if(o&&o.relationships.bloodOathWith){const a=o.relationships.bloodOathWith,h=r.findIndex(c=>c.id===a);if(h>=0){const c=r[h];c.status==="ALIVE"&&st(c,e)&&(s.push({officerId:c.id,status:"DEAD",reason:"BLOOD_OATH"}),n.push({id:`blood_${c.id}_${e}`,cycle:e,text:`${c.name} stirbt durch den Blutschwur mit ${o.name}`,tags:["DEATH","BLOODOATH"]}),r[h]=te(c))}}return this.state.officers=r,{updatedOfficers:r,casualties:s,feed:n}}rewardMerit(t,e,s,n){this.state.officers=this.state.officers.map(r=>{if(r.id!==t)return r;const o=it(r,e);return F(o,{cycle:s,type:"WARCALL",notes:n})})}ensureRoster(t){const e=[];for(;this.getAlive().length<re;){const s=$(this.rng,{rank:"Grunzer"}),n=F(s,{cycle:t,type:"WARCALL",notes:"Frisch rekrutiert"});e.push(n),this.state.officers.push(n)}return e}registerBloodOath(t,e,s){this.state.officers=this.state.officers.map(n=>n.id===t?{...n,relationships:{...n.relationships,bloodOathWith:e},lastBloodOathCycle:s}:n.id===e?{...n,relationships:{...n.relationships,bloodOathWith:t},lastBloodOathCycle:s}:n)}detectCycleTrigger(t){return this.getAlive().length<t?"OFFICER_DEATH":null}}function B(i,t){const e=b(i),s=.9+t.next()*.2;return e*s}function rt(i,t,e){let s=.05+t.personality.opportunism*.25-t.personality.loyalty*.2;return t.relationships.rivals.includes(e.id)&&(s+=.15),t.relationships.bloodOathWith===e.id&&(s=0),s>0&&i.chance(Math.min(.8,Math.max(0,s)))}function O(i,t,e,s){return{id:`feed_${t}_${Math.round(i.next()*1e9)}`,cycle:t,text:e,tags:s}}function ot(i,t){return t.map(e=>i.getById(e)).filter(e=>!!(e&&e.status==="ALIVE"))}function H(i,t,e,s,n){t.forEach(r=>i.rewardMerit(r.id,s,e,n))}function x(i,t,e){const{casualties:s,feed:n}=i.registerDeath(t.id,e);return{casualties:s,feed:n}}function ie(i,t,e,s,n,r,o){const a=[];if(B(n,i)>=r){H(s,n,e.cycle,t.rewards.merit,o);const d=O(i,e.cycle,`${n[0].name}s Gruppe triumphiert bei ${t.location}`,[t.type,"SUCCESS"]);return a.push(d),{warcall:t,victorious:n.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:a}}const c=i.pick(n),l=x(s,c,e.cycle);return a.push(O(i,e.cycle,`${c.name} kehrt nicht von ${t.location} zur√ºck`,[t.type,"DEATH"])),{warcall:t,victorious:[],defeated:[c.id],betrayals:[],casualties:l.casualties,feedEntries:[...a,...l.feed]}}function at(i,t,e,s,n){const r=[],o=t.hiddenRoles.find(u=>u.role==="ASSASSIN"),a=o?n.find(u=>u.id===o.who):n[0],h=n.find(u=>u.id!==(a==null?void 0:a.id));if(!a||!h)return r.push(O(i,e.cycle,`Attentat ${t.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:t,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const c=W(a,[a]),l=W(h,[h]),d=(i.next()-.5)*4;if(c+d>l){const u=x(s,h,e.cycle);return s.rewardMerit(a.id,t.rewards.merit,e.cycle,"Gelungenes Attentat"),r.push(O(i,e.cycle,`${a.name} meuchelt ${h.name} in ${t.location}`,["ASSASSINATION","SUCCESS"])),{warcall:t,victorious:[a.id],defeated:[h.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}if(i.chance(.5)){const u=x(s,a,e.cycle);return r.push(O(i,e.cycle,`${a.name} stirbt beim gescheiterten Attentat auf ${h.name}`,["ASSASSINATION","DEATH"])),{warcall:t,victorious:[h.id],defeated:[a.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}return r.push(O(i,e.cycle,`${h.name} wehrt ${a.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:t,victorious:[h.id],defeated:[],betrayals:[],casualties:[],feedEntries:r}}function ct(i,t,e,s,n){const r=[],o=n.find(m=>m.id===t.initiator);if(!o)return r.push(O(i,e.cycle,`√úberfall ${t.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:t,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=n.filter(m=>m.id!==o.id);if(a.length===0)return r.push(O(i,e.cycle,`${o.name} findet keine Gegner f√ºr den √úberfall`,["OVERFALL","ABORTED"])),{warcall:t,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const h=Math.max(1,Math.floor(a.length/2)),c=[o,...a.slice(0,h)],l=a.slice(h);if(l.length===0)return r.push(O(i,e.cycle,`${o.name} vertreibt Pl√ºnderer ohne Widerstand`,["OVERFALL","NO_DEF"])),H(s,c,e.cycle,Math.round(t.rewards.merit/2),"Leichter √úberfall"),{warcall:t,victorious:c.map(m=>m.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const d=[];for(const m of c.slice(1))rt(i,m,o)&&(l.push(m),c.splice(c.indexOf(m),1),d.push(m.id));const u=B(c,i),y=B(l,i),p=u>=y,g=p?l:c,S=p?c:l;H(s,S,e.cycle,t.rewards.merit,"√úberfall-Erfolg");const A=i.pick(g),E=x(s,A,e.cycle);return r.push(O(i,e.cycle,`${S[0].name}s Seite siegt bei ${t.location}`,["OVERFALL",p?"SUCCESS":"FAIL"])),{warcall:t,victorious:S.map(m=>m.id),defeated:g.map(m=>m.id),betrayals:d,casualties:E.casualties,feedEntries:[...r,...E.feed]}}function lt(i,t,e,s,n){const r=[],o=n.find(m=>m.id===t.initiator);if(!o)return r.push(O(i,e.cycle,`S√§uberung ${t.id} scheitert ohne K√∂nig`,["PURGE","ABORTED"])),{warcall:t,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=n.filter(m=>m.id===o.id||t.hiddenRoles.some(R=>R.who===m.id&&R.role==="LOYALIST")),h=n.filter(m=>!a.includes(m));if(h.length===0)return r.push(O(i,e.cycle,`${o.name} erzwingt neue Treueschw√ºre`,["PURGE","LOYALTY"])),H(s,a,e.cycle,Math.round(t.rewards.merit/2),"Treueeid"),{warcall:t,victorious:a.map(m=>m.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const c=h.filter(m=>i.chance(.4)),l=h.filter(m=>!c.includes(m)),d=l.map(m=>m.id);if(l.length===0)return r.push(O(i,e.cycle,`${o.name} erkl√§rt ${c.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:t,victorious:a.map(m=>m.id),defeated:c.map(m=>m.id),betrayals:d,casualties:[],feedEntries:r};const u=B(a,i),y=B(l,i),p=u>=y,g=p?l:a,S=p?a:l,A=i.pick(g),E=x(s,A,e.cycle);return r.push(O(i,e.cycle,`${S[0].name} entscheidet die S√§uberung`,["PURGE",p?"SUCCESS":"REBELLION"])),{warcall:t,victorious:S.map(m=>m.id),defeated:g.map(m=>m.id),betrayals:d,casualties:E.casualties,feedEntries:[...r,...E.feed]}}function ht(i,t,e,s,n){const r=[];n.forEach(a=>s.rewardMerit(a.id,Math.round(t.rewards.merit/2),e.cycle,"Feast-Bindung"));const o=O(i,e.cycle,`${n[0].name} richtet ein heikles Festmahl in ${t.location}`,["FEAST","BOND"]);if(r.push(o),n.length>1&&i.chance(.15)){const a=i.pick(n.slice(1)),h=i.pick(n.filter(l=>l.id!==a.id)),c=x(s,h,e.cycle);return r.push(O(i,e.cycle,`${a.name} vergiftet ${h.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:t,victorious:[a.id],defeated:[h.id],betrayals:[a.id],casualties:c.casualties,feedEntries:[...r,...c.feed]}}return{warcall:t,victorious:n.map(a=>a.id),defeated:[],betrayals:[],casualties:[],feedEntries:r}}function dt(i,t,e,s){const n=ot(s,t.participants);if(n.length===0)return{warcall:t,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[O(i,e.cycle,`Warcall ${t.id} entf√§llt mangels Teilnehmer`,["EMPTY"])]};switch(t.type){case"HUNT":return ie(i,t,e,s,n,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return ie(i,t,e,s,n,26,"Monster bezwungen");case"ASSASSINATION":return at(i,t,e,s,n);case"OVERFALL":return ct(i,t,e,s,n);case"PURGE":return lt(i,t,e,s,n);case"FEAST":default:return ht(i,t,e,s,n)}}function Y(i,t){return`wc_${i.cycle}_${i.warcalls.length}_${Math.round(t.next()*1e6)}`}function ut(i){const t=i.next();return t<.5?"AGENDA":t<.8?"RANDOM":"PLAYER"}function ft(i){return i.personality.aggression>.7?"OVERFALL":i.personality.opportunism>.6?"ASSASSINATION":i.rank==="K√∂nig"?"PURGE":"FEAST"}function mt(i){return i.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function j(i,t,e,s,n){const r=t.officers.filter(l=>l.status==="ALIVE"&&l.id!==e.id),o=i.shuffle(r);if(o.length===0)return[e];const a=Math.max(1,Math.min(s,o.length)),h=i.int(1,a),c=o.slice(0,h);if(n){const l=t.officers.find(d=>d.id===t.playerId&&d.status==="ALIVE");l&&!c.some(d=>d.id===l.id)&&l.id!==e.id&&(c[c.length-1]=l)}return[e,...c]}function X(i,t,e){return t==="ASSASSINATION"?[{who:i.pick(e).id,role:"ASSASSIN"}]:t==="PURGE"?e.slice(1).map(s=>({who:s.id,role:i.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function q(i){switch(i){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienj√§ger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function yt(i,t,e){const s=ft(e),n=j(i,t,e,s==="PURGE"?5:3,!1);return{id:Y(t,i),type:s,source:"AGENDA",initiator:e.id,participants:n.map(r=>r.id),hiddenRoles:X(i,s,n),location:i.pick(G),startCycle:t.cycle,deadlineCycle:t.cycle+1,rewards:q(s),state:"ANNOUNCED"}}function pt(i,t){const e=t.officers.filter(o=>o.status==="ALIVE"),s=i.pick(e),n=mt(i),r=j(i,t,s,3,!1);return{id:Y(t,i),type:n,source:"RANDOM",initiator:s.id,participants:r.map(o=>o.id),hiddenRoles:X(i,n,r),location:i.pick(G),startCycle:t.cycle,deadlineCycle:t.cycle+1,rewards:q(n),state:"ANNOUNCED"}}function gt(i,t){const e=t.officers.find(r=>r.id===t.playerId&&r.status==="ALIVE");if(!e)return null;const s=e.rank==="Grunzer"?"HUNT":"OVERFALL",n=j(i,t,e,2,!0);return{id:Y(t,i),type:s,source:"PLAYER",initiator:e.id,participants:n.map(r=>r.id),hiddenRoles:X(i,s,n),location:i.pick(G),startCycle:t.cycle,deadlineCycle:t.cycle+1,rewards:q(s),state:"ANNOUNCED"}}function St(i,t){const e=t.warcalls.filter(o=>o.state!=="RESOLVED"),s=i.int(Ee,Te),n=Math.max(0,s-e.length),r=[];for(let o=0;o<n;o++){const a=ut(i),h=t.officers.filter(l=>l.status==="ALIVE");if(h.length<2)break;let c=null;if(a==="AGENDA"){const l=[...h].sort((d,u)=>u.personality.ambition-d.personality.ambition);c=yt(i,t,l[0])}else a==="RANDOM"?c=pt(i,t):c=gt(i,t);c&&(r.push(c),t.warcalls.push(c))}return r}function Ot(i,t,e){const s=[];for(const n of t.warcalls){if(n.state==="RESOLVED"||t.cycle<n.deadlineCycle)continue;n.state="IN_PROGRESS";const r=dt(i,n,t,e);n.state="RESOLVED",s.push(r)}return s}const w=["Grunzer","Sp√§her","Captain","Anf√ºhrer","Herausforderer","K√∂nig"];function At(i){const t=w.indexOf(i);return t===-1||t>=w.length-1?null:w[t+1]}function Et(i){const t=w.indexOf(i);return t<=0?null:w[t-1]}function z(i,t,e,s){return{id:`cycle_${t}_${Math.round(i.next()*1e9)}`,cycle:t,text:e,tags:s}}function Tt(i,t){const e=[],s=[];return t.officers=t.officers.map(n=>{if(n.status!=="ALIVE")return n;const r=be[n.rank],o=r.promoteAtMerit!==null&&n.merit>=r.promoteAtMerit?At(n.rank):null;if(o)return e.push({officerId:n.id,from:n.rank,to:o}),s.push(z(i,t.cycle,`${n.name} steigt zum ${o} auf`,["PROMOTION"])),F({...n,rank:o},{cycle:t.cycle,type:"PROMOTION",notes:`Aufstieg zu ${o}`});const a=r.demoteBelowMerit!==null&&n.merit<r.demoteBelowMerit?Et(n.rank):null;return a?(e.push({officerId:n.id,from:n.rank,to:a}),s.push(z(i,t.cycle,`${n.name} f√§llt zum ${a} zur√ºck`,["DEMOTION"])),F({...n,rank:a},{cycle:t.cycle,type:"DEMOTION",notes:`R√ºckstufung zu ${a}`})):n}),{changes:e,feed:s}}function It(i){return i.flatMap(t=>t.feedEntries)}function bt(i,t,e="DEBUG"){const s=new nt(i,t),n=s.getAlive().length;t.cycle+=1;const r=Ot(i,t,s),o=Tt(i,t),a=s.ensureRoster(t.cycle),h=St(i,t),c=[];c.push(...It(r)),c.push(...o.feed),a.forEach(u=>{c.push(z(i,t.cycle,`${u.name} tritt als Rekrut bei`,["RECRUIT"]))}),h.forEach(u=>{c.push(z(i,t.cycle,`Neuer Warcall ${u.type} bei ${u.location}`,["WARCALL","NEW"]))}),t.feed=[...t.feed,...c].slice(-60);const d=s.detectCycleTrigger(n)??e;return{cycle:t.cycle,trigger:d,newWarcalls:h,resolved:r,hierarchyChanges:o.changes,replacements:a,feed:c}}function xt(i){return Array.from({length:re},(e,s)=>s===0?$(i,{rank:"K√∂nig",titles:["K√∂nig"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):s===1?$(i,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):$(i,{}))}class se{constructor(t){f(this,"state");f(this,"rng");this.rng=new Ve(t.seed);const e=xt(this.rng),s=e[0].id,n=e[1].id;this.state={cycle:0,officers:e,warcalls:[],kingId:s,playerId:n,feed:[]}}runCycle(t="DEBUG"){return bt(this.rng,this.state,t)}}const T=_(),vt={WARCALL_COMPLETED:"Warcall abgeschlossen",FREE_ROAM_TIMEOUT:"Freies Spiel (Timeout)",OFFICER_DEATH:"Offizier gefallen",DEBUG:"Debug"};function Mt(i){const t=i.split(" ")[0]??i;return t.length>10?`${t.slice(0,9)}‚Ä¶`:t}class Lt extends T.Scene{constructor(){super("Play");f(this,"world");f(this,"officerTokens",new Map);f(this,"cycleText");f(this,"triggerText");f(this,"feedLabel");f(this,"feedText");f(this,"warcallLabel");f(this,"warcallsText");f(this,"detailLabel");f(this,"detailText");f(this,"controlsText");f(this,"boardBg");f(this,"sidebarBg");f(this,"connections");f(this,"cemeteryButton");f(this,"cemeteryButtonBg");f(this,"cemeteryLabel");f(this,"cemeteryCount");f(this,"cemeteryOverlay");f(this,"cemeteryScrim");f(this,"cemeteryOverlayBg");f(this,"cemeteryOverlayTitle");f(this,"cemeteryOverlayList");f(this,"cemeteryOverlayClose");f(this,"warcallIconBar");f(this,"warcallIconBarBg");f(this,"warcallIcons",new Map);f(this,"warcallIconMeta",new Map);f(this,"boardArea",{x:120,y:120,width:620,height:500});f(this,"sidebarArea",{x:660,y:36,width:280,height:520});f(this,"sidebarPadding",24);f(this,"highlightIds",new Set);f(this,"focusHighlightIds",new Set);f(this,"focusedWarcallId",null);f(this,"detailMode","DEFAULT");f(this,"lastSummary");f(this,"defaultDetailMessage","Fahre mit der Maus √ºber ein Portr√§t oder tippe es an.")}create(){this.world=new se({seed:Date.now()}),this.boardBg=this.add.rectangle(0,0,10,10,1054496,.92).setOrigin(0,0),this.boardBg.setStrokeStyle(2,2568767,.85),this.boardBg.setInteractive({useHandCursor:!1}),this.boardBg.on("pointerdown",()=>{this.clearWarcallSelection()}),this.sidebarBg=this.add.rectangle(0,0,10,10,857114,.92).setOrigin(0,0),this.sidebarBg.setStrokeStyle(1,2041907,.6),this.connections=this.add.graphics(),this.connections.setDepth(.5),this.cycleText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"22px",color:"#f1f2f6"}),this.triggerText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#cbd0d6"}),this.feedLabel=this.add.text(0,0,"Welt-Feed",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.feedText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.warcallLabel=this.add.text(0,0,"Aktive Warcalls",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.warcallsText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.detailLabel=this.add.text(0,0,"Details",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.detailText=this.add.text(0,0,this.defaultDetailMessage,{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:4}).setWordWrapWidth(240),this.controlsText=this.add.text(0,0,"E: Cycle simulieren   R: Welt neu generieren",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}),this.initializeWarcallIconBar(),this.initializeCemeteryUI(),this.scale.on(T.Scale.Events.RESIZE,this.configureLayout,this),this.configureLayout(),this.refreshScene(),this.input.keyboard.on("keydown-E",()=>this.advanceCycle()),this.input.keyboard.on("keydown-R",()=>this.resetWorld()),this.events.once(T.Scenes.Events.SHUTDOWN,()=>{this.officerTokens.forEach(e=>e.destroy()),this.officerTokens.clear(),this.warcallIcons.forEach(e=>e.destroy(!0)),this.warcallIcons.clear(),this.warcallIconMeta.clear(),this.scale.off(T.Scale.Events.RESIZE,this.configureLayout,this),this.boardBg.off("pointerdown")})}update(e,s){}advanceCycle(){const e=this.world.runCycle();this.refreshScene(e)}resetWorld(){this.officerTokens.forEach(e=>e.destroy()),this.officerTokens.clear(),this.warcallIcons.forEach(e=>e.destroy(!0)),this.warcallIcons.clear(),this.warcallIconMeta.clear(),this.focusHighlightIds.clear(),this.focusedWarcallId=null,this.showDefaultDetails(),this.hideCemeteryOverlay(),this.world=new se({seed:Date.now()}),this.refreshScene()}refreshScene(e){this.lastSummary=e,this.highlightIds=Ae(e),this.validateWarcallFocus(),this.cycleText.setText(`Cycle ${this.world.state.cycle}`);const s=e?this.formatTrigger(e.trigger):"Start der Kampagne";this.triggerText.setText(`Ausl√∂ser: ${s}`),this.syncOfficerTokens(e),this.refreshFeed(e),this.refreshWarcalls(e),this.drawConnections(e),this.syncWarcallIcons(e),this.updateCemeteryUI(),this.updateSidebarFlow()}formatTrigger(e){return vt[e]??e}syncOfficerTokens(e){const s=new Set(this.highlightIds);this.focusHighlightIds.forEach(l=>s.add(l));const n=this.world.state.officers.filter(l=>l.status==="ALIVE"),r=n.length,o=Q(this.boardArea,r),a=ee(r,o),h=new Set,c=!e;n.forEach((l,d)=>{const u=a[d],y=s.has(l.id);let p=this.officerTokens.get(l.id);p?(p.setPosition(u.x,u.y,{immediate:c}),p.update(l,{highlight:y})):(p=new fe({scene:this,x:u.x,y:u.y,officer:l,highlight:y,onHover:g=>this.showOfficerDetails(g),onBlur:()=>this.clearOfficerDetails()}),this.officerTokens.set(l.id,p)),h.add(l.id)}),this.officerTokens.forEach((l,d)=>{h.has(d)||(l.destroy(),this.officerTokens.delete(d))})}refreshFeed(e){const s=new Set((e==null?void 0:e.feed.map(o=>o.id))??[]),n=this.world.state.feed.slice(-6);if(n.length===0){this.feedText.setText("Keine Meldungen ‚Äì starte einen Warcall!");return}const r=n.map(o=>`${s.has(o.id)?"¬ª":"‚Ä¢"} [${o.cycle}] ${o.text}`);this.feedText.setText(r.join(`

`))}refreshWarcalls(e){const s=this.world.state.warcalls.filter(o=>o.state!=="RESOLVED");if(s.length===0){this.warcallsText.setText("Keine aktiven Warcalls.");return}const n=new Set((e==null?void 0:e.newWarcalls.map(o=>o.id))??[]),r=s.map(o=>this.describeWarcall(o,n.has(o.id)));this.warcallsText.setText(r.join(`

`))}describeWarcall(e,s){const r=this.focusedWarcallId===e.id?"‚òÖ":s?"¬ª":"‚Ä¢",o=M[e.type],a=L[e.type],h=this.collectParticipantIds(e).map(l=>this.getOfficerShortName(l)).join(", "),c=Math.round(this.computeWarcallSuccess(e)*100);return`${r} ${o} ${a} @ ${e.location}
   Erfolg: ${c}% f√ºr ${this.getOfficerShortName(e.initiator)}
   ${h}`}drawConnections(e){this.connections.clear();const s=(r,o,a,h)=>{const c=this.officerTokens.get(r.initiator);if(!c)return;const l=c.getPosition();r.participants.forEach(d=>{const u=this.officerTokens.get(d);if(!u)return;const y=u.getPosition();this.connections.lineStyle(h,o,a),this.connections.strokeLineShape(new T.Geom.Line(l.x,l.y,y.x,y.y))})};if(this.world.state.warcalls.filter(r=>r.state!=="RESOLVED").forEach(r=>s(r,5032432,.35,2)),e&&(e.newWarcalls.forEach(r=>s(r,16170336,.65,3)),e.resolved.forEach(r=>s(r.warcall,15681391,.55,3))),this.focusedWarcallId){const r=this.world.state.warcalls.find(o=>o.id===this.focusedWarcallId&&o.state!=="RESOLVED");r&&s(r,16170336,.9,4)}}configureLayout(){const e=Math.max(this.scale.gameSize.width,1),s=Math.max(this.scale.gameSize.height,1),n=Math.max(24,Math.round(Math.min(e,s)*.04));this.cycleText.setPosition(n,n),this.triggerText.setPosition(n,n+28),this.controlsText.setPosition(n,s-n-this.controlsText.height);const r=Math.max(e-n*3,0);let o=Math.min(Math.max(r*.64,0),r),a=r-o;if(r>0){const D=Math.min(Math.max(220,r*.28),r);a<D&&(a=D,o=r-a);const Z=Math.min(Math.max(320,r*.55),r);o<Z&&(o=Z,a=r-o)}const h=n+72,c=this.controlsText.y,l=Math.max(h+220,c-16);let d=Math.max(320,l-h);d>l-h&&(d=l-h);const u=n,y=Math.max(h,l-d);this.boardBg.setPosition(u,y),this.boardBg.setDisplaySize(o,d);const p=u+o+n,g=Math.max(200,s-n*2);this.sidebarBg.setPosition(p,n),this.sidebarBg.setDisplaySize(a,g);let S=Math.min(110,Math.max(72,Math.round(d*.22))),A=d-S-32;if(A<180){const D=180-A;S=Math.max(60,S-D),A=d-S-32}A<160&&(A=Math.max(140,Math.round(d*.65)),S=Math.max(60,d-A-20));const E=y+d-S;this.warcallIconBar.setPosition(u,E),this.warcallIconBarBg.setDisplaySize(o,S),this.layoutWarcallIcons(),this.boardArea={x:u,y,width:o,height:Math.max(160,A)},this.sidebarArea={x:p,y:n,width:a,height:g},this.sidebarPadding=Math.max(20,Math.round(a*.08));const m=this.cemeteryButtonBg.displayWidth,R=this.cemeteryButtonBg.displayHeight;let V=y-R-12;V<n&&(V=y+12);const ae=u+o-m-16;this.cemeteryButton.setPosition(ae,V),this.cemeteryScrim.setDisplaySize(e,s);const C=Math.min(Math.max(320,o*.7),Math.max(320,e-n*2)),k=Math.min(Math.max(280,d*.8),Math.max(260,s-n*2));this.cemeteryOverlayBg.setDisplaySize(C,k),this.cemeteryOverlayBg.setPosition(e/2,s/2),this.cemeteryOverlayTitle.setPosition(e/2,s/2-k/2+24),this.cemeteryOverlayList.setPosition(e/2-C/2+24,this.cemeteryOverlayTitle.y+this.cemeteryOverlayTitle.height+12),this.cemeteryOverlayList.setWordWrapWidth(C-48),this.cemeteryOverlayList.setFixedSize(C-48,k-120),this.cemeteryOverlayClose.setPosition(e/2,s/2+k/2-28),this.reflowOfficerPositions(),this.drawConnections(),this.updateSidebarFlow(),this.layoutWarcallIcons()}reflowOfficerPositions(){if(!this.world||this.officerTokens.size===0)return;const e=this.world.state.officers.filter(o=>o.status==="ALIVE"),s=e.length,n=Q(this.boardArea,s),r=ee(s,n);e.forEach((o,a)=>{const h=this.officerTokens.get(o.id);h&&h.setPosition(r[a].x,r[a].y,{immediate:!0})})}updateSidebarFlow(){if(this.sidebarArea.width<=0||this.sidebarArea.height<=0)return;const e=this.sidebarArea.x+this.sidebarPadding,s=this.sidebarArea.y+this.sidebarPadding,n=Math.max(160,this.sidebarArea.width-this.sidebarPadding*2);this.feedLabel.setPosition(e,s),this.feedText.setPosition(e,this.feedLabel.y+this.feedLabel.height+6),this.feedText.setWordWrapWidth(n);let o=this.feedText.getBounds().bottom+24;this.warcallLabel.setPosition(e,o),this.warcallsText.setPosition(e,this.warcallLabel.y+this.warcallLabel.height+6),this.warcallsText.setWordWrapWidth(n),o=this.warcallsText.getBounds().bottom+24;const h=this.sidebarArea.y+this.sidebarArea.height-this.sidebarPadding;o+this.detailLabel.height+6>h&&(o=Math.max(s,h-(this.detailLabel.height+6))),this.detailLabel.setPosition(e,o);const c=this.detailLabel.y+this.detailLabel.height+6;this.detailText.setPosition(e,c);const l=Math.max(0,h-c);this.detailText.setWordWrapWidth(n),this.detailText.setFixedSize(n,l)}showOfficerDetails(e){this.detailMode="OFFICER",this.detailLabel.setText("Details ‚Äì Offizier");const s=e.traits.length>0?e.traits.join(", "):"Keine bekannten Traits",n=e.relationships.bloodOathWith?this.getOfficerShortName(e.relationships.bloodOathWith):"Kein",r=e.relationships.loyalToKing?"Ja":"Nein",o=this.formatOfficerNames(e.relationships.friends),a=this.formatOfficerNames(e.relationships.rivals),h=this.world.state.warcalls.filter(y=>y.state!=="RESOLVED"),c=Oe(e,h,y=>this.getOfficerById(y)),l=c.warcallId?this.world.state.warcalls.find(y=>y.id===c.warcallId):void 0,d=l?`${M[l.type]} `:"",u=[`${e.name} (${e.rank}, Lv ${e.level})`,`Clan ${e.clan} ‚Ä¢ Merit gesamt ${Math.round(e.merit)}`,`Traits: ${s}`,`Verb√ºndete: ${o}`,`Rivalen: ${a}`,`Blutschwur: ${n}`,`Loyal zum K√∂nig: ${r}`,`Aktivit√§t: ${d}${c.summary}`];this.detailText.setText(u.join(`
`))}clearOfficerDetails(){this.detailMode==="OFFICER"&&this.showDefaultDetails()}showDefaultDetails(){this.detailMode="DEFAULT",this.detailLabel.setText("Details"),this.detailText.setText(this.defaultDetailMessage)}getOfficerById(e){return this.world.state.officers.find(s=>s.id===e)}formatOfficerNames(e){return e.length===0?"Keine":e.map(s=>this.getOfficerShortName(s)).join(", ")}computeWarcallSuccess(e){const s=Ge(this.world.state,e);return Number.isFinite(s)?Math.min(1,Math.max(0,s)):0}initializeWarcallIconBar(){this.warcallIconBar=this.add.container(0,0),this.warcallIconBar.setDepth(1.2),this.warcallIconBarBg=this.add.rectangle(0,0,120,80,725272,.88).setOrigin(0,0),this.warcallIconBarBg.setStrokeStyle(1,2041907,.6),this.warcallIconBarBg.setInteractive({useHandCursor:!1}),this.warcallIconBarBg.on("pointerdown",e=>{var s;(s=e.event)==null||s.stopPropagation(),this.clearWarcallSelection()}),this.warcallIconBar.add(this.warcallIconBarBg)}initializeCemeteryUI(){this.cemeteryButton=this.add.container(0,0),this.cemeteryButtonBg=this.add.rectangle(0,0,160,36,1318955,.9).setOrigin(0,0),this.cemeteryButtonBg.setStrokeStyle(1,2568767,.9),this.cemeteryLabel=this.add.text(14,36/2,"Friedhof",{fontFamily:"monospace",fontSize:"13px",color:"#f1f2f6"}).setOrigin(0,.5),this.cemeteryCount=this.add.text(144,36/2,"(0)",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6"}).setOrigin(1,.5),this.cemeteryButton.add([this.cemeteryButtonBg,this.cemeteryLabel,this.cemeteryCount]),this.cemeteryButton.setDepth(1.4),this.cemeteryButton.setSize(160,36),this.cemeteryButton.setInteractive(new T.Geom.Rectangle(0,0,160,36),T.Geom.Rectangle.Contains),this.cemeteryButton.on("pointerover",()=>{this.input.setDefaultCursor("pointer"),this.cemeteryButtonBg.setStrokeStyle(1,16170336,.9)}),this.cemeteryButton.on("pointerout",()=>{this.input.setDefaultCursor("default"),this.cemeteryButtonBg.setStrokeStyle(1,2568767,.9)}),this.cemeteryButton.on("pointerdown",()=>{this.toggleCemeteryOverlay()}),this.cemeteryOverlay=this.add.container(0,0),this.cemeteryScrim=this.add.rectangle(0,0,10,10,330513,.6).setOrigin(0,0),this.cemeteryScrim.setInteractive({useHandCursor:!1}),this.cemeteryScrim.on("pointerdown",()=>this.hideCemeteryOverlay()),this.cemeteryOverlayBg=this.add.rectangle(0,0,360,420,857114,.95).setOrigin(.5),this.cemeteryOverlayBg.setStrokeStyle(1,2041907,.8),this.cemeteryOverlayBg.setInteractive({useHandCursor:!1}),this.cemeteryOverlayBg.on("pointerdown",n=>{var r;return(r=n.event)==null?void 0:r.stopPropagation()}),this.cemeteryOverlayTitle=this.add.text(0,0,"Friedhof",{fontFamily:"monospace",fontSize:"18px",color:"#f1f2f6"}).setOrigin(.5,0),this.cemeteryOverlayList=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setOrigin(0,0),this.cemeteryOverlayList.setWordWrapWidth(320),this.cemeteryOverlayClose=this.add.text(0,0,"Schlie√üen",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}).setOrigin(.5,.5),this.cemeteryOverlayClose.setInteractive({useHandCursor:!0}),this.cemeteryOverlayClose.on("pointerdown",()=>this.hideCemeteryOverlay()),this.cemeteryOverlay.add([this.cemeteryScrim,this.cemeteryOverlayBg,this.cemeteryOverlayTitle,this.cemeteryOverlayList,this.cemeteryOverlayClose]),this.cemeteryOverlay.setDepth(10),this.cemeteryOverlay.setVisible(!1)}updateCemeteryUI(){const e=this.world.state.officers.filter(s=>s.status!=="ALIVE");this.cemeteryCount.setText(`(${e.length})`),this.cemeteryButton.setAlpha(e.length>0?1:.6),this.updateCemeteryOverlayList(e)}updateCemeteryOverlayList(e){if(e.length===0){this.cemeteryOverlayList.setText("Noch keine Gefallenen.");return}const s=e.map(n=>{const r=n.status==="MISSING"?"Vermisst":"Gefallen";return`‚Ä¢ ${n.name} (${n.rank}, Lv ${n.level}) ‚Äì ${r}`});this.cemeteryOverlayList.setText(s.join(`

`))}showCemeteryOverlay(){this.updateCemeteryOverlayList(this.world.state.officers.filter(e=>e.status!=="ALIVE")),this.cemeteryOverlay.setVisible(!0)}hideCemeteryOverlay(){this.cemeteryOverlay&&this.cemeteryOverlay.setVisible(!1)}toggleCemeteryOverlay(){this.cemeteryOverlay&&(this.cemeteryOverlay.visible?this.hideCemeteryOverlay():this.showCemeteryOverlay())}layoutWarcallIcons(){if(!this.warcallIconBarBg)return;const e=this.warcallIcons.size;if(e===0){this.warcallIconBar.setVisible(!1);return}this.warcallIconBar.setVisible(!0);const s=this.warcallIconBarBg.displayWidth,n=this.warcallIconBarBg.displayHeight,r=72,o=e>1?Math.max(14,Math.min(36,(s-r*e)/(e-1))):0,a=e*r+Math.max(0,e-1)*o,h=Math.max(0,(s-a)/2);let c=0;this.warcallIcons.forEach(l=>{const d=h+r/2+c*(r+o),u=n/2;l.setPosition(d,u),c+=1})}applyWarcallIconVisuals(e){const s=this.warcallIcons.get(e),n=this.warcallIconMeta.get(e);if(!s||!n)return;const r=s.getData("hover")===!0,o=s.getData("highlight")===!0,a=s.getData("selected")===!0,h=r||a?16170336:o?5032432:2306881,c=r||a?1:o?.9:.7,l=r||a?3:2;n.bg.setStrokeStyle(l,h,c),s.setScale(r||a?1.08:1)}createWarcallIcon(e){const s=this.add.container(0,0);s.setSize(76,76),s.setDepth(1.3);const n=this.add.rectangle(0,0,68,68,1318955,.92).setOrigin(.5),r=this.add.text(0,-10,M[e.type],{fontFamily:"monospace",fontSize:"28px",color:"#f7f9fc"}).setOrigin(.5),o=this.add.text(0,14,L[e.type],{fontFamily:"monospace",fontSize:"10px",color:"#d1d9e6"}).setOrigin(.5,0),a=this.add.text(0,30,"",{fontFamily:"monospace",fontSize:"10px",color:"#a9b7c6"}).setOrigin(.5,0);return s.add([n,r,o,a]),s.setDataEnabled(),s.setData({hover:!1,highlight:!1,selected:!1,warcallId:e.id}),s.setInteractive(new T.Geom.Circle(0,0,36),T.Geom.Circle.Contains),s.on("pointerover",()=>{s.setData("hover",!0),this.applyWarcallIconVisuals(e.id),this.input.setDefaultCursor("pointer")}),s.on("pointerout",()=>{s.setData("hover",!1),this.applyWarcallIconVisuals(e.id),this.input.setDefaultCursor("default")}),s.on("pointerdown",()=>{const h=s.getData("warcallId"),c=this.world.state.warcalls.find(l=>l.id===h&&l.state!=="RESOLVED");c&&this.showWarcallDetails(c)}),this.warcallIconMeta.set(e.id,{bg:n,icon:r,label:o,chance:a}),s}updateWarcallIcon(e,s){const n=this.warcallIcons.get(e.id),r=this.warcallIconMeta.get(e.id);!n||!r||(n.setData("warcallId",e.id),n.setData("highlight",s),n.setData("selected",this.focusedWarcallId===e.id),r.icon.setText(M[e.type]),r.label.setText(L[e.type]),r.chance.setText(`${Math.round(this.computeWarcallSuccess(e)*100)}%`),this.applyWarcallIconVisuals(e.id))}syncWarcallIcons(e){const s=this.world.state.warcalls.filter(o=>o.state!=="RESOLVED"),n=new Set((e==null?void 0:e.newWarcalls.map(o=>o.id))??[]),r=new Set;s.forEach(o=>{let a=this.warcallIcons.get(o.id);a||(a=this.createWarcallIcon(o),this.warcallIcons.set(o.id,a),this.warcallIconBar.add(a)),this.updateWarcallIcon(o,n.has(o.id)),r.add(o.id)}),this.warcallIcons.forEach((o,a)=>{r.has(a)||(o.destroy(!0),this.warcallIcons.delete(a),this.warcallIconMeta.delete(a))}),this.layoutWarcallIcons()}focusWarcall(e){this.focusedWarcallId=e.id,this.focusHighlightIds=new Set,this.collectParticipantIds(e).forEach(s=>this.focusHighlightIds.add(s)),e.hiddenRoles.forEach(s=>this.focusHighlightIds.add(s.who))}clearWarcallSelection(){if(!this.focusedWarcallId){this.detailMode==="WARCALL"&&this.showDefaultDetails();return}this.focusedWarcallId=null,this.focusHighlightIds.clear(),this.detailMode==="WARCALL"&&this.showDefaultDetails(),this.syncOfficerTokens(this.lastSummary),this.syncWarcallIcons(this.lastSummary),this.refreshWarcalls(this.lastSummary),this.drawConnections(this.lastSummary)}showWarcallDetails(e){this.detailMode="WARCALL",this.detailLabel.setText("Details ‚Äì Warcall"),this.focusWarcall(e);const s=M[e.type],n=L[e.type],r=me[e.type],o=Math.round(this.computeWarcallSuccess(e)*100),a=this.getOfficerById(e.initiator),h=a?a.name:this.getOfficerShortName(e.initiator),c=this.collectParticipantIds(e),l=c.map(g=>{const S=this.getOfficerById(g),A=S?S.name:this.getOfficerShortName(g),E=S?ne(e,S,a):g===e.initiator?"Ausrufer":"Teilnehmer";return`‚Ä¢ ${A} ‚Äì ${E}`}),d=e.hiddenRoles.filter(g=>!c.includes(g.who)),u=d.length>0?[`Verdeckte Beteiligte: ${d.map(g=>`${this.getOfficerShortName(g.who)} ‚Äì ${g.role}`).join(", ")}`]:[],y=e.rewards.titles.length>0?`Titel: ${e.rewards.titles.join(", ")}`:void 0,p=[`${s} ${n} @ ${e.location}`,`Initiator: ${h}`,`Ziel: ${r}`,`Belohnung: ${e.rewards.merit} Merit ‚Ä¢ ${e.rewards.xp} XP`];y&&p.push(y),p.push(`Erfolgschance f√ºr ${this.getOfficerShortName(e.initiator)}: ${o}%`),p.push("","Beteiligte:"),p.push(...l),u.length>0&&p.push("",...u),this.detailText.setText(p.join(`
`)),this.syncOfficerTokens(this.lastSummary),this.syncWarcallIcons(this.lastSummary),this.refreshWarcalls(this.lastSummary),this.drawConnections(this.lastSummary)}validateWarcallFocus(){if(!this.focusedWarcallId)return;this.world.state.warcalls.some(s=>s.id===this.focusedWarcallId&&s.state!=="RESOLVED")||(this.focusedWarcallId=null,this.focusHighlightIds.clear(),this.detailMode==="WARCALL"&&this.showDefaultDetails())}collectParticipantIds(e){const s=e.participants.includes(e.initiator)?e.participants:[e.initiator,...e.participants];return Array.from(new Set(s))}getOfficerShortName(e){const s=this.world.state.officers.find(r=>r.id===e);if(!s)return e.slice(0,6);const n=Mt(s.name);return s.rank==="K√∂nig"?`üëë ${n}`:n}}const P=_();class wt extends P.Game{constructor(t){const e={type:P.AUTO,parent:t,backgroundColor:"#0b0d10",width:window.innerWidth,height:window.innerHeight,pixelArt:!0,scale:{mode:P.Scale.RESIZE,autoCenter:P.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[de,Lt]};super(e)}}new wt(document.getElementById("app"));
