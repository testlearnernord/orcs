var we=Object.defineProperty;var Pe=(t,i,e)=>i in t?we(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e;var f=(t,i,e)=>Pe(t,typeof i!="symbol"?i+"":i,e);(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function Y(){const t=globalThis.Phaser;if(!t)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return t}const Ne=Y();class Be extends Ne.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}const A=Y(),le={Grunzer:4942970,Sp√§her:5018988,Captain:16765286,Anf√ºhrer:15681391,Herausforderer:10258872,K√∂nig:1149618},De={leader:16170336,ally:9485933,support:5032432,rival:15681391,hidden:16739179,blood:5731728},X={ACTIVITY:"#d1d9e6",RELATIONSHIPS:"#c5f6fa",WARCALLS:"#fdfcdc",PERSONALITY:"#ffe0b2",LOYALTY:"#d0f4de"},D={ACTIVITY:725272,RELATIONSHIPS:995130,WARCALLS:3152703,PERSONALITY:3809042,LOYALTY:1913632},L=60,ae=18,I=112,q=54,R=46,ce=18;function de(t){const e=t.split(" ")[0]??t;return e.length>14?`${e.slice(0,13)}‚Ä¶`:e}class We{constructor(i){f(this,"scene");f(this,"container");f(this,"body");f(this,"focusRing");f(this,"frame");f(this,"portrait");f(this,"labelBg");f(this,"nameText");f(this,"detailText");f(this,"badgeBg");f(this,"badgeText");f(this,"cross");f(this,"hover");f(this,"blur");f(this,"click");f(this,"currentOfficer");f(this,"currentScale",1);f(this,"currentMode","ACTIVITY");f(this,"currentBadgeColor",D.ACTIVITY);f(this,"currentPortraitKey");f(this,"highlightTween");f(this,"crossVisible",!1);this.scene=i.scene,this.hover=i.onHover,this.blur=i.onBlur,this.click=i.onClick,this.currentOfficer=i.officer,this.currentPortraitKey=i.portraitKey,this.container=this.scene.add.container(i.x,i.y),this.container.setSize(140,160),this.container.setDepth(1);const e=new A.Geom.Circle(0,0,60);this.container.setInteractive(e,A.Geom.Circle.Contains),this.body=this.scene.add.container(0,0),this.focusRing=this.scene.add.circle(0,0,66,16777215,0),this.focusRing.setStrokeStyle(0,16777215,0),this.frame=this.scene.add.circle(0,0,56,le[i.officer.rank]??2568767,1),this.frame.setStrokeStyle(3,725272,.8),this.portrait=this.scene.add.image(0,0,i.portraitKey),this.portrait.setDisplaySize(96,96),this.portrait.setMask(this.frame.createBitmapMask()),this.labelBg=this.scene.add.rectangle(0,L,I,q,725272,.88),this.labelBg.setOrigin(.5,0),this.labelBg.setStrokeStyle(1,1845041,.6),this.nameText=this.scene.add.text(0,L+6,de(i.officer.name),{fontFamily:"monospace",fontSize:"16px",color:"#f7f9fc",align:"center"}).setOrigin(.5,0).setWordWrapWidth(I-12),this.detailText=this.scene.add.text(0,L+6+ae,"",{fontFamily:"monospace",fontSize:"12px",color:X.ACTIVITY,align:"center"}).setOrigin(.5,0).setWordWrapWidth(I-12),this.badgeBg=this.scene.add.circle(R,-R,ce,D.ACTIVITY,.95),this.badgeBg.setStrokeStyle(2,16777215,.35),this.badgeBg.setVisible(!1),this.badgeText=this.scene.add.text(R,-R,"",{fontFamily:"monospace",fontSize:"16px",color:"#f7f9fc"}).setOrigin(.5,.5),this.badgeText.setVisible(!1),this.cross=this.scene.add.graphics(),this.cross.setVisible(!1),this.cross.setAlpha(0),this.drawCross(),this.body.add([this.focusRing,this.frame,this.portrait,this.cross]),this.container.add([this.body,this.labelBg,this.nameText,this.detailText,this.badgeBg,this.badgeText]),this.container.on("pointerover",()=>{this.container.setDepth(3),this.scene.input.setDefaultCursor("pointer"),this.hover&&this.hover(this.currentOfficer)}),this.container.on("pointerout",()=>{this.container.setDepth(1),this.scene.input.setDefaultCursor("default"),this.blur&&this.blur()}),this.container.on("pointerdown",s=>{this.click&&this.click(this.currentOfficer,s)}),this.applyScale(i.scale??1),this.applyHighlight(i.highlight??!1)}update(i,e={}){this.currentOfficer=i,this.nameText.setText(de(i.name));const s=le[i.rank]??2568767;this.frame.fillColor=s,e.portraitKey&&e.portraitKey!==this.currentPortraitKey&&(this.currentPortraitKey=e.portraitKey,this.portrait.setTexture(e.portraitKey),this.portrait.setDisplaySize(96,96)),e.scale!==void 0&&this.applyScale(e.scale),this.applyHighlight(e.highlight??!1),this.applyFocus(e.focus??null),e.mode&&(this.currentMode=e.mode,this.detailText.setColor(X[e.mode]),this.badgeBg.fillColor=D[e.mode],this.currentBadgeColor=D[e.mode]),e.detailText!==void 0&&this.setDetail(e.detailText,e.detailAccent),e.badgeText!==void 0&&this.setBadge(e.badgeText,e.badgeColor),e.dimmed!==void 0&&this.setDimmed(e.dimmed),e.crossed!==void 0&&this.setCrossed(e.crossed)}setDetail(i,e){if(this.detailText.setText(i),e!==void 0){const s=A.Display.Color.IntegerToColor(e).rgba;this.detailText.setColor(s)}else this.detailText.setColor(X[this.currentMode])}setBadge(i,e){if(!i){this.badgeBg.setVisible(!1),this.badgeText.setVisible(!1);return}this.badgeBg.setVisible(!0),this.badgeText.setVisible(!0),this.badgeText.setText(i);const s=e??this.currentBadgeColor;this.badgeBg.fillColor=s}setDimmed(i){this.container.setAlpha(i?.55:1)}setCrossed(i){i!==this.crossVisible&&(this.crossVisible=i,i?(this.cross.setVisible(!0),this.cross.setAlpha(0),this.scene.tweens.add({targets:this.cross,alpha:1,duration:300,ease:A.Math.Easing.Cubic.Out}),this.scene.tweens.add({targets:this.portrait,alpha:.2,duration:300,ease:A.Math.Easing.Quadratic.InOut})):(this.scene.tweens.add({targets:this.cross,alpha:0,duration:200,ease:A.Math.Easing.Cubic.In,onComplete:()=>this.cross.setVisible(!1)}),this.scene.tweens.add({targets:this.portrait,alpha:1,duration:200,ease:A.Math.Easing.Quadratic.Out})))}flash(i,e=450){const s=this.frame.fillColor;this.frame.setFillStyle(i,1),this.scene.tweens.add({targets:this.frame,duration:e,ease:A.Math.Easing.Sine.InOut,onComplete:()=>{this.frame.setFillStyle(s,1)}})}markFallen(){this.setCrossed(!0),this.scene.tweens.add({targets:this.body,angle:{from:-6,to:6},duration:280,yoyo:!0,repeat:2,ease:A.Math.Easing.Sine.InOut,onComplete:()=>{this.body.setAngle(0)}})}setPosition(i,e,s={}){if(s.immediate){this.container.setPosition(i,e);return}this.scene.tweens.add({targets:this.container,x:i,y:e,duration:450,ease:A.Math.Easing.Cubic.Out})}getPosition(){return new A.Math.Vector2(this.container.x,this.container.y)}setDepth(i){this.container.setDepth(i)}destroy(){var i;(i=this.highlightTween)==null||i.stop(),this.container.destroy(!0)}applyScale(i){const e=A.Math.Clamp(i,.6,1.25);if(Math.abs(e-this.currentScale)<.01)return;this.currentScale=e,this.body.setScale(e),this.labelBg.setScale(e);const s=Math.max(12,Math.round(16*e)),n=Math.max(10,Math.round(12*e)),r=Math.max(68,Math.round((I-12)*e)),o=L*e+6*e,l=o+ae*e;this.labelBg.setPosition(0,L*e),this.labelBg.setSize(I*e,q*e),this.labelBg.displayWidth=I*e,this.labelBg.displayHeight=q*e,this.nameText.setFontSize(s),this.nameText.setY(o),this.nameText.setWordWrapWidth(r),this.detailText.setFontSize(n),this.detailText.setY(l),this.detailText.setWordWrapWidth(r);const d=R*e;this.badgeBg.setPosition(d,-d),this.badgeBg.setRadius(ce*e),this.badgeText.setPosition(d,-d),this.badgeText.setFontSize(Math.max(12,Math.round(16*e)))}applyHighlight(i){var e;(e=this.highlightTween)==null||e.stop(),this.highlightTween=void 0,this.body.setScale(this.currentScale),i&&(this.highlightTween=this.scene.tweens.add({targets:this.body,scale:this.currentScale*1.06,duration:420,ease:A.Math.Easing.Sine.InOut,yoyo:!0,repeat:-1}))}applyFocus(i){if(!i){this.focusRing.setStrokeStyle(0,16777215,0);return}const e=De[i];this.focusRing.setStrokeStyle(4,e,.9)}drawCross(){this.cross.clear(),this.cross.lineStyle(6,16739179,.9),this.cross.beginPath(),this.cross.moveTo(-44,-44),this.cross.lineTo(44,44),this.cross.moveTo(44,-44),this.cross.lineTo(-44,44),this.cross.strokePath()}}const Q={FEAST:"üçñ",OVERFALL:"‚öîÔ∏è",ASSASSINATION:"üó°Ô∏è",HUNT:"üèπ",MONSTER_HUNT:"üêâ",PURGE:"üî•"},Z={FEAST:"Festmahl",OVERFALL:"√úberfall",ASSASSINATION:"Attentat",HUNT:"Jagd",MONSTER_HUNT:"Monsterjagd",PURGE:"S√§uberung"};function Ve(t,i){return t?t.relationships.friends.includes(i.id)||i.relationships.friends.includes(t.id):!1}function $e(t,i){return t?t.relationships.rivals.includes(i.id)||i.relationships.rivals.includes(t.id):!1}function ve(t,i,e){if(t.initiator===i.id)return"Ausrufer";const s=t.hiddenRoles.find(n=>n.who===i.id);if(s)switch(s.role){case"ASSASSIN":return"Assassine";case"TRAITOR":return"Rivale (verdeckt)";case"LOYALIST":return"Loyalist"}return $e(e,i)?"Rivale":Ve(e,i)?"Verb√ºndeter":"Supporter"}function Fe(t,i,e){return`${Z[t]} @ ${i} (${e})`}function He(t,i){return i.state==="RESOLVED"?!1:i.initiator===t.id?!0:i.participants.includes(t.id)}function he(t,i,e){const s=i.find(o=>He(t,o));if(!s)return{summary:"Freies Spiel"};const n=e(s.initiator),r=ve(s,t,n);return{summary:Fe(s.type,s.location,r),warcallId:s.id,role:r}}function _e(t){const i=new Set;return t&&(t.newWarcalls.forEach(e=>{i.add(e.initiator),e.participants.forEach(s=>i.add(s)),e.hiddenRoles.forEach(s=>i.add(s.who))}),t.resolved.forEach(e=>{const{warcall:s}=e;i.add(s.initiator),s.participants.forEach(n=>i.add(n)),e.victorious.forEach(n=>i.add(n)),e.defeated.forEach(n=>i.add(n)),e.casualties.forEach(n=>i.add(n.officerId))}),t.replacements.forEach(e=>i.add(e.id))),i}const ze=[{key:"royal",label:"Herrschaft",ranks:["K√∂nig","Herausforderer"],layout:"royal",yRatio:.14},{key:"captains",label:"Captains",ranks:["Anf√ºhrer","Captain"],layout:"row",yRatio:.38},{key:"scouts",label:"Sp√§her",ranks:["Sp√§her"],layout:"row",yRatio:.62},{key:"grunts",label:"Grunzer",ranks:["Grunzer"],layout:"row",yRatio:.85}],$=120,xe=220,H=64;function _(t,i,e){return Math.min(Math.max(t,i),e)}function ue(t,i,e,s){const n=t.length;if(n===0)return;if(n===1){s.set(t[0].id,{x:e.x+e.width/2,y:i});return}const r=Math.min(e.width*.86,Math.max(n*$,$*2)),o=_(r/Math.max(1,n-1),$,xe),l=o*(n-1),d=e.x+e.width/2-l/2,a=e.x+H,c=e.x+e.width-H;t.forEach((h,u)=>{const m=d+o*u,T=_(m,a,c);s.set(h.id,{x:T,y:i})})}function Ge(t,i,e,s,n){if(t.length===0)return;const r=s.x+s.width/2,o=t.find(a=>a.id===i)??t[0],l=t.filter(a=>a.id!==o.id);if(n.set(o.id,{x:r,y:e}),l.length===0)return;const d=Math.max($*.9,Math.min(xe,s.width/Math.max(3,l.length+1)));l.slice().sort((a,c)=>c.merit-a.merit||a.name.localeCompare(c.name)).forEach((a,c)=>{const h=c%2===0?-1:1,u=Math.floor(c/2)+1,m=h*d*u,T=_(r+m,s.x+H,s.x+s.width-H),g=c%2===0?-12:12;n.set(a.id,{x:T,y:e+g})})}function Ue(t,i,e){const s=new Map,n=new Set,r=Math.max(e.height,1),o=ze.map(c=>({key:c.key,label:c.label,layout:c.layout,ratio:c.yRatio,officers:t.filter(h=>c.ranks.includes(h.rank))}));o.forEach(c=>{const h=e.y+r*c.ratio,u=c.officers.filter(m=>!n.has(m.id)).sort((m,T)=>T.merit-m.merit||m.level-T.level||m.name.localeCompare(T.name));c.layout==="royal"?u.length>0&&(Ge(u,i,h,e,s),u.forEach(m=>n.add(m.id))):(ue(u,h,e,s),u.forEach(m=>n.add(m.id))),c.officers=u});const l=t.filter(c=>!n.has(c.id));if(l.length>0){const c=_(.92-Math.min(.15,l.length*.01),.72,.94),h="Au√üenseiter",u=e.y+r*c;ue(l,u,e,s),o.push({key:"outsiders",label:h,layout:"row",ratio:c,officers:l.slice()})}const d=o.filter(c=>c.officers.length>0);d.sort((c,h)=>c.ratio-h.ratio);const a=d.map((c,h)=>{const u=e.y+r*c.ratio,m=h===0?e.y:e.y+r*d[h-1].ratio,T=h===d.length-1?e.y+e.height:e.y+r*d[h+1].ratio,g=h===0?e.y:(m+u)/2,O=h===d.length-1?e.y+e.height:(u+T)/2;return{key:c.key,label:c.label,y:u,top:g,bottom:O,officers:c.officers}});return{positions:s,levels:a}}const y=96,fe=40,te=40,Ye=[1515819,2042419,2825517,1847085,3352095,2237749,2760499,1912379],Ke=[5072707,5201718,5663817,6123584,6322767],ye=[3755818,4611382,4346931,3623466],me=[16183765,15589588,14870234,15856619,16249054],pe=[4014171,5731728,11887990,28023,16758531,14034984],Te=[15919588,15129810,14273203,13350815],Se=[{kind:"SCAR",color:16739179},{kind:"SCAR",color:15893634},{kind:"PAINT",color:4756975},{kind:"PAINT",color:2792847},{kind:"TATTOO",color:16234497},{kind:"PIERCING",color:15330543},{kind:"HAIR",color:4869737},{kind:"HELM",color:7107965},{kind:"BRAND",color:13073919},{kind:"MASK",color:197726}],ge=["NONE","SMALL","LARGE"],Ae=["DEFAULT","ANGLED","HEAVY","CURVED"];function b(t,i,e){const s=(t>>16&255)*(1-e)+(i>>16&255)*e,n=(t>>8&255)*(1-e)+(i>>8&255)*e,r=(t&255)*(1-e)+(i&255)*e;return Math.max(0,Math.min(255,Math.round(s)))<<16|Math.max(0,Math.min(255,Math.round(n)))<<8|Math.max(0,Math.min(255,Math.round(r)))}function je(){const t=[];let i=0;for(const e of Ke)for(const s of Ye){const n=Se[i%Se.length],r=ge[i%ge.length],o=Ae[i%Ae.length],l=me[i%me.length],d=pe[i%pe.length],a=ye[i%ye.length],c=Te[i%Te.length];t.push({background:s,skin:e,jaw:a,eyes:l,iris:d,tusk:c,adornment:n,hornStyle:r,browStyle:o}),i+=1}return t.slice(0,te)}const Xe=je();function qe(t,i){const e=b(i.skin,16710368,.35);t.fillStyle(e,1),(i.hornStyle==="SMALL"||i.hornStyle==="LARGE")&&(t.fillTriangle(48,10,38,26,56,26),t.fillTriangle(y-48,10,y-56,26,y-38,26),i.hornStyle==="LARGE"&&(t.fillTriangle(60,6,50,20,66,24),t.fillTriangle(y-60,6,y-66,24,y-50,20)),t.lineStyle(2,b(e,1776931,.55),.9),t.strokeTriangle(48,10,38,26,56,26),t.strokeTriangle(y-48,10,y-56,26,y-38,26))}function Qe(t,i){switch(t.lineStyle(4,b(i.skin,1184274,.6),.8),i.browStyle){case"ANGLED":t.beginPath(),t.moveTo(36,38),t.lineTo(46,34),t.lineTo(56,38),t.strokePath(),t.beginPath(),t.moveTo(y-36,38),t.lineTo(y-46,34),t.lineTo(y-56,38),t.strokePath();break;case"HEAVY":t.fillStyle(b(i.skin,197379,.75),.9),t.fillRoundedRect(32,34,32,8,4),t.fillRoundedRect(y-64,34,32,8,4);break;case"CURVED":t.lineStyle(3,b(i.skin,723723,.7),.8),t.strokePoints([{x:34,y:38},{x:46,y:32},{x:58,y:38}],!1,!0),t.strokePoints([{x:y-34,y:38},{x:y-46,y:32},{x:y-58,y:38}],!1,!0);break;default:t.lineStyle(3,b(i.skin,1579032,.6),.8),t.beginPath(),t.moveTo(34,38),t.lineTo(56,38),t.strokePath(),t.beginPath(),t.moveTo(y-34,38),t.lineTo(y-56,38),t.strokePath();break}}function Ze(t,i){t.fillStyle(i.eyes,1),t.fillEllipse(42,48,18,12),t.fillEllipse(y-42,48,18,12),t.fillStyle(i.iris,1),t.fillCircle(42,48,5),t.fillCircle(y-42,48,5),t.fillStyle(0,.85),t.fillCircle(42,48,2.6),t.fillCircle(y-42,48,2.6)}function Je(t,i){t.fillStyle(i.tusk,1),t.fillEllipse(38,68,14,18),t.fillEllipse(y-38,68,14,18),t.fillStyle(b(i.tusk,1118481,.4),.9),t.fillEllipse(36,68,8,10),t.fillEllipse(y-36,68,8,10)}function et(t,i){const e=b(i.skin,592137,.7);t.lineStyle(3,e,.9),t.strokePoints([{x:42,y:76},{x:y/2,y:82},{x:y-42,y:76}],!1,!0),t.lineStyle(2,b(e,16777215,.2),.6),t.strokePoints([{x:42,y:70},{x:y/2,y:74},{x:y-42,y:70}],!1,!0)}function tt(t,i){const{adornment:e}=i;switch(e.kind){case"SCAR":{t.lineStyle(3,e.color,.9),t.beginPath(),t.moveTo(34,28),t.lineTo(y-28,y-30),t.strokePath(),t.lineStyle(1,16777215,.6),t.beginPath(),t.moveTo(36,30),t.lineTo(y-30,y-32),t.strokePath();break}case"PAINT":{t.fillStyle(e.color,.75),t.fillRect(28,40,y-56,14),t.fillTriangle(28,54,40,78,52,54),t.fillTriangle(y-28,54,y-40,78,y-52,54);break}case"TATTOO":{t.lineStyle(3,e.color,.85),t.beginPath(),t.moveTo(y/2,18),t.lineTo(y/2-12,34),t.lineTo(y/2+12,34),t.closePath(),t.strokePath(),t.strokeCircle(y/2,52,10);break}case"PIERCING":{t.lineStyle(2,e.color,.9),t.strokeCircle(y/2,84,6),t.fillStyle(e.color,.9),t.fillCircle(y/2-8,84,3),t.fillCircle(y/2+8,84,3);break}case"HAIR":{t.fillStyle(e.color,.95),t.fillEllipse(y/2,18,52,26),t.fillRect(28,24,y-56,12);break}case"HELM":{t.fillStyle(e.color,.95),t.fillRect(24,16,y-48,18),t.fillEllipse(y/2,16,y-40,28),t.lineStyle(3,b(e.color,16777215,.3),.9),t.strokeRect(24,16,y-48,18);break}case"BRAND":{t.lineStyle(4,e.color,.9),t.strokeRoundedRect(30,54,y-60,24,6),t.lineStyle(2,b(e.color,16777215,.3),.6),t.beginPath(),t.moveTo(36,66),t.lineTo(y-36,66),t.strokePath();break}case"MASK":{t.fillStyle(e.color,.92),t.fillRoundedRect(30,38,y-60,28,10),t.lineStyle(2,b(e.color,16777215,.25),.9),t.strokeRoundedRect(30,38,y-60,28,10);break}}}function it(t,i,e){const s=t.add.graphics();s.fillStyle(e.background,1),s.fillCircle(y/2,y/2,y/2);const n=b(e.jaw,1053986,.15);s.fillStyle(n,1),s.fillCircle(y/2,y/2+18,fe+6),s.fillStyle(e.skin,1),s.fillCircle(y/2,y/2,fe),qe(s,e),Qe(s,e),Ze(s,e),Je(s,e),et(s,e),tt(s,e),s.generateTexture(i,y,y),s.destroy()}function st(t){const i=[];for(let e=0;e<te;e+=1){const s=`officer-portrait-${e}`;t.textures.exists(s)||it(t,s,Xe[e]),i.push(s)}return i}function nt(t){let i=0;for(let e=0;e<t.length;e+=1)i=(i<<5)-i+t.charCodeAt(e),i|=0;return i}function rt(t){return Math.abs(nt(t))%te}const Ce=20,ot=2,lt=4,at=10,ct={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Sp√§her:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anf√ºhrer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},K√∂nig:{promoteAtMerit:null,demoteBelowMerit:260}},Le={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},Re={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},dt=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],ht=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],K=["Schlackengrube","Sch√§delh√ºgel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],ut=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],ft=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],yt=["Bestienj√§ger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"];function mt(t,i,e){return i.filter(s=>s.id!==t.id&&s.traits.includes(e)).length}function J(t,i){let e=10+t.level*4+t.gearScore+t.merit*.15;for(const n of t.traits){const r=Le[n]??1;e*=r;const o=Re[n]??0;if(o>0){const l=mt(t,i,n);e*=1+l*o}}t.relationships.bloodOathWith&&i.some(n=>n.id===t.relationships.bloodOathWith)&&(e*=1.15);const s=i.filter(n=>t.relationships.friends.includes(n.id)).length;return s>0&&(e*=1+s*.05),t.relationships.rivals.some(n=>i.some(r=>r.id===n))&&(e*=.9),e*=.95+t.personality.aggression*.1,e*=.9+t.personality.loyalty*.1,e}function N(t){return t.length===0?0:t.reduce((i,e)=>i+J(e,t),0)}function pt(t,i){return(i.participants.includes(i.initiator)?i.participants:[i.initiator,...i.participants]).map(s=>t.officers.find(n=>n.id===s&&n.status==="ALIVE")).filter(s=>!!s)}function Tt(t,i){return t.officers.find(e=>e.id===i)}function k(t){return Number.isNaN(t)?.5:Number.isFinite(t)?Math.min(1,Math.max(0,t)):t>0?1:0}function Me(t,i){return i<=0?t>0?1:0:k(t/(t+i))}function St(t){return t==="MONSTER_HUNT"?26:16}function gt(t,i,e){const s=i.hiddenRoles.find(a=>a.role==="ASSASSIN"),n=s?e.find(a=>a.id===s.who):e[0],o=e.filter(a=>a.id!==(n==null?void 0:n.id)).sort((a,c)=>c.level-a.level)[0];if(!n||!o)return .5;const l=J(n,[n]),d=J(o,[o]);return k(l/(d*1.15))}function At(t,i){let e=.05+t.personality.opportunism*.25-t.personality.loyalty*.2;return t.relationships.rivals.includes(i.id)&&(e+=.15),t.relationships.bloodOathWith===i.id&&(e=0),k(e)}function bt(t,i,e){const s=e.find(h=>h.id===i.initiator);if(!s)return .5;const n=e.filter(h=>h.id!==s.id);if(n.length===0)return .8;const r=Math.max(1,Math.floor(n.length/2)),o=[s,...n.slice(0,r)],l=n.slice(r);if(l.length===0)return .9;const d=o.slice(1).reduce((h,u)=>h+At(u,s),0),a=N(o)*(1-d*.2),c=N(l);return Me(a,c)}function Et(t,i){const e=N(i),s=St(t.type)*i.length;return k(e/(s*1.1))}function Ot(t,i,e){const s=e.find(c=>c.id===i.initiator);if(!s)return .5;const n=e.filter(c=>c.id===s.id||i.hiddenRoles.some(h=>h.who===c.id&&h.role==="LOYALIST")),r=e.filter(c=>!n.includes(c));if(r.length===0)return .85;const o=N(n),l=N(r),d=Me(o,l),a=r.length*.05;return k(d*(1-a)+.1)}function kt(t){if(t.length<=1)return .95;const e=t.slice(1).map(s=>.15).reduce((s,n)=>s+n,0);return k(.95-e*.1)}function It(t,i,e){switch(i.type){case"ASSASSINATION":return gt(t,i,e);case"OVERFALL":return bt(t,i,e);case"PURGE":return Ot(t,i,e);case"HUNT":case"MONSTER_HUNT":return Et(i,e);case"FEAST":default:return kt(e)}}function vt(t,i){const e=pt(t,i);if(e.length===0)return .5;const s=Tt(t,i.initiator);return!s||s.status!=="ALIVE"?.5:k(It(t,i,e))}class xt{constructor(i){f(this,"state");this.state=i>>>0}next(){let i=this.state;return i^=i<<13,i^=i>>>17,i^=i<<5,this.state=i>>>0,this.state/4294967295}int(i,e){return Math.floor(this.next()*(e-i+1))+i}chance(i){return this.next()<i}pick(i){if(i.length===0)throw new Error("Cannot pick from empty array");return i[this.int(0,i.length-1)]}shuffle(i){const e=[...i];for(let s=e.length-1;s>0;s--){const n=this.int(0,s);[e[s],e[n]]=[e[n],e[s]]}return e}}const Ct=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],Lt=["Leder","Ketten","Schuppen","Sch√§delplatten"],Rt=["Blutring","Schlackenfetisch","K√∂nigszahn","Sturmsiegel"],Mt=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function W(t){return Math.max(0,Math.min(1,t))}function wt(t){return`${t.pick(ut)}${t.pick(ft)}`}function Pt(t){return{aggression:W(t.next()),loyalty:W(t.next()),opportunism:W(t.next()),ambition:W(t.next())}}function Nt(t){const i=t.chance(.3)?2:1;return t.shuffle(dt).slice(0,i)}function Bt(t){const i=t.shuffle(Mt),e=t.chance(.25)?2:1;return i.slice(0,e)}function Dt(t){const i=t.chance(.5)?t.pick(Rt):void 0;return{weapon:t.pick(Ct),armor:t.pick(Lt),trinket:i}}function Wt(t){switch(t){case"Grunzer":return 10;case"Sp√§her":return 40;case"Captain":return 80;case"Anf√ºhrer":return 140;case"Herausforderer":return 210;case"K√∂nig":return 320}}function Vt(t){return t.chance(.3)?[t.pick(yt)]:[]}function F(t,i={}){const e=i.rank??"Grunzer",s=i.id??`orc_${Math.round(t.next()*1e9)}`,n=i.equipment??Dt(t),r=i.level??t.int(e==="K√∂nig"?8:1,e==="K√∂nig"?12:6),o=i.merit??Math.max(0,Math.round(Wt(e)+t.int(-15,20)));return{id:s,name:i.name??wt(t),clan:i.clan??t.pick(ht),titles:i.titles??Vt(t),level:r,rank:e,merit:o,combatStyle:i.combatStyle??Bt(t),traits:i.traits??Nt(t),equipment:n,gearScore:i.gearScore??t.int(8,16),status:i.status??"ALIVE",personality:i.personality??Pt(t),relationships:i.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:i.memories??[],territory:i.territory??[t.pick(K)],lastBloodOathCycle:i.lastBloodOathCycle}}function z(t,i,e=12){const s=[...t.memories,i].slice(-e);return{...t,memories:s}}function $t(t,i){return{...t,merit:Math.max(0,t.merit+i)}}function be(t){return{...t,status:"DEAD"}}function Ft(t,i){return t.relationships.bloodOathWith?t.lastBloodOathCycle!==void 0&&i-t.lastBloodOathCycle<=at:!1}class Ht{constructor(i,e){this.rng=i,this.state=e}getAlive(){return this.state.officers.filter(i=>i.status==="ALIVE")}getById(i){return this.state.officers.find(e=>e.id===i)}registerDeath(i,e){const s=[],n=[],r=this.state.officers.map(l=>l.id!==i?l:(s.push({officerId:i,status:"DEAD",reason:"BATTLE"}),n.push({id:`death_${i}_${e}`,cycle:e,text:`${l.name} f√§llt im Kampf`,tags:["DEATH"]}),be(l))),o=r.find(l=>l.id===i);if(o&&o.relationships.bloodOathWith){const l=o.relationships.bloodOathWith,d=r.findIndex(a=>a.id===l);if(d>=0){const a=r[d];a.status==="ALIVE"&&Ft(a,e)&&(s.push({officerId:a.id,status:"DEAD",reason:"BLOOD_OATH"}),n.push({id:`blood_${a.id}_${e}`,cycle:e,text:`${a.name} stirbt durch den Blutschwur mit ${o.name}`,tags:["DEATH","BLOODOATH"]}),r[d]=be(a))}}return this.state.officers=r,{updatedOfficers:r,casualties:s,feed:n}}rewardMerit(i,e,s,n){this.state.officers=this.state.officers.map(r=>{if(r.id!==i)return r;const o=$t(r,e);return z(o,{cycle:s,type:"WARCALL",notes:n})})}ensureRoster(i){const e=[];for(;this.getAlive().length<Ce;){const s=F(this.rng,{rank:"Grunzer"}),n=z(s,{cycle:i,type:"WARCALL",notes:"Frisch rekrutiert"});e.push(n),this.state.officers.push(n)}return e}registerBloodOath(i,e,s){this.state.officers=this.state.officers.map(n=>n.id===i?{...n,relationships:{...n.relationships,bloodOathWith:e},lastBloodOathCycle:s}:n.id===e?{...n,relationships:{...n.relationships,bloodOathWith:i},lastBloodOathCycle:s}:n)}detectCycleTrigger(i){return this.getAlive().length<i?"OFFICER_DEATH":null}}function ee(t,i){let e=10+t.level*4+t.gearScore+t.merit*.15;for(const n of t.traits){const r=Le[n]??1;e*=r;const o=Re[n]??0;if(o>0){const l=i.filter(d=>d.traits.includes(n)).length;e*=1+l*o}}t.relationships.bloodOathWith&&i.some(n=>n.id===t.relationships.bloodOathWith)&&(e*=1.15);const s=i.filter(n=>t.relationships.friends.includes(n.id)).length;return e*=1+s*.05,t.relationships.rivals.some(n=>i.some(r=>r.id===n))&&(e*=.9),e*=.95+t.personality.aggression*.1,e*=.9+t.personality.loyalty*.1,e}function B(t,i){const e=t,s=t.reduce((r,o)=>r+ee(o,e),0),n=.9+i.next()*.2;return s*n}function _t(t,i,e){let s=.05+i.personality.opportunism*.25-i.personality.loyalty*.2;return i.relationships.rivals.includes(e.id)&&(s+=.15),i.relationships.bloodOathWith===e.id&&(s=0),s>0&&t.chance(Math.min(.8,Math.max(0,s)))}function S(t,i,e,s){return{id:`feed_${i}_${Math.round(t.next()*1e9)}`,cycle:i,text:e,tags:s}}function zt(t,i){return i.map(e=>t.getById(e)).filter(e=>!!(e&&e.status==="ALIVE"))}function G(t,i,e,s,n){i.forEach(r=>t.rewardMerit(r.id,s,e,n))}function x(t,i,e){const{casualties:s,feed:n}=t.registerDeath(i.id,e);return{casualties:s,feed:n}}function Ee(t,i,e,s,n,r,o){const l=[];if(B(n,t)>=r){G(s,n,e.cycle,i.rewards.merit,o);const h=S(t,e.cycle,`${n[0].name}s Gruppe triumphiert bei ${i.location}`,[i.type,"SUCCESS"]);return l.push(h),{warcall:i,victorious:n.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:l}}const a=t.pick(n),c=x(s,a,e.cycle);return l.push(S(t,e.cycle,`${a.name} kehrt nicht von ${i.location} zur√ºck`,[i.type,"DEATH"])),{warcall:i,victorious:[],defeated:[a.id],betrayals:[],casualties:c.casualties,feedEntries:[...l,...c.feed]}}function Gt(t,i,e,s,n){const r=[],o=i.hiddenRoles.find(u=>u.role==="ASSASSIN"),l=o?n.find(u=>u.id===o.who):n[0],d=n.find(u=>u.id!==(l==null?void 0:l.id));if(!l||!d)return r.push(S(t,e.cycle,`Attentat ${i.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:i,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=ee(l,[l]),c=ee(d,[d]),h=(t.next()-.5)*4;if(a+h>c){const u=x(s,d,e.cycle);return s.rewardMerit(l.id,i.rewards.merit,e.cycle,"Gelungenes Attentat"),r.push(S(t,e.cycle,`${l.name} meuchelt ${d.name} in ${i.location}`,["ASSASSINATION","SUCCESS"])),{warcall:i,victorious:[l.id],defeated:[d.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}if(t.chance(.5)){const u=x(s,l,e.cycle);return r.push(S(t,e.cycle,`${l.name} stirbt beim gescheiterten Attentat auf ${d.name}`,["ASSASSINATION","DEATH"])),{warcall:i,victorious:[d.id],defeated:[l.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}return r.push(S(t,e.cycle,`${d.name} wehrt ${l.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:i,victorious:[d.id],defeated:[],betrayals:[],casualties:[],feedEntries:r}}function Ut(t,i,e,s,n){const r=[],o=n.find(p=>p.id===i.initiator);if(!o)return r.push(S(t,e.cycle,`√úberfall ${i.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:i,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const l=n.filter(p=>p.id!==o.id);if(l.length===0)return r.push(S(t,e.cycle,`${o.name} findet keine Gegner f√ºr den √úberfall`,["OVERFALL","ABORTED"])),{warcall:i,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const d=Math.max(1,Math.floor(l.length/2)),a=[o,...l.slice(0,d)],c=l.slice(d);if(c.length===0)return r.push(S(t,e.cycle,`${o.name} vertreibt Pl√ºnderer ohne Widerstand`,["OVERFALL","NO_DEF"])),G(s,a,e.cycle,Math.round(i.rewards.merit/2),"Leichter √úberfall"),{warcall:i,victorious:a.map(p=>p.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const h=[];for(const p of a.slice(1))_t(t,p,o)&&(c.push(p),a.splice(a.indexOf(p),1),h.push(p.id));const u=B(a,t),m=B(c,t),T=u>=m,g=T?c:a,O=T?a:c;G(s,O,e.cycle,i.rewards.merit,"√úberfall-Erfolg");const j=t.pick(g),C=x(s,j,e.cycle);return r.push(S(t,e.cycle,`${O[0].name}s Seite siegt bei ${i.location}`,["OVERFALL",T?"SUCCESS":"FAIL"])),{warcall:i,victorious:O.map(p=>p.id),defeated:g.map(p=>p.id),betrayals:h,casualties:C.casualties,feedEntries:[...r,...C.feed]}}function Yt(t,i,e,s,n){const r=[],o=n.find(p=>p.id===i.initiator);if(!o)return r.push(S(t,e.cycle,`S√§uberung ${i.id} scheitert ohne K√∂nig`,["PURGE","ABORTED"])),{warcall:i,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const l=n.filter(p=>p.id===o.id||i.hiddenRoles.some(oe=>oe.who===p.id&&oe.role==="LOYALIST")),d=n.filter(p=>!l.includes(p));if(d.length===0)return r.push(S(t,e.cycle,`${o.name} erzwingt neue Treueschw√ºre`,["PURGE","LOYALTY"])),G(s,l,e.cycle,Math.round(i.rewards.merit/2),"Treueeid"),{warcall:i,victorious:l.map(p=>p.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=d.filter(p=>t.chance(.4)),c=d.filter(p=>!a.includes(p)),h=c.map(p=>p.id);if(c.length===0)return r.push(S(t,e.cycle,`${o.name} erkl√§rt ${a.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:i,victorious:l.map(p=>p.id),defeated:a.map(p=>p.id),betrayals:h,casualties:[],feedEntries:r};const u=B(l,t),m=B(c,t),T=u>=m,g=T?c:l,O=T?l:c,j=t.pick(g),C=x(s,j,e.cycle);return r.push(S(t,e.cycle,`${O[0].name} entscheidet die S√§uberung`,["PURGE",T?"SUCCESS":"REBELLION"])),{warcall:i,victorious:O.map(p=>p.id),defeated:g.map(p=>p.id),betrayals:h,casualties:C.casualties,feedEntries:[...r,...C.feed]}}function Kt(t,i,e,s,n){const r=[];n.forEach(l=>s.rewardMerit(l.id,Math.round(i.rewards.merit/2),e.cycle,"Feast-Bindung"));const o=S(t,e.cycle,`${n[0].name} richtet ein heikles Festmahl in ${i.location}`,["FEAST","BOND"]);if(r.push(o),n.length>1&&t.chance(.15)){const l=t.pick(n.slice(1)),d=t.pick(n.filter(c=>c.id!==l.id)),a=x(s,d,e.cycle);return r.push(S(t,e.cycle,`${l.name} vergiftet ${d.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:i,victorious:[l.id],defeated:[d.id],betrayals:[l.id],casualties:a.casualties,feedEntries:[...r,...a.feed]}}return{warcall:i,victorious:n.map(l=>l.id),defeated:[],betrayals:[],casualties:[],feedEntries:r}}function jt(t,i,e,s){const n=zt(s,i.participants);if(n.length===0)return{warcall:i,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[S(t,e.cycle,`Warcall ${i.id} entf√§llt mangels Teilnehmer`,["EMPTY"])]};switch(i.type){case"HUNT":return Ee(t,i,e,s,n,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return Ee(t,i,e,s,n,26,"Monster bezwungen");case"ASSASSINATION":return Gt(t,i,e,s,n);case"OVERFALL":return Ut(t,i,e,s,n);case"PURGE":return Yt(t,i,e,s,n);case"FEAST":default:return Kt(t,i,e,s,n)}}function ie(t,i){return`wc_${t.cycle}_${t.warcalls.length}_${Math.round(i.next()*1e6)}`}function Xt(t){const i=t.next();return i<.5?"AGENDA":i<.8?"RANDOM":"PLAYER"}function qt(t){return t.personality.aggression>.7?"OVERFALL":t.personality.opportunism>.6?"ASSASSINATION":t.rank==="K√∂nig"?"PURGE":"FEAST"}function Qt(t){return t.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function se(t,i,e,s,n){const r=i.officers.filter(c=>c.status==="ALIVE"&&c.id!==e.id),o=t.shuffle(r);if(o.length===0)return[e];const l=Math.max(1,Math.min(s,o.length)),d=t.int(1,l),a=o.slice(0,d);if(n){const c=i.officers.find(h=>h.id===i.playerId&&h.status==="ALIVE");c&&!a.some(h=>h.id===c.id)&&c.id!==e.id&&(a[a.length-1]=c)}return[e,...a]}function ne(t,i,e){return i==="ASSASSINATION"?[{who:t.pick(e).id,role:"ASSASSIN"}]:i==="PURGE"?e.slice(1).map(s=>({who:s.id,role:t.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function re(t){switch(t){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienj√§ger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function Zt(t,i,e){const s=qt(e),n=se(t,i,e,s==="PURGE"?5:3,!1);return{id:ie(i,t),type:s,source:"AGENDA",initiator:e.id,participants:n.map(r=>r.id),hiddenRoles:ne(t,s,n),location:t.pick(K),startCycle:i.cycle,deadlineCycle:i.cycle+1,rewards:re(s),state:"ANNOUNCED"}}function Jt(t,i){const e=i.officers.filter(o=>o.status==="ALIVE"),s=t.pick(e),n=Qt(t),r=se(t,i,s,3,!1);return{id:ie(i,t),type:n,source:"RANDOM",initiator:s.id,participants:r.map(o=>o.id),hiddenRoles:ne(t,n,r),location:t.pick(K),startCycle:i.cycle,deadlineCycle:i.cycle+1,rewards:re(n),state:"ANNOUNCED"}}function ei(t,i){const e=i.officers.find(r=>r.id===i.playerId&&r.status==="ALIVE");if(!e)return null;const s=e.rank==="Grunzer"?"HUNT":"OVERFALL",n=se(t,i,e,2,!0);return{id:ie(i,t),type:s,source:"PLAYER",initiator:e.id,participants:n.map(r=>r.id),hiddenRoles:ne(t,s,n),location:t.pick(K),startCycle:i.cycle,deadlineCycle:i.cycle+1,rewards:re(s),state:"ANNOUNCED"}}function ti(t,i){const e=i.warcalls.filter(o=>o.state!=="RESOLVED"),s=t.int(ot,lt),n=Math.max(0,s-e.length),r=[];for(let o=0;o<n;o++){const l=Xt(t),d=i.officers.filter(c=>c.status==="ALIVE");if(d.length<2)break;let a=null;if(l==="AGENDA"){const c=[...d].sort((h,u)=>u.personality.ambition-h.personality.ambition);a=Zt(t,i,c[0])}else l==="RANDOM"?a=Jt(t,i):a=ei(t,i);a&&(r.push(a),i.warcalls.push(a))}return r}function ii(t,i,e){const s=[];for(const n of i.warcalls){if(n.state==="RESOLVED"||i.cycle<n.deadlineCycle)continue;n.state="IN_PROGRESS";const r=jt(t,n,i,e);n.state="RESOLVED",s.push(r)}return s}const P=["Grunzer","Sp√§her","Captain","Anf√ºhrer","Herausforderer","K√∂nig"];function si(t){const i=P.indexOf(t);return i===-1||i>=P.length-1?null:P[i+1]}function ni(t){const i=P.indexOf(t);return i<=0?null:P[i-1]}function U(t,i,e,s){return{id:`cycle_${i}_${Math.round(t.next()*1e9)}`,cycle:i,text:e,tags:s}}function ri(t,i){const e=[],s=[];return i.officers=i.officers.map(n=>{if(n.status!=="ALIVE")return n;const r=ct[n.rank],o=r.promoteAtMerit!==null&&n.merit>=r.promoteAtMerit?si(n.rank):null;if(o)return e.push({officerId:n.id,from:n.rank,to:o}),s.push(U(t,i.cycle,`${n.name} steigt zum ${o} auf`,["PROMOTION"])),z({...n,rank:o},{cycle:i.cycle,type:"PROMOTION",notes:`Aufstieg zu ${o}`});const l=r.demoteBelowMerit!==null&&n.merit<r.demoteBelowMerit?ni(n.rank):null;return l?(e.push({officerId:n.id,from:n.rank,to:l}),s.push(U(t,i.cycle,`${n.name} f√§llt zum ${l} zur√ºck`,["DEMOTION"])),z({...n,rank:l},{cycle:i.cycle,type:"DEMOTION",notes:`R√ºckstufung zu ${l}`})):n}),{changes:e,feed:s}}function oi(t){return t.flatMap(i=>i.feedEntries)}function li(t,i,e="DEBUG"){const s=new Ht(t,i),n=s.getAlive().length;i.cycle+=1;const r=ii(t,i,s),o=ri(t,i),l=s.ensureRoster(i.cycle),d=ti(t,i),a=[];a.push(...oi(r)),a.push(...o.feed),l.forEach(u=>{a.push(U(t,i.cycle,`${u.name} tritt als Rekrut bei`,["RECRUIT"]))}),d.forEach(u=>{a.push(U(t,i.cycle,`Neuer Warcall ${u.type} bei ${u.location}`,["WARCALL","NEW"]))}),i.feed=[...i.feed,...a].slice(-60);const h=s.detectCycleTrigger(n)??e;return{cycle:i.cycle,trigger:h,newWarcalls:d,resolved:r,hierarchyChanges:o.changes,replacements:l,feed:a}}function ai(t){return Array.from({length:Ce},(e,s)=>s===0?F(t,{rank:"K√∂nig",titles:["K√∂nig"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):s===1?F(t,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):F(t,{}))}class Oe{constructor(i){f(this,"state");f(this,"rng");this.rng=new xt(i.seed);const e=ai(this.rng),s=e[0].id,n=e[1].id;this.state={cycle:0,officers:e,warcalls:[],kingId:s,playerId:n,feed:[]}}runCycle(i="DEBUG"){return li(this.rng,this.state,i)}}const E=Y(),ci={WARCALL_COMPLETED:"Warcall abgeschlossen",FREE_ROAM_TIMEOUT:"Freies Spiel (Timeout)",OFFICER_DEATH:"Offizier gefallen",DEBUG:"Debug"},di={Grunzer:0,Sp√§her:1,Captain:2,Anf√ºhrer:3,Herausforderer:4,K√∂nig:5},hi={ACTIVITY:"Aktivit√§t",RELATIONSHIPS:"Beziehungen",WARCALLS:"Warcalls",PERSONALITY:"Pers√∂nlichkeit",LOYALTY:"Loyalit√§t"},M={SELF:10249796,ALLY:3120708,BLOOD:3835647,RIVAL:13631488,NEUTRAL:3422784},w={HOST:9256840,SUPPORT:3120708,RIVAL:13631488,HIDDEN:15228164,UNKNOWN:4804695},ui={PROMOTION:620,DEMOTION:260,DEATH:180,WARCALL:420,PURGE:150,REPLACEMENT:520};function v(t){const i=t.split(" ")[0]??t;return i.length>10?`${i.slice(0,9)}‚Ä¶`:i}function ke(t,i){return i.merit-t.merit||i.level-t.level||t.name.localeCompare(i.name)}function Ie(t){return di[t]??0}class fi extends E.Scene{constructor(){super("Play");f(this,"world");f(this,"boardBg");f(this,"sidebarBg");f(this,"levelBands",[]);f(this,"levelLabels",[]);f(this,"connections");f(this,"cycleText");f(this,"triggerText");f(this,"dominanceLabel");f(this,"dominanceDesc");f(this,"feedLabel");f(this,"feedText");f(this,"warcallLabel");f(this,"warcallsText");f(this,"detailLabel");f(this,"detailText");f(this,"controlsText");f(this,"cemeteryButton");f(this,"cemeteryOverlay");f(this,"cemeteryScrim");f(this,"cemeteryListText");f(this,"overlayContainer");f(this,"overlayBg");f(this,"overlayPanel");f(this,"overlayTitle");f(this,"overlaySubtitle");f(this,"overlayHint");f(this,"overlayActive",!1);f(this,"overlayQueue",[]);f(this,"overlayTimer");f(this,"officerTokens",new Map);f(this,"highlightIds",new Set);f(this,"viewButtons",new Map);f(this,"viewMode","ACTIVITY");f(this,"selectedOfficerId",null);f(this,"hoveredOfficerId",null);f(this,"boardArea",{x:120,y:120,width:640,height:460});f(this,"portraitKeys",[]);f(this,"officerPortraitMap",new Map);f(this,"lastSummary");f(this,"configureLayout",()=>{const e=this.scale.width,s=this.scale.height,n=Math.max(320,Math.min(420,Math.round(e*.28))),r=Math.max(32,Math.round(e*.04)),o=80,l=80;this.boardArea={x:r,y:o,width:Math.max(360,e-n-r*2-24),height:Math.max(320,s-o-l)},this.boardBg.setPosition(this.boardArea.x,this.boardArea.y),this.boardBg.setSize(this.boardArea.width,this.boardArea.height);const d=this.boardArea.x+this.boardArea.width+24;this.sidebarBg.setPosition(d-16,o-24),this.sidebarBg.setSize(n,s-o+16),this.cycleText.setPosition(d,o-12),this.triggerText.setPosition(d,o+16),this.dominanceLabel.setPosition(d,o+48),this.dominanceDesc.setPosition(d,o+72);const a=o+112,c=40;let h=0;this.viewButtons.forEach(T=>{T.setPosition(d,a+h*c),h+=1});const u=a+c*this.viewButtons.size+12;this.feedLabel.setPosition(d,u),this.feedText.setPosition(d,u+26),this.warcallLabel.setPosition(d,u+180),this.warcallsText.setPosition(d,u+208);const m=u+360;this.detailLabel.setPosition(d,m),this.detailText.setPosition(d,m+26),this.controlsText.setPosition(d,s-48),this.cemeteryButton.setPosition(d,s-80),this.overlayBg.setSize(e,s),this.overlayPanel.setPosition(e/2,s/2),this.overlayTitle.setPosition(e/2,s/2-90),this.overlaySubtitle.setPosition(e/2,s/2+10),this.overlayHint.setPosition(e/2,s/2+120),this.cemeteryScrim.setSize(e,s),this.cemeteryOverlay.setPosition(e/2,s/2),this.detailText.setWordWrapWidth(n-32),this.feedText.setWordWrapWidth(n-32),this.warcallsText.setWordWrapWidth(n-32),this.updateHierarchyVisuals([]),this.applyViewModeToTokens(),this.officerTokens.size>0&&this.syncOfficerTokens()})}create(){this.world=new Oe({seed:Date.now()}),this.portraitKeys=st(this),this.officerPortraitMap.clear(),this.createBoardBackground(),this.createSidebar(),this.createViewButtons(),this.createCycleOverlay(),this.initializeCemetery(),this.connections=this.add.graphics(),this.connections.setDepth(.3),this.boardBg.on("pointerdown",()=>{this.viewMode==="RELATIONSHIPS"&&(this.selectedOfficerId=null,this.applyViewModeToTokens())}),this.input.keyboard.on("keydown-E",()=>this.advanceCycle()),this.input.keyboard.on("keydown-R",()=>this.resetWorld()),this.input.keyboard.on("keydown-SPACE",()=>{this.overlayActive&&this.skipCycleOverlay()}),this.scale.on(E.Scale.Events.RESIZE,this.configureLayout,this),this.configureLayout(),this.refreshScene()}update(e,s){}createBoardBackground(){this.boardBg=this.add.rectangle(0,0,100,100,1054496,.92).setOrigin(0,0),this.boardBg.setStrokeStyle(2,2568767,.85),this.boardBg.setDepth(.1);for(let e=0;e<6;e++){const s=this.add.rectangle(0,0,100,80,1121061,.65).setOrigin(0,.5);s.setDepth(.2),s.setVisible(!1),this.levelBands.push(s);const n=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#93a3b8",fontStyle:"bold"}).setDepth(.4).setVisible(!1);this.levelLabels.push(n)}}createSidebar(){this.sidebarBg=this.add.rectangle(0,0,100,100,857114,.92).setOrigin(0,0),this.sidebarBg.setStrokeStyle(1,2041907,.65),this.cycleText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"24px",color:"#f1f2f6"}),this.triggerText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#cbd0d6"}),this.dominanceLabel=this.add.text(0,0,"Herrschaft",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.dominanceDesc=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae",lineSpacing:4}),this.feedLabel=this.add.text(0,0,"Welt-Feed",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.feedText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(260),this.warcallLabel=this.add.text(0,0,"Aktive Warcalls",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.warcallsText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(260),this.detailLabel=this.add.text(0,0,"Details",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.detailText=this.add.text(0,0,"Fahre mit der Maus √ºber ein Portr√§t oder tippe es an.",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:4}).setWordWrapWidth(260),this.controlsText=this.add.text(0,0,"E: Cycle simulieren   R: Welt neu generieren   SPACE: Skip",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"})}createViewButtons(){["ACTIVITY","RELATIONSHIPS","WARCALLS","PERSONALITY","LOYALTY"].forEach((s,n)=>{const r=this.add.container(0,0),o=this.add.rectangle(0,0,220,30,1121061,.65).setOrigin(0,.5);o.setStrokeStyle(1,2042419,.7);const l=this.add.text(12,0,hi[s],{fontFamily:"monospace",fontSize:"14px",color:"#d1d9e6"});l.setOrigin(0,.5),r.add([o,l]),r.setSize(220,32),r.setInteractive(new E.Geom.Rectangle(0,-16,220,32),E.Geom.Rectangle.Contains),r.on("pointerover",()=>this.input.setDefaultCursor("pointer")),r.on("pointerout",()=>this.input.setDefaultCursor("default")),r.on("pointerdown",()=>this.setViewMode(s)),r.setDepth(1.2+n*.01),this.viewButtons.set(s,r)}),this.updateViewButtons()}createCycleOverlay(){this.overlayContainer=this.add.container(0,0),this.overlayContainer.setDepth(50),this.overlayContainer.setVisible(!1),this.overlayBg=this.add.rectangle(0,0,10,10,198155,.78).setOrigin(0,0),this.overlayBg.setInteractive({useHandCursor:!1}),this.overlayBg.on("pointerdown",()=>this.skipCycleOverlay()),this.overlayPanel=this.add.rectangle(0,0,560,320,1121065,.95).setOrigin(.5),this.overlayPanel.setStrokeStyle(1,2572376,.8),this.overlayTitle=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"28px",color:"#f1f2f6",align:"center"}).setOrigin(.5).setWordWrapWidth(520),this.overlaySubtitle=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"16px",color:"#d1d9e6",align:"center",lineSpacing:8}).setOrigin(.5).setWordWrapWidth(520),this.overlayHint=this.add.text(0,0,"SPACE dr√ºcken, um zu skippen",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}).setOrigin(.5,.5),this.overlayContainer.add([this.overlayBg,this.overlayPanel,this.overlayTitle,this.overlaySubtitle,this.overlayHint])}initializeCemetery(){this.cemeteryButton=this.add.text(0,0,"Friedhof (0)",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",backgroundColor:"#162026"}).setPadding(8,4,10,4).setInteractive({useHandCursor:!0}),this.cemeteryButton.on("pointerdown",()=>this.toggleCemetery()),this.cemeteryOverlay=this.add.container(0,0),this.cemeteryOverlay.setDepth(40),this.cemeteryOverlay.setVisible(!1),this.cemeteryScrim=this.add.rectangle(0,0,10,10,131589,.7).setOrigin(0,0),this.cemeteryScrim.setInteractive({useHandCursor:!1}),this.cemeteryScrim.on("pointerdown",()=>this.closeCemetery());const e=this.add.rectangle(0,0,360,420,1120289,.96).setOrigin(.5);e.setStrokeStyle(1,2042419,.75);const s=this.add.text(0,-180,"Friedhof",{fontFamily:"monospace",fontSize:"20px",color:"#f1f2f6"}).setOrigin(.5,0);this.cemeteryListText=this.add.text(-160,-140,"Noch keine Gefallenen.",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setOrigin(0,0).setWordWrapWidth(320);const n=this.add.text(0,180,"Schlie√üen",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}).setOrigin(.5,.5);n.setInteractive({useHandCursor:!0}),n.on("pointerdown",()=>this.closeCemetery()),this.cemeteryOverlay.add([this.cemeteryScrim,e,s,this.cemeteryListText,n])}setViewMode(e){this.viewMode===e?e==="RELATIONSHIPS"&&(this.selectedOfficerId=null):(this.viewMode=e,e!=="RELATIONSHIPS"&&(this.selectedOfficerId=null)),this.applyViewModeToTokens()}refreshScene(e){this.lastSummary=e,this.highlightIds=_e(e),this.updateDominanceIndicator(),this.cycleText.setText(`Cycle ${this.world.state.cycle}`);const s=e?ci[e.trigger]??e.trigger:"Start der Kampagne";this.triggerText.setText(`Ausl√∂ser: ${s}`),this.syncOfficerTokens(e),this.refreshFeed(e),this.refreshWarcalls(e),this.updateCemetery(),this.applyViewModeToTokens()}syncOfficerTokens(e){const s=new Set;e==null||e.resolved.forEach(a=>{a.casualties.forEach(c=>{c.status!=="ALIVE"&&s.add(c.officerId)})});const n=this.world.state.officers.filter(a=>a.status==="ALIVE"||s.has(a.id)).slice().sort(ke),r=Ue(n,this.world.state.kingId,this.boardArea);this.updateHierarchyVisuals(r.levels);const o=this.computeTokenScale(n.length),l=new Set,d=!e;n.forEach(a=>{const c=r.positions.get(a.id);if(!c)return;const h=this.highlightIds.has(a.id),u=this.getPortraitKey(a);let m=this.officerTokens.get(a.id);m?m.setPosition(c.x,c.y,{immediate:d}):(m=new We({scene:this,x:c.x,y:c.y,officer:a,portraitKey:u,scale:o,highlight:h,onHover:T=>this.showOfficerDetails(T),onBlur:()=>this.clearOfficerDetails(),onClick:(T,g)=>this.handleOfficerClick(T,g)}),this.officerTokens.set(a.id,m)),m.update(a,{highlight:h,scale:o,crossed:a.status!=="ALIVE",portraitKey:u}),l.add(a.id)}),this.officerTokens.forEach((a,c)=>{l.has(c)||(a.destroy(),this.officerTokens.delete(c))})}computeTokenScale(e){return e<=10?1.05:e<=14?.95:e<=18?.9:.85}applyViewModeToTokens(){switch(this.viewMode){case"RELATIONSHIPS":this.applyRelationshipMode();break;case"WARCALLS":this.applyWarcallMode();break;case"PERSONALITY":this.applyPersonalityMode();break;case"LOYALTY":this.applyLoyaltyMode();break;case"ACTIVITY":default:this.applyActivityMode();break}this.updateViewButtons(),this.updateConnections(),this.hoveredOfficerId||this.detailText.setText(this.getDetailHint())}applyActivityMode(){const e=this.world.state.warcalls;this.officerTokens.forEach((s,n)=>{const r=this.getOfficerById(n);if(!r)return;const o=he(r,e,l=>this.getOfficerById(l));s.update(r,{mode:"ACTIVITY",detailText:o.summary,badgeText:null,dimmed:!1,focus:null})})}applyRelationshipMode(){const e=this.selectedOfficerId?this.getOfficerById(this.selectedOfficerId):null;this.officerTokens.forEach((s,n)=>{const r=this.getOfficerById(n);if(!r)return;if(!e){s.update(r,{mode:"RELATIONSHIPS",detailText:"W√§hle einen Offizier",badgeText:null,dimmed:!0,focus:null});return}const o=this.describeRelationship(e,r);s.update(r,{mode:"RELATIONSHIPS",detailText:o.label,badgeText:o.badge,badgeColor:o.color,dimmed:o.dimmed,focus:o.focus})})}applyWarcallMode(){const e=this.getActiveWarcalls(),s=this.collectWarcallInvolvements(e),n=e.length>0;this.officerTokens.forEach((r,o)=>{const l=this.getOfficerById(o);if(!l)return;const d=s.get(o)??[];if(d.length===0){r.update(l,{mode:"WARCALLS",detailText:n?"Nicht eingeplant":"Keine Eins√§tze",badgeText:null,dimmed:n,focus:null});return}const a=d.map(T=>`${Q[T.warcall.type]} ${T.role}`),c=d[0];let h="?",u=w.UNKNOWN,m=null;c.isHost?(h="‚ôõ",u=w.HOST,m="leader"):c.role.includes("Rivale")?(h="‚àí",u=w.RIVAL,m="rival"):c.role.includes("Assassine")||c.role.includes("verdeckt")?(h="?",u=w.HIDDEN,m="hidden"):(h="+",u=w.SUPPORT,m="support"),r.update(l,{mode:"WARCALLS",detailText:a.join(`
`),badgeText:h,badgeColor:u,dimmed:!1,focus:m})})}applyPersonalityMode(){this.officerTokens.forEach((e,s)=>{const n=this.getOfficerById(s);if(!n)return;const r=this.computePersonalityPlan(n);let o=null,l=null;r.includes("K√∂nig")?(o="!",l="leader"):r.includes("Blut")&&(o="‚àû",l="blood"),e.update(n,{mode:"PERSONALITY",detailText:r,badgeText:o,badgeColor:7100492,dimmed:!1,focus:l})})}applyLoyaltyMode(){this.officerTokens.forEach((e,s)=>{const n=this.getOfficerById(s);if(!n)return;const r=this.computeLoyaltyProfile(n);e.update(n,{mode:"LOYALTY",detailText:r.text,badgeText:r.badge,badgeColor:r.badgeColor,dimmed:r.dimmed,focus:r.focus})})}updateConnections(){if(this.connections.clear(),this.viewMode==="RELATIONSHIPS"&&this.selectedOfficerId){const e=this.getOfficerById(this.selectedOfficerId),s=e?this.officerTokens.get(e.id):void 0;if(!e||!s)return;const n=s.getPosition(),r=(o,l,d=3)=>{const a=this.officerTokens.get(o);if(!a)return;const c=a.getPosition();this.connections.lineStyle(d,l,.85),this.connections.beginPath(),this.connections.moveTo(n.x,n.y),this.connections.lineTo(c.x,c.y),this.connections.strokePath()};e.relationships.friends.forEach(o=>r(o,3120708,3)),e.relationships.rivals.forEach(o=>r(o,13631488,3)),e.relationships.bloodOathWith&&r(e.relationships.bloodOathWith,3835647,4)}else if(this.viewMode==="LOYALTY"){const e=this.officerTokens.get(this.world.state.kingId);if(!e)return;const s=e.getPosition();this.world.state.officers.forEach(n=>{if(n.status!=="ALIVE"||n.id===this.world.state.kingId)return;const r=this.officerTokens.get(n.id);if(!r)return;const o=r.getPosition();if(n.relationships.loyalToKing){const l=n.personality.loyalty-n.personality.opportunism*.6,d=E.Math.Clamp(2+l*4,1.5,4.5),a=l>=.3?6750105:16762967;this.connections.lineStyle(d,a,.8),this.connections.beginPath(),this.connections.moveTo(o.x,o.y),this.connections.lineTo(s.x,s.y),this.connections.strokePath()}else n.relationships.rivals.includes(this.world.state.kingId)&&(this.connections.lineStyle(3,16735324,.8),this.connections.beginPath(),this.connections.moveTo(o.x,o.y),this.connections.lineTo(s.x,s.y),this.connections.strokePath())})}}updateViewButtons(){this.viewButtons.forEach((e,s)=>{const n=e.list[0],r=e.list[1],o=this.viewMode===s;n.fillColor=o?1780794:1121061,n.alpha=o?.9:.65,r.setColor(o?"#f1f2f6":"#d1d9e6")})}getActiveWarcalls(){return this.world.state.warcalls.filter(e=>e.state!=="RESOLVED")}collectWarcallInvolvements(e){const s=new Map;return e.forEach(n=>{const r=this.getOfficerById(n.initiator),o=(l,d,a,c)=>{s.has(l)||s.set(l,[]),s.get(l).push({warcall:n,role:d,isHost:a,hiddenRole:c})};o(n.initiator,"Ausrufer",!0),n.participants.forEach(l=>{var h;const d=this.getOfficerById(l);if(!d)return;const a=ve(n,d,r??void 0),c=(h=n.hiddenRoles.find(u=>u.who===l))==null?void 0:h.role;o(l,c?`${a} (${c.toLowerCase()})`:a,!1,c)}),n.hiddenRoles.forEach(l=>{l.who===n.initiator||n.participants.includes(l.who)||!this.getOfficerById(l.who)||o(l.who,`Verdeckt (${l.role.toLowerCase()})`,!1,l.role)})}),s}describeRelationship(e,s){return e.id===s.id?{label:"Zentralfigur",badge:"‚òÖ",color:M.SELF,focus:"leader",dimmed:!1}:e.relationships.bloodOathWith===s.id||s.relationships.bloodOathWith===e.id?{label:"Blutschwur",badge:"‚àû",color:M.BLOOD,focus:"blood",dimmed:!1}:e.relationships.friends.includes(s.id)?{label:"Verb√ºndeter",badge:"+",color:M.ALLY,focus:"ally",dimmed:!1}:e.relationships.rivals.includes(s.id)?{label:"Rivale",badge:"‚àí",color:M.RIVAL,focus:"rival",dimmed:!1}:{label:"Neutral",badge:null,color:M.NEUTRAL,focus:null,dimmed:!0}}computePersonalityPlan(e){const{ambition:s,aggression:n,loyalty:r,opportunism:o}=e.personality;return e.rank==="K√∂nig"?"Will seine Herrschaft festigen.":e.rank==="Herausforderer"||s>.82?"Will den Thron erobern.":e.traits.includes("Berserker")&&n>.7?"Sehnt sich nach brutalen Duellen.":e.traits.includes("Tierbaendiger")?"Will ein legend√§res Biest erlegen.":r>.75&&e.relationships.loyalToKing?"Will Blutbruder des K√∂nigs werden.":o>.65?"Schmiedet Pl√§ne f√ºr einen Verrat.":n>.6?"Sucht Ruhm auf dem Schlachtfeld.":s>.6?"Will zu den Captains aufsteigen.":e.traits.includes("Diplomat")?"Will ein Netz aus Verb√ºndeten kn√ºpfen.":e.traits.includes("GraueEminenz")?"Spinnt Intrigen im Schatten.":"Will Merit sammeln und Ausr√ºstung verbessern."}computeLoyaltyProfile(e){if(e.id===this.world.state.kingId)return{text:"Zentrum der Macht",badge:"‚ôõ",badgeColor:9256840,focus:"leader",dimmed:!1};const s=e.personality.loyalty,n=e.personality.opportunism,r=s-n*.6,o=r>=.35?"verl√§sslich":r<=0?"gef√§hrlich":"wankel";if(e.relationships.loyalToKing)return{text:`Treue zum K√∂nig (${o})`,badge:r>=.35?"‚òÖ":"?",badgeColor:r>=.35?3120708:16762967,focus:r>=.35?"support":"hidden",dimmed:!1};if(e.relationships.bloodOathWith){const l=this.getOfficerById(e.relationships.bloodOathWith);return{text:`Blutbruder von ${l?v(l.name):"?"} (${o})`,badge:"‚àû",badgeColor:3835647,focus:"blood",dimmed:!1}}return e.relationships.rivals.includes(this.world.state.kingId)?{text:"Rivale der Krone",badge:"!",badgeColor:13631488,focus:"rival",dimmed:!1}:s>.6?{text:"Sucht einen w√ºrdigen Anf√ºhrer",badge:null,badgeColor:1121061,focus:null,dimmed:!1}:{text:"H√§lt sich aus Loyalit√§ten heraus",badge:null,badgeColor:1121061,focus:null,dimmed:!0}}getDetailHint(){switch(this.viewMode){case"RELATIONSHIPS":return this.selectedOfficerId?"Beziehungen des markierten Offiziers.":"W√§hle einen Offizier, um Beziehungen zu sehen.";case"WARCALLS":return"W√§hle ein Portr√§t f√ºr Missionsrollen.";case"PERSONALITY":return"Pers√∂nliche Langzeitpl√§ne der Offiziere.";case"LOYALTY":return"Loyalit√§t und Vertrauensw√ºrdigkeit der Offiziere.";case"ACTIVITY":default:return"Fahre mit der Maus √ºber ein Portr√§t oder tippe es an."}}handleOfficerClick(e,s){this.viewMode==="RELATIONSHIPS"&&(this.selectedOfficerId=this.selectedOfficerId===e.id?null:e.id,this.applyViewModeToTokens())}showOfficerDetails(e){this.hoveredOfficerId=e.id;const s=e.traits.slice(0,2).join(", ")||"Keine",n=he(e,this.world.state.warcalls,d=>this.getOfficerById(d)),r=Math.round(e.personality.loyalty*100),o=Math.round(e.personality.opportunism*100),l=[`${e.name} ‚Äî ${e.rank} (Lv ${e.level})`,`Clan ${e.clan} ¬∑ Merit ${e.merit}`,`Traits: ${s}`,`Aktivit√§t: ${n.summary}`,`Loyalit√§t ${r}% ¬∑ Opportunismus ${o}%`];n.role&&l.push(`Rolle: ${n.role}`),this.detailText.setText(l.join(`
`))}clearOfficerDetails(){this.hoveredOfficerId=null,this.detailText.setText(this.getDetailHint())}updateHierarchyVisuals(e){e.forEach((s,n)=>{if(!this.levelBands[n])return;const r=this.levelBands[n],o=this.levelLabels[n],l=Math.max(70,s.bottom-s.top-6);r.setVisible(!0),r.setPosition(this.boardArea.x,s.top+l/2),r.setSize(this.boardArea.width,l);const d=n%2===0?1055268:857117;r.setFillStyle(d,.72),r.setStrokeStyle(1,2043194,.6),o.setVisible(!0),o.setPosition(this.boardArea.x+12,s.top+10),o.setText(s.label.toUpperCase())});for(let s=e.length;s<this.levelBands.length;s++)this.levelBands[s].setVisible(!1),this.levelLabels[s].setVisible(!1)}refreshFeed(e){const s=new Set((e==null?void 0:e.feed.map(o=>o.id))??[]),n=this.world.state.feed.slice(-6);if(n.length===0){this.feedText.setText("Keine Meldungen ‚Äì starte einen Warcall!");return}const r=n.map(o=>`${s.has(o.id)?"¬ª":"‚Ä¢"} [${o.cycle}] ${o.text}`);this.feedText.setText(r.join(`

`))}refreshWarcalls(e){const s=this.getActiveWarcalls();if(s.length===0){this.warcallsText.setText("Keine aktiven Warcalls.");return}const n=new Set((e==null?void 0:e.newWarcalls.map(o=>o.id))??[]),r=s.map(o=>{var m;const l=Q[o.type],d=Z[o.type],a=v(((m=this.getOfficerById(o.initiator))==null?void 0:m.name)??"Unbekannt"),c=[o.initiator,...o.participants].map(T=>{var g;return v(((g=this.getOfficerById(T))==null?void 0:g.name)??"?")}).join(", "),h=Math.round(this.computeWarcallSuccess(o)*100);return`${n.has(o.id)?"‚òÖ":"‚Ä¢"} ${l} ${d} ‚Äì ${a} (${h}% Erfolg)
   Teilnehmer: ${c}`});this.warcallsText.setText(r.join(`

`))}computeWarcallSuccess(e){return vt(this.world.state,e)}updateDominanceIndicator(){const e=this.computeDominanceState();this.dominanceLabel.setText(`Herrschaft: ${e.label}`),this.dominanceLabel.setColor(e.stable?"#8cffc1":"#ff6b6b"),this.dominanceDesc.setText(e.description)}computeDominanceState(){const e=this.world.state.officers.filter(h=>h.status==="ALIVE");if(e.length===0)return{label:"Unbekannt",description:"Keine Offiziere am Leben.",stable:!1};const s=e.reduce((h,u)=>h+u.personality.loyalty,0)/e.length,n=e.reduce((h,u)=>h+u.personality.ambition,0)/e.length,r=e.filter(h=>h.rank==="Herausforderer").length,o=this.getOfficerById(this.world.state.kingId),l=o?e.filter(h=>h.relationships.rivals.includes(o.id)).length:0,a=s-n*.35-r*.04-l*.08>=.05;return{label:a?"GEFESTIGT":"UNGEFESTIGT",description:a?"Die Clans stehen hinter dem K√∂nig.":"Intrigen und Zweifel schw√§chen die Herrschaft.",stable:a}}advanceCycle(){if(this.overlayActive){this.skipCycleOverlay();return}const e=this.world.runCycle();this.refreshScene(e),this.showCycleSummary(e)}resetWorld(){this.overlayActive&&this.skipCycleOverlay(),this.officerTokens.forEach(e=>e.destroy()),this.officerTokens.clear(),this.selectedOfficerId=null,this.hoveredOfficerId=null,this.world=new Oe({seed:Date.now()}),this.refreshScene()}showCycleSummary(e){const s=this.buildCycleEvents(e);if(s.length===0){this.playTone(420,.2,"triangle");return}this.overlayQueue=s,this.overlayActive=!0,this.overlayContainer.setVisible(!0),this.overlayContainer.setAlpha(0),this.tweens.add({targets:this.overlayContainer,alpha:1,duration:220,ease:E.Math.Easing.Cubic.Out,onComplete:()=>this.playNextCinematicEvent()})}playNextCinematicEvent(){var r;if(!this.overlayActive)return;const e=this.overlayQueue.shift();if(!e){this.hideCycleOverlay();return}this.overlayTitle.setText(e.title),this.overlaySubtitle.setText(e.description),this.overlayTitle.setAlpha(0),this.overlaySubtitle.setAlpha(0),this.tweens.add({targets:[this.overlayTitle,this.overlaySubtitle],alpha:1,duration:240,ease:E.Math.Easing.Cubic.Out});const s=e.tone??ui[e.kind];this.playTone(s,e.kind==="DEATH"?.5:.3,e.kind==="DEATH"?"sawtooth":"triangle"),this.applyCinematicEventEffects(e);const n=e.duration??1900;(r=this.overlayTimer)==null||r.remove(),this.overlayTimer=this.time.delayedCall(n,()=>this.playNextCinematicEvent())}applyCinematicEventEffects(e){var s;switch(e.kind){case"PROMOTION":case"DEMOTION":{const n=e.officerId?this.officerTokens.get(e.officerId):void 0;n&&n.flash(e.kind==="PROMOTION"?9240513:16739179,520);break}case"DEATH":{const n=e.officerId?this.officerTokens.get(e.officerId):void 0;n==null||n.markFallen();break}case"WARCALL":case"PURGE":{const n=e.warcallId?(s=this.lastSummary)==null?void 0:s.resolved.find(r=>r.warcall.id===e.warcallId):void 0;n&&(new Set([n.warcall.initiator,...n.warcall.participants,...n.victorious,...n.defeated]).forEach(o=>{const l=this.officerTokens.get(o);l==null||l.flash(e.kind==="PURGE"?16762967:6991948,520)}),n.casualties.forEach(o=>{const l=this.officerTokens.get(o.officerId);l==null||l.markFallen()}));break}case"REPLACEMENT":{const n=e.officerId?this.officerTokens.get(e.officerId):void 0;n==null||n.flash(7193343,520);break}}}hideCycleOverlay(){var e;(e=this.overlayTimer)==null||e.remove(),this.overlayTimer=void 0,this.overlayActive=!1,this.tweens.add({targets:this.overlayContainer,alpha:0,duration:220,ease:E.Math.Easing.Cubic.In,onComplete:()=>{this.overlayContainer.setVisible(!1)}})}skipCycleOverlay(){this.overlayActive&&(this.overlayQueue=[],this.hideCycleOverlay())}buildCycleEvents(e){const s=[],n=r=>{var o;return((o=this.getOfficerById(r))==null?void 0:o.name)??"Unbekannt"};return e.hierarchyChanges.forEach(r=>{const o=this.getOfficerById(r.officerId);if(!o)return;const l=Ie(r.to)>Ie(r.from);s.push({kind:l?"PROMOTION":"DEMOTION",officerId:o.id,title:l?`${o.name} steigt zum ${r.to} auf`:`${o.name} f√§llt zum ${r.to} zur√ºck`,description:l?`${o.name.split(" ")[0]} erringt mehr Einfluss.`:"Verliert Ansehen innerhalb der Hierarchie.",tone:l?640:280})}),e.resolved.forEach(r=>{const{warcall:o}=r,l=n(o.initiator),d=Z[o.type],a=r.victorious.map(m=>v(n(m))).join(", "),c=r.defeated.map(m=>v(n(m))).join(", "),h=[];a&&h.push(`Sieg f√ºr ${a}.`),c&&h.push(`Niederlage f√ºr ${c}.`);const u=r.casualties.filter(m=>m.status!=="ALIVE");if(u.length>0){const m=u.map(T=>v(n(T.officerId))).join(", ");h.push(`Verluste: ${m}.`)}s.push({kind:o.type==="PURGE"?"PURGE":"WARCALL",warcallId:o.id,title:`${Q[o.type]} ${d} ‚Äì ${l}`,description:h.join(" ")||"Ausgang noch unklar.",tone:o.type==="PURGE"?160:440,duration:o.type==="PURGE"?2400:2e3}),u.forEach(m=>{s.push({kind:"DEATH",officerId:m.officerId,title:`${n(m.officerId)} f√§llt`,description:m.reason==="BLOOD_OATH"?"Blutopfer w√§hrend des Eides.":`Gefallen w√§hrend ${d.toLowerCase()} in ${o.location}.`,tone:160,duration:2100})})}),e.replacements.forEach(r=>{s.push({kind:"REPLACEMENT",officerId:r.id,title:`${r.name} tritt der Hierarchie bei`,description:`${r.rank} aus dem Clan ${r.clan} ersetzt einen Gefallenen.`,tone:520})}),s}playTone(e,s=.3,n="triangle"){if(!(this.sound instanceof E.Sound.WebAudioSoundManager))return;const r=this.sound.context;if(!r)return;const o=r.createOscillator(),l=r.createGain();o.type=n,o.frequency.value=e,o.connect(l),l.connect(r.destination);const d=r.currentTime;l.gain.setValueAtTime(1e-4,d),l.gain.exponentialRampToValueAtTime(.25,d+.01),l.gain.exponentialRampToValueAtTime(1e-4,d+s),o.start(d),o.stop(d+s)}updateCemetery(){const e=this.world.state.officers.filter(n=>n.status!=="ALIVE");if(this.cemeteryButton.setText(`Friedhof (${e.length})`),e.length===0){this.cemeteryListText.setText("Noch keine Gefallenen.");return}const s=e.slice().sort(ke).map(n=>{const r=n.status==="MISSING"?"Vermisst":"Gefallen";return`‚Ä¢ ${n.name} (${n.rank}, Lv ${n.level}) ‚Äì ${r}`});this.cemeteryListText.setText(s.join(`

`))}toggleCemetery(){this.cemeteryOverlay.visible?this.closeCemetery():this.openCemetery()}openCemetery(){this.cemeteryOverlay.setVisible(!0),this.cemeteryOverlay.setAlpha(0),this.tweens.add({targets:this.cemeteryOverlay,alpha:1,duration:200,ease:E.Math.Easing.Cubic.Out})}closeCemetery(){this.tweens.add({targets:this.cemeteryOverlay,alpha:0,duration:200,ease:E.Math.Easing.Cubic.In,onComplete:()=>this.cemeteryOverlay.setVisible(!1)})}getOfficerById(e){return this.world.state.officers.find(s=>s.id===e)}getPortraitKey(e){const s=this.officerPortraitMap.get(e.id);if(s)return s;const n=rt(e.id),r=this.portraitKeys[n]??this.portraitKeys[0];return this.officerPortraitMap.set(e.id,r),r}}const V=Y();class yi extends V.Game{constructor(i){const e={type:V.AUTO,parent:i,backgroundColor:"#0b0d10",width:window.innerWidth,height:window.innerHeight,pixelArt:!0,scale:{mode:V.Scale.RESIZE,autoCenter:V.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[Be,fi]};super(e)}}new yi(document.getElementById("app"));
