
var V=Object.defineProperty;var Y=(i,e,t)=>e in i?V(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var p=(i,e,t)=>Y(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function M(){const i=globalThis.Phaser;if(!i)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return i}const j=M();class X extends j.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}const O=M(),q={Grunzer:4942970,Späher:5018988,Captain:16765286,Anführer:15681391,Herausforderer:10258872,König:1149618};function _(i){const t=i.split(" ")[0]??i;return t.length>12?`${t.slice(0,11)}…`:t}class J{constructor(e){p(this,"scene");p(this,"container");p(this,"circle");p(this,"nameText");p(this,"detailText");p(this,"hover");p(this,"blur");p(this,"currentOfficer");this.scene=e.scene,this.hover=e.onHover,this.blur=e.onBlur,this.currentOfficer=e.officer,this.container=this.scene.add.container(e.x,e.y),this.container.setSize(96,96),this.container.setDepth(1);const t=new O.Geom.Circle(0,0,36);this.container.setInteractive(t,O.Geom.Circle.Contains),this.circle=this.scene.add.circle(0,0,30,16777215,1),this.circle.setStrokeStyle(2,858922,.6),this.nameText=this.scene.add.text(0,-6,_(e.officer.name),{fontFamily:"monospace",fontSize:"12px",color:"#f7f9fc",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.detailText=this.scene.add.text(0,24,"",{fontFamily:"monospace",fontSize:"10px",color:"#a9b7c6",align:"center"}).setOrigin(.5,.5).setWordWrapWidth(90),this.container.add([this.circle,this.nameText,this.detailText]),this.container.on("pointerover",()=>{this.container.setDepth(2),this.hover&&this.hover(this.currentOfficer)}),this.container.on("pointerout",()=>{this.container.setDepth(1),this.blur&&this.blur()}),this.update(e.officer,{highlight:e.highlight})}update(e,t={}){this.currentOfficer=e,this.nameText.setText(_(e.name)),this.detailText.setText(`${e.rank} • Lv ${e.level}`);const s=e.status==="ALIVE",n=s?q[e.rank]:3093559;this.circle.setFillStyle(n,s?1:.35),this.container.setAlpha(s?1:.45),this.scene.tweens.killTweensOf(this.container);let r=s?858922:2825503,c=s?.6:.9,o=2;t.highlight&&s?(r=16170336,c=.95,o=3,this.scene.tweens.add({targets:this.container,duration:240,scale:1.1,yoyo:!0,ease:O.Math.Easing.Sine.InOut})):this.container.setScale(1),this.circle.setStrokeStyle(o,r,c)}setPosition(e,t,s={}){if(s.immediate){this.container.setPosition(e,t);return}const n=O.Math.Distance.Between(this.container.x,this.container.y,e,t);if(n<4){this.container.setPosition(e,t);return}this.scene.tweens.add({targets:this.container,x:e,y:t,duration:200+n*.4,ease:O.Math.Easing.Sine.InOut})}getPosition(){return{x:this.container.x,y:this.container.y}}destroy(){this.container.destroy(!0)}}function Q(i){const e=new Set;return i&&(i.newWarcalls.forEach(t=>{e.add(t.initiator),t.participants.forEach(s=>e.add(s)),t.hiddenRoles.forEach(s=>e.add(s.who))}),i.resolved.forEach(t=>{const{warcall:s}=t;e.add(s.initiator),s.participants.forEach(n=>e.add(n)),t.victorious.forEach(n=>e.add(n)),t.defeated.forEach(n=>e.add(n)),t.casualties.forEach(n=>e.add(n.officerId))}),i.replacements.forEach(t=>e.add(t.id))),e}const Z=Object.freeze({columns:5,cellWidth:120,cellHeight:110,originX:120,originY:120});function ee(i,e=Z){return Array.from({length:i},(t,s)=>{const n=s%e.columns,r=Math.floor(s/e.columns);return{x:e.originX+n*e.cellWidth,y:e.originY+r*e.cellHeight}})}class te{constructor(e){p(this,"state");this.state=e>>>0}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967295}int(e,t){return Math.floor(this.next()*(t-e+1))+e}chance(e){return this.next()<e}pick(e){if(e.length===0)throw new Error("Cannot pick from empty array");return e[this.int(0,e.length-1)]}shuffle(e){const t=[...e];for(let s=t.length-1;s>0;s--){const n=this.int(0,s);[t[s],t[n]]=[t[n],t[s]]}return t}}const K=20,ie=2,ne=4,se=10,re={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Späher:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anführer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},König:{promoteAtMerit:null,demoteBelowMerit:260}},oe={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},ce={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},ae=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],le=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],$=["Schlackengrube","Schädelhügel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],de=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],he=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],ue=["Bestienjäger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"],fe=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],pe=["Leder","Ketten","Schuppen","Schädelplatten"],me=["Blutring","Schlackenfetisch","Königszahn","Sturmsiegel"],ye=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function b(i){return Math.max(0,Math.min(1,i))}function Ee(i){return`${i.pick(de)}${i.pick(he)}`}function Se(i){return{aggression:b(i.next()),loyalty:b(i.next()),opportunism:b(i.next()),ambition:b(i.next())}}function Ae(i){const e=i.chance(.3)?2:1;return i.shuffle(ae).slice(0,e)}function Te(i){const e=i.shuffle(ye),t=i.chance(.25)?2:1;return e.slice(0,t)}function ge(i){const e=i.chance(.5)?i.pick(me):void 0;return{weapon:i.pick(fe),armor:i.pick(pe),trinket:e}}function Oe(i){switch(i){case"Grunzer":return 10;case"Späher":return 40;case"Captain":return 80;case"Anführer":return 140;case"Herausforderer":return 210;case"König":return 320}}function xe(i){return i.chance(.3)?[i.pick(ue)]:[]}function R(i,e={}){const t=e.rank??"Grunzer",s=e.id??`orc_${Math.round(i.next()*1e9)}`,n=e.equipment??ge(i),r=e.level??i.int(t==="König"?8:1,t==="König"?12:6),c=e.merit??Math.max(0,Math.round(Oe(t)+i.int(-15,20)));return{id:s,name:e.name??Ee(i),clan:e.clan??i.pick(le),titles:e.titles??xe(i),level:r,rank:t,merit:c,combatStyle:e.combatStyle??Te(i),traits:e.traits??Ae(i),equipment:n,gearScore:e.gearScore??i.int(8,16),status:e.status??"ALIVE",personality:e.personality??Se(i),relationships:e.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:e.memories??[],territory:e.territory??[i.pick($)],lastBloodOathCycle:e.lastBloodOathCycle}}function v(i,e,t=12){const s=[...i.memories,e].slice(-t);return{...i,memories:s}}function ke(i,e){return{...i,merit:Math.max(0,i.merit+e)}}function G(i){return{...i,status:"DEAD"}}function be(i,e){return i.relationships.bloodOathWith?i.lastBloodOathCycle!==void 0&&e-i.lastBloodOathCycle<=se:!1}class Re{constructor(e,t){this.rng=e,this.state=t}getAlive(){return this.state.officers.filter(e=>e.status==="ALIVE")}getById(e){return this.state.officers.find(t=>t.id===e)}registerDeath(e,t){const s=[],n=[],r=this.state.officers.map(o=>o.id!==e?o:(s.push({officerId:e,status:"DEAD",reason:"BATTLE"}),n.push({id:`death_${e}_${t}`,cycle:t,text:`${o.name} fällt im Kampf`,tags:["DEATH"]}),G(o))),c=r.find(o=>o.id===e);if(c&&c.relationships.bloodOathWith){const o=c.relationships.bloodOathWith,l=r.findIndex(a=>a.id===o);if(l>=0){const a=r[l];a.status==="ALIVE"&&be(a,t)&&(s.push({officerId:a.id,status:"DEAD",reason:"BLOOD_OATH"}),n.push({id:`blood_${a.id}_${t}`,cycle:t,text:`${a.name} stirbt durch den Blutschwur mit ${c.name}`,tags:["DEATH","BLOODOATH"]}),r[l]=G(a))}}return this.state.officers=r,{updatedOfficers:r,casualties:s,feed:n}}rewardMerit(e,t,s,n){this.state.officers=this.state.officers.map(r=>{if(r.id!==e)return r;const c=ke(r,t);return v(c,{cycle:s,type:"WARCALL",notes:n})})}ensureRoster(e){const t=[];for(;this.getAlive().length<K;){const s=R(this.rng,{rank:"Grunzer"}),n=v(s,{cycle:e,type:"WARCALL",notes:"Frisch rekrutiert"});t.push(n),this.state.officers.push(n)}return t}registerBloodOath(e,t,s){this.state.officers=this.state.officers.map(n=>n.id===e?{...n,relationships:{...n.relationships,bloodOathWith:t},lastBloodOathCycle:s}:n.id===t?{...n,relationships:{...n.relationships,bloodOathWith:e},lastBloodOathCycle:s}:n)}detectCycleTrigger(e){return this.getAlive().length<e?"OFFICER_DEATH":null}}function C(i,e){let t=10+i.level*4+i.gearScore+i.merit*.15;for(const n of i.traits){const r=oe[n]??1;t*=r;const c=ce[n]??0;if(c>0){const o=e.filter(l=>l.traits.includes(n)).length;t*=1+o*c}}i.relationships.bloodOathWith&&e.some(n=>n.id===i.relationships.bloodOathWith)&&(t*=1.15);const s=e.filter(n=>i.relationships.friends.includes(n.id)).length;return t*=1+s*.05,i.relationships.rivals.some(n=>e.some(r=>r.id===n))&&(t*=.9),t*=.95+i.personality.aggression*.1,t*=.9+i.personality.loyalty*.1,t}function k(i,e){const t=i,s=i.reduce((r,c)=>r+C(c,t),0),n=.9+e.next()*.2;return s*n}function ve(i,e,t){let s=.05+e.personality.opportunism*.25-e.personality.loyalty*.2;return e.relationships.rivals.includes(t.id)&&(s+=.15),e.relationships.bloodOathWith===t.id&&(s=0),s>0&&i.chance(Math.min(.8,Math.max(0,s)))}function m(i,e,t,s){return{id:`feed_${e}_${Math.round(i.next()*1e9)}`,cycle:e,text:t,tags:s}}function Le(i,e){return e.map(t=>i.getById(t)).filter(t=>!!(t&&t.status==="ALIVE"))}function L(i,e,t,s,n){e.forEach(r=>i.rewardMerit(r.id,s,t,n))}function A(i,e,t){const{casualties:s,feed:n}=i.registerDeath(e.id,t);return{casualties:s,feed:n}}function z(i,e,t,s,n,r,c){const o=[];if(k(n,i)>=r){L(s,n,t.cycle,e.rewards.merit,c);const f=m(i,t.cycle,`${n[0].name}s Gruppe triumphiert bei ${e.location}`,[e.type,"SUCCESS"]);return o.push(f),{warcall:e,victorious:n.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:o}}const a=i.pick(n),d=A(s,a,t.cycle);return o.push(m(i,t.cycle,`${a.name} kehrt nicht von ${e.location} zurück`,[e.type,"DEATH"])),{warcall:e,victorious:[],defeated:[a.id],betrayals:[],casualties:d.casualties,feedEntries:[...o,...d.feed]}}function Ie(i,e,t,s,n){const r=[],c=e.hiddenRoles.find(u=>u.role==="ASSASSIN"),o=c?n.find(u=>u.id===c.who):n[0],l=n.find(u=>u.id!==(o==null?void 0:o.id));if(!o||!l)return r.push(m(i,t.cycle,`Attentat ${e.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=C(o,[o]),d=C(l,[l]),f=(i.next()-.5)*4;if(a+f>d){const u=A(s,l,t.cycle);return s.rewardMerit(o.id,e.rewards.merit,t.cycle,"Gelungenes Attentat"),r.push(m(i,t.cycle,`${o.name} meuchelt ${l.name} in ${e.location}`,["ASSASSINATION","SUCCESS"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}if(i.chance(.5)){const u=A(s,o,t.cycle);return r.push(m(i,t.cycle,`${o.name} stirbt beim gescheiterten Attentat auf ${l.name}`,["ASSASSINATION","DEATH"])),{warcall:e,victorious:[l.id],defeated:[o.id],betrayals:[],casualties:u.casualties,feedEntries:[...r,...u.feed]}}return r.push(m(i,t.cycle,`${l.name} wehrt ${o.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:e,victorious:[l.id],defeated:[],betrayals:[],casualties:[],feedEntries:r}}function Me(i,e,t,s,n){const r=[],c=n.find(h=>h.id===e.initiator);if(!c)return r.push(m(i,t.cycle,`Überfall ${e.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const o=n.filter(h=>h.id!==c.id);if(o.length===0)return r.push(m(i,t.cycle,`${c.name} findet keine Gegner für den Überfall`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const l=Math.max(1,Math.floor(o.length/2)),a=[c,...o.slice(0,l)],d=o.slice(l);if(d.length===0)return r.push(m(i,t.cycle,`${c.name} vertreibt Plünderer ohne Widerstand`,["OVERFALL","NO_DEF"])),L(s,a,t.cycle,Math.round(e.rewards.merit/2),"Leichter Überfall"),{warcall:e,victorious:a.map(h=>h.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const f=[];for(const h of a.slice(1))ve(i,h,c)&&(d.push(h),a.splice(a.indexOf(h),1),f.push(h.id));const u=k(a,i),E=k(d,i),y=u>=E,T=y?d:a,S=y?a:d;L(s,S,t.cycle,e.rewards.merit,"Überfall-Erfolg");const N=i.pick(T),g=A(s,N,t.cycle);return r.push(m(i,t.cycle,`${S[0].name}s Seite siegt bei ${e.location}`,["OVERFALL",y?"SUCCESS":"FAIL"])),{warcall:e,victorious:S.map(h=>h.id),defeated:T.map(h=>h.id),betrayals:f,casualties:g.casualties,feedEntries:[...r,...g.feed]}}function $e(i,e,t,s,n){const r=[],c=n.find(h=>h.id===e.initiator);if(!c)return r.push(m(i,t.cycle,`Säuberung ${e.id} scheitert ohne König`,["PURGE","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:r};const o=n.filter(h=>h.id===c.id||e.hiddenRoles.some(P=>P.who===h.id&&P.role==="LOYALIST")),l=n.filter(h=>!o.includes(h));if(l.length===0)return r.push(m(i,t.cycle,`${c.name} erzwingt neue Treueschwüre`,["PURGE","LOYALTY"])),L(s,o,t.cycle,Math.round(e.rewards.merit/2),"Treueeid"),{warcall:e,victorious:o.map(h=>h.id),defeated:[],betrayals:[],casualties:[],feedEntries:r};const a=l.filter(h=>i.chance(.4)),d=l.filter(h=>!a.includes(h)),f=d.map(h=>h.id);if(d.length===0)return r.push(m(i,t.cycle,`${c.name} erklärt ${a.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:e,victorious:o.map(h=>h.id),defeated:a.map(h=>h.id),betrayals:f,casualties:[],feedEntries:r};const u=k(o,i),E=k(d,i),y=u>=E,T=y?d:o,S=y?o:d,N=i.pick(T),g=A(s,N,t.cycle);return r.push(m(i,t.cycle,`${S[0].name} entscheidet die Säuberung`,["PURGE",y?"SUCCESS":"REBELLION"])),{warcall:e,victorious:S.map(h=>h.id),defeated:T.map(h=>h.id),betrayals:f,casualties:g.casualties,feedEntries:[...r,...g.feed]}}function Ne(i,e,t,s,n){const r=[];n.forEach(o=>s.rewardMerit(o.id,Math.round(e.rewards.merit/2),t.cycle,"Feast-Bindung"));const c=m(i,t.cycle,`${n[0].name} richtet ein heikles Festmahl in ${e.location}`,["FEAST","BOND"]);if(r.push(c),n.length>1&&i.chance(.15)){const o=i.pick(n.slice(1)),l=i.pick(n.filter(d=>d.id!==o.id)),a=A(s,l,t.cycle);return r.push(m(i,t.cycle,`${o.name} vergiftet ${l.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[o.id],casualties:a.casualties,feedEntries:[...r,...a.feed]}}return{warcall:e,victorious:n.map(o=>o.id),defeated:[],betrayals:[],casualties:[],feedEntries:r}}function we(i,e,t,s){const n=Le(s,e.participants);if(n.length===0)return{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[m(i,t.cycle,`Warcall ${e.id} entfällt mangels Teilnehmer`,["EMPTY"])]};switch(e.type){case"HUNT":return z(i,e,t,s,n,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return z(i,e,t,s,n,26,"Monster bezwungen");case"ASSASSINATION":return Ie(i,e,t,s,n);case"OVERFALL":return Me(i,e,t,s,n);case"PURGE":return $e(i,e,t,s,n);case"FEAST":default:return Ne(i,e,t,s,n)}}function D(i,e){return`wc_${i.cycle}_${i.warcalls.length}_${Math.round(e.next()*1e6)}`}function Ce(i){const e=i.next();return e<.5?"AGENDA":e<.8?"RANDOM":"PLAYER"}function De(i){return i.personality.aggression>.7?"OVERFALL":i.personality.opportunism>.6?"ASSASSINATION":i.rank==="König"?"PURGE":"FEAST"}function We(i){return i.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function W(i,e,t,s,n){const r=e.officers.filter(d=>d.status==="ALIVE"&&d.id!==t.id),c=i.shuffle(r);if(c.length===0)return[t];const o=Math.max(1,Math.min(s,c.length)),l=i.int(1,o),a=c.slice(0,l);if(n){const d=e.officers.find(f=>f.id===e.playerId&&f.status==="ALIVE");d&&!a.some(f=>f.id===d.id)&&d.id!==t.id&&(a[a.length-1]=d)}return[t,...a]}function F(i,e,t){return e==="ASSASSINATION"?[{who:i.pick(t).id,role:"ASSASSIN"}]:e==="PURGE"?t.slice(1).map(s=>({who:s.id,role:i.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function B(i){switch(i){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienjäger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function Fe(i,e,t){const s=De(t),n=W(i,e,t,s==="PURGE"?5:3,!1);return{id:D(e,i),type:s,source:"AGENDA",initiator:t.id,participants:n.map(r=>r.id),hiddenRoles:F(i,s,n),location:i.pick($),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:B(s),state:"ANNOUNCED"}}function Be(i,e){const t=e.officers.filter(c=>c.status==="ALIVE"),s=i.pick(t),n=We(i),r=W(i,e,s,3,!1);return{id:D(e,i),type:n,source:"RANDOM",initiator:s.id,participants:r.map(c=>c.id),hiddenRoles:F(i,n,r),location:i.pick($),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:B(n),state:"ANNOUNCED"}}function Pe(i,e){const t=e.officers.find(r=>r.id===e.playerId&&r.status==="ALIVE");if(!t)return null;const s=t.rank==="Grunzer"?"HUNT":"OVERFALL",n=W(i,e,t,2,!0);return{id:D(e,i),type:s,source:"PLAYER",initiator:t.id,participants:n.map(r=>r.id),hiddenRoles:F(i,s,n),location:i.pick($),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:B(s),state:"ANNOUNCED"}}function _e(i,e){const t=e.warcalls.filter(c=>c.state!=="RESOLVED"),s=i.int(ie,ne),n=Math.max(0,s-t.length),r=[];for(let c=0;c<n;c++){const o=Ce(i),l=e.officers.filter(d=>d.status==="ALIVE");if(l.length<2)break;let a=null;if(o==="AGENDA"){const d=[...l].sort((f,u)=>u.personality.ambition-f.personality.ambition);a=Fe(i,e,d[0])}else o==="RANDOM"?a=Be(i,e):a=Pe(i,e);a&&(r.push(a),e.warcalls.push(a))}return r}function Ge(i,e,t){const s=[];for(const n of e.warcalls){if(n.state==="RESOLVED"||e.cycle<n.deadlineCycle)continue;n.state="IN_PROGRESS";const r=we(i,n,e,t);n.state="RESOLVED",s.push(r)}return s}const x=["Grunzer","Späher","Captain","Anführer","Herausforderer","König"];function ze(i){const e=x.indexOf(i);return e===-1||e>=x.length-1?null:x[e+1]}function Ue(i){const e=x.indexOf(i);return e<=0?null:x[e-1]}function I(i,e,t,s){return{id:`cycle_${e}_${Math.round(i.next()*1e9)}`,cycle:e,text:t,tags:s}}function He(i,e){const t=[],s=[];return e.officers=e.officers.map(n=>{if(n.status!=="ALIVE")return n;const r=re[n.rank],c=r.promoteAtMerit!==null&&n.merit>=r.promoteAtMerit?ze(n.rank):null;if(c)return t.push({officerId:n.id,from:n.rank,to:c}),s.push(I(i,e.cycle,`${n.name} steigt zum ${c} auf`,["PROMOTION"])),v({...n,rank:c},{cycle:e.cycle,type:"PROMOTION",notes:`Aufstieg zu ${c}`});const o=r.demoteBelowMerit!==null&&n.merit<r.demoteBelowMerit?Ue(n.rank):null;return o?(t.push({officerId:n.id,from:n.rank,to:o}),s.push(I(i,e.cycle,`${n.name} fällt zum ${o} zurück`,["DEMOTION"])),v({...n,rank:o},{cycle:e.cycle,type:"DEMOTION",notes:`Rückstufung zu ${o}`})):n}),{changes:t,feed:s}}function Ke(i){return i.flatMap(e=>e.feedEntries)}function Ve(i,e,t="DEBUG"){const s=new Re(i,e),n=s.getAlive().length;e.cycle+=1;const r=Ge(i,e,s),c=He(i,e),o=s.ensureRoster(e.cycle),l=_e(i,e),a=[];a.push(...Ke(r)),a.push(...c.feed),o.forEach(u=>{a.push(I(i,e.cycle,`${u.name} tritt als Rekrut bei`,["RECRUIT"]))}),l.forEach(u=>{a.push(I(i,e.cycle,`Neuer Warcall ${u.type} bei ${u.location}`,["WARCALL","NEW"]))}),e.feed=[...e.feed,...a].slice(-60);const f=s.detectCycleTrigger(n)??t;return{cycle:e.cycle,trigger:f,newWarcalls:l,resolved:r,hierarchyChanges:c.changes,replacements:o,feed:a}}function Ye(i){return Array.from({length:K},(t,s)=>s===0?R(i,{rank:"König",titles:["König"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):s===1?R(i,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):R(i,{}))}class U{constructor(e){p(this,"state");p(this,"rng");this.rng=new te(e.seed);const t=Ye(this.rng),s=t[0].id,n=t[1].id;this.state={cycle:0,officers:t,warcalls:[],kingId:s,playerId:n,feed:[]}}runCycle(e="DEBUG"){return Ve(this.rng,this.state,e)}}const w=M(),je={WARCALL_COMPLETED:"Warcall abgeschlossen",FREE_ROAM_TIMEOUT:"Freies Spiel (Timeout)",OFFICER_DEATH:"Offizier gefallen",DEBUG:"Debug"};function Xe(i){const e=i.split(" ")[0]??i;return e.length>10?`${e.slice(0,9)}…`:e}class qe extends w.Scene{constructor(){super("Play");p(this,"world");p(this,"officerTokens",new Map);p(this,"cycleText");p(this,"triggerText");p(this,"feedText");p(this,"warcallsText");p(this,"detailText");p(this,"connections")}create(){this.world=new U({seed:Date.now()}),this.add.rectangle(320,270,620,500,1054496,.92).setStrokeStyle(2,2568767,.85),this.add.rectangle(800,270,280,520,857114,.92).setStrokeStyle(1,2041907,.6),this.connections=this.add.graphics(),this.connections.setDepth(.5),this.cycleText=this.add.text(24,24,"",{fontFamily:"monospace",fontSize:"22px",color:"#f1f2f6"}),this.triggerText=this.add.text(24,54,"",{fontFamily:"monospace",fontSize:"14px",color:"#cbd0d6"}),this.add.text(660,36,"Welt-Feed",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.feedText=this.add.text(660,68,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.add.text(660,268,"Aktive Warcalls",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.warcallsText=this.add.text(660,296,"",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:6}).setWordWrapWidth(240),this.add.text(660,424,"Details",{fontFamily:"monospace",fontSize:"16px",color:"#f1f2f6"}),this.detailText=this.add.text(660,452,"Fahre mit der Maus über ein Porträt oder tippe es an.",{fontFamily:"monospace",fontSize:"12px",color:"#d1d9e6",lineSpacing:4}).setWordWrapWidth(240),this.add.text(24,504,"E: Cycle simulieren   R: Welt neu generieren",{fontFamily:"monospace",fontSize:"12px",color:"#9da3ae"}),this.refreshScene(),this.input.keyboard.on("keydown-E",()=>this.advanceCycle()),this.input.keyboard.on("keydown-R",()=>this.resetWorld()),this.events.once(w.Scenes.Events.SHUTDOWN,()=>{this.officerTokens.forEach(n=>n.destroy()),this.officerTokens.clear()})}update(t,s){}advanceCycle(){const t=this.world.runCycle();this.refreshScene(t)}resetWorld(){this.officerTokens.forEach(t=>t.destroy()),this.officerTokens.clear(),this.world=new U({seed:Date.now()}),this.refreshScene()}refreshScene(t){const s=Q(t);this.cycleText.setText(`Cycle ${this.world.state.cycle}`);const n=t?this.formatTrigger(t.trigger):"Start der Kampagne";this.triggerText.setText(`Auslöser: ${n}`),this.syncOfficerTokens(s,t),this.refreshFeed(t),this.refreshWarcalls(t),this.drawConnections(t)}formatTrigger(t){return je[t]??t}syncOfficerTokens(t,s){const n=ee(this.world.state.officers.length),r=new Set,c=!s;this.world.state.officers.forEach((o,l)=>{const a=n[l],d=t.has(o.id);let f=this.officerTokens.get(o.id);f?(f.setPosition(a.x,a.y,{immediate:c}),f.update(o,{highlight:d})):(f=new J({scene:this,x:a.x,y:a.y,officer:o,highlight:d,onHover:u=>this.showOfficerDetails(u),onBlur:()=>this.clearOfficerDetails()}),this.officerTokens.set(o.id,f)),r.add(o.id)}),this.officerTokens.forEach((o,l)=>{r.has(l)||(o.destroy(),this.officerTokens.delete(l))})}refreshFeed(t){const s=new Set((t==null?void 0:t.feed.map(c=>c.id))??[]),n=this.world.state.feed.slice(-7);if(n.length===0){this.feedText.setText("Keine Meldungen – starte einen Warcall!");return}const r=n.map(c=>`${s.has(c.id)?"»":"•"} [${c.cycle}] ${c.text}`);this.feedText.setText(r.join(`

`))}refreshWarcalls(t){const s=this.world.state.warcalls.filter(c=>c.state!=="RESOLVED");if(s.length===0){this.warcallsText.setText("Keine aktiven Warcalls.");return}const n=new Set((t==null?void 0:t.newWarcalls.map(c=>c.id))??[]),r=s.map(c=>this.describeWarcall(c,n.has(c.id)));this.warcallsText.setText(r.join(`

`))}describeWarcall(t,s){const n=s?"»":"•",r=[t.initiator,...t.participants].map(c=>this.getOfficerShortName(c)).join(", ");return`${n} ${t.type} @ ${t.location}
   ${r}`}drawConnections(t){this.connections.clear();const s=(r,c,o,l)=>{const a=this.officerTokens.get(r.initiator);if(!a)return;const d=a.getPosition();r.participants.forEach(f=>{const u=this.officerTokens.get(f);if(!u)return;const E=u.getPosition();this.connections.lineStyle(l,c,o),this.connections.strokeLineShape(new w.Geom.Line(d.x,d.y,E.x,E.y))})};this.world.state.warcalls.filter(r=>r.state!=="RESOLVED").forEach(r=>s(r,5032432,.35,2)),t&&(t.newWarcalls.forEach(r=>s(r,16170336,.65,3)),t.resolved.forEach(r=>s(r.warcall,15681391,.55,3)))}showOfficerDetails(t){const s=t.traits.length>0?t.traits.join(", "):"Keine bekannten Traits",n=t.relationships.bloodOathWith?`Blutschwur: ${this.getOfficerShortName(t.relationships.bloodOathWith)}`:void 0,r=t.relationships.loyalToKing?"Loyal zum König":void 0,c=t.relationships.friends.length>0?`Freunde: ${t.relationships.friends.length}`:void 0,o=t.relationships.rivals.length>0?`Rivalen: ${t.relationships.rivals.length}`:void 0,l=[n,r,c,o].filter(Boolean).join(" • ")||"Ungebunden";this.detailText.setText(`${t.name} (${t.rank}, Lv ${t.level})
Clan ${t.clan} • Merit ${t.merit}
Traits: ${s}
Beziehungen: ${l}`)}clearOfficerDetails(){this.detailText.setText("Fahre mit der Maus über ein Porträt oder tippe es an.")}getOfficerShortName(t){const s=this.world.state.officers.find(r=>r.id===t);if(!s)return t.slice(0,6);const n=Xe(s.name);return s.rank==="König"?`👑 ${n}`:n}}const H=M();class Je extends H.Game{constructor(e){const t={type:H.AUTO,parent:e,width:960,height:540,backgroundColor:"#0b0d10",pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[X,qe]};super(t)}}new Je(document.getElementById("app"));
=======
var W=Object.defineProperty;var z=(t,e,n)=>e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>z(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function C(){const t=globalThis.Phaser;if(!t)throw new Error("Phaser runtime not found on globalThis. Make sure to load the CDN script before importing the game.");return t}const V=C();class H extends V.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Play")}}class K{constructor(e){A(this,"state");this.state=e>>>0}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967295}int(e,n){return Math.floor(this.next()*(n-e+1))+e}chance(e){return this.next()<e}pick(e){if(e.length===0)throw new Error("Cannot pick from empty array");return e[this.int(0,e.length-1)]}shuffle(e){const n=[...e];for(let i=n.length-1;i>0;i--){const r=this.int(0,i);[n[i],n[r]]=[n[r],n[i]]}return n}}const U=20,Y=2,q=4,X=10,j={Grunzer:{promoteAtMerit:40,demoteBelowMerit:null},Späher:{promoteAtMerit:90,demoteBelowMerit:20},Captain:{promoteAtMerit:160,demoteBelowMerit:60},Anführer:{promoteAtMerit:240,demoteBelowMerit:120},Herausforderer:{promoteAtMerit:360,demoteBelowMerit:200},König:{promoteAtMerit:null,demoteBelowMerit:260}},J={Berserker:1.15,Taktiker:1.1,Feigling:.85,UnsterblichGeruecht:1.05,Tierbaendiger:1.05,Diplomat:1,Schleicher:1.05,GraueEminenz:1},Q={Taktiker:.05,Diplomat:.03,GraueEminenz:.06},Z=["Berserker","Taktiker","Feigling","UnsterblichGeruecht","Tierbaendiger","Diplomat","Schleicher","GraueEminenz"],ee=["Eisenfaust","Schlackenmaehne","Blutfaenger","Glutfaust","Ascheklaue"],N=["Schlackengrube","Schädelhügel","Schwarzmoor","Aschepass","Blutforst","Fungusgrotte"],te=["Gor","Muz","Shag","Ug","Sna","Krak","Naz","Bog","Ruk","Lug"],ne=["zug","gash","rin","lok","ga","hka","grok","dur","dug","dash"],re=["Bestienjäger","Schattenklinge","Schinder","Lagermeister","Brandstifter","Seher"],ie=["Axt","Doppelaxt","Wurfklinge","Speer","Kriegstrommel"],se=["Leder","Ketten","Schuppen","Schädelplatten"],oe=["Blutring","Schlackenfetisch","Königszahn","Sturmsiegel"],ce=["Axt","Wurfklinge","Bogen","Streitkolben","Schamane"];function g(t){return Math.max(0,Math.min(1,t))}function ae(t){return`${t.pick(te)}${t.pick(ne)}`}function le(t){return{aggression:g(t.next()),loyalty:g(t.next()),opportunism:g(t.next()),ambition:g(t.next())}}function ue(t){const e=t.chance(.3)?2:1;return t.shuffle(Z).slice(0,e)}function de(t){const e=t.shuffle(ce),n=t.chance(.25)?2:1;return e.slice(0,n)}function he(t){const e=t.chance(.5)?t.pick(oe):void 0;return{weapon:t.pick(ie),armor:t.pick(se),trinket:e}}function fe(t){switch(t){case"Grunzer":return 10;case"Späher":return 40;case"Captain":return 80;case"Anführer":return 140;case"Herausforderer":return 210;case"König":return 320}}function pe(t){return t.chance(.3)?[t.pick(re)]:[]}function k(t,e={}){const n=e.rank??"Grunzer",i=e.id??`orc_${Math.round(t.next()*1e9)}`,r=e.equipment??he(t),s=e.level??t.int(n==="König"?8:1,n==="König"?12:6),c=e.merit??Math.max(0,Math.round(fe(n)+t.int(-15,20)));return{id:i,name:e.name??ae(t),clan:e.clan??t.pick(ee),titles:e.titles??pe(t),level:s,rank:n,merit:c,combatStyle:e.combatStyle??de(t),traits:e.traits??ue(t),equipment:r,gearScore:e.gearScore??t.int(8,16),status:e.status??"ALIVE",personality:e.personality??le(t),relationships:e.relationships??{friends:[],rivals:[],loyalToKing:!1},memories:e.memories??[],territory:e.territory??[t.pick(N)],lastBloodOathCycle:e.lastBloodOathCycle}}function L(t,e,n=12){const i=[...t.memories,e].slice(-n);return{...t,memories:i}}function me(t,e){return{...t,merit:Math.max(0,t.merit+e)}}function F(t){return{...t,status:"DEAD"}}function ye(t,e){return t.relationships.bloodOathWith?t.lastBloodOathCycle!==void 0&&e-t.lastBloodOathCycle<=X:!1}class Ae{constructor(e,n){this.rng=e,this.state=n}getAlive(){return this.state.officers.filter(e=>e.status==="ALIVE")}getById(e){return this.state.officers.find(n=>n.id===e)}registerDeath(e,n){const i=[],r=[],s=this.state.officers.map(o=>o.id!==e?o:(i.push({officerId:e,status:"DEAD",reason:"BATTLE"}),r.push({id:`death_${e}_${n}`,cycle:n,text:`${o.name} fällt im Kampf`,tags:["DEATH"]}),F(o))),c=s.find(o=>o.id===e);if(c&&c.relationships.bloodOathWith){const o=c.relationships.bloodOathWith,l=s.findIndex(a=>a.id===o);if(l>=0){const a=s[l];a.status==="ALIVE"&&ye(a,n)&&(i.push({officerId:a.id,status:"DEAD",reason:"BLOOD_OATH"}),r.push({id:`blood_${a.id}_${n}`,cycle:n,text:`${a.name} stirbt durch den Blutschwur mit ${c.name}`,tags:["DEATH","BLOODOATH"]}),s[l]=F(a))}}return this.state.officers=s,{updatedOfficers:s,casualties:i,feed:r}}rewardMerit(e,n,i,r){this.state.officers=this.state.officers.map(s=>{if(s.id!==e)return s;const c=me(s,n);return L(c,{cycle:i,type:"WARCALL",notes:r})})}ensureRoster(e){const n=[];for(;this.getAlive().length<U;){const i=k(this.rng,{rank:"Grunzer"}),r=L(i,{cycle:e,type:"WARCALL",notes:"Frisch rekrutiert"});n.push(r),this.state.officers.push(r)}return n}registerBloodOath(e,n,i){this.state.officers=this.state.officers.map(r=>r.id===e?{...r,relationships:{...r.relationships,bloodOathWith:n},lastBloodOathCycle:i}:r.id===n?{...r,relationships:{...r.relationships,bloodOathWith:e},lastBloodOathCycle:i}:r)}detectCycleTrigger(e){return this.getAlive().length<e?"OFFICER_DEATH":null}}function $(t,e){let n=10+t.level*4+t.gearScore+t.merit*.15;for(const r of t.traits){const s=J[r]??1;n*=s;const c=Q[r]??0;if(c>0){const o=e.filter(l=>l.traits.includes(r)).length;n*=1+o*c}}t.relationships.bloodOathWith&&e.some(r=>r.id===t.relationships.bloodOathWith)&&(n*=1.15);const i=e.filter(r=>t.relationships.friends.includes(r.id)).length;return n*=1+i*.05,t.relationships.rivals.some(r=>e.some(s=>s.id===r))&&(n*=.9),n*=.95+t.personality.aggression*.1,n*=.9+t.personality.loyalty*.1,n}function R(t,e){const n=t,i=t.reduce((s,c)=>s+$(c,n),0),r=.9+e.next()*.2;return i*r}function Ee(t,e,n){let i=.05+e.personality.opportunism*.25-e.personality.loyalty*.2;return e.relationships.rivals.includes(n.id)&&(i+=.15),e.relationships.bloodOathWith===n.id&&(i=0),i>0&&t.chance(Math.min(.8,Math.max(0,i)))}function p(t,e,n,i){return{id:`feed_${e}_${Math.round(t.next()*1e9)}`,cycle:e,text:n,tags:i}}function Se(t,e){return e.map(n=>t.getById(n)).filter(n=>!!(n&&n.status==="ALIVE"))}function I(t,e,n,i,r){e.forEach(s=>t.rewardMerit(s.id,i,n,r))}function E(t,e,n){const{casualties:i,feed:r}=t.registerDeath(e.id,n);return{casualties:i,feed:r}}function w(t,e,n,i,r,s,c){const o=[];if(R(r,t)>=s){I(i,r,n.cycle,e.rewards.merit,c);const f=p(t,n.cycle,`${r[0].name}s Gruppe triumphiert bei ${e.location}`,[e.type,"SUCCESS"]);return o.push(f),{warcall:e,victorious:r.map(h=>h.id),defeated:[],betrayals:[],casualties:[],feedEntries:o}}const a=t.pick(r),d=E(i,a,n.cycle);return o.push(p(t,n.cycle,`${a.name} kehrt nicht von ${e.location} zurück`,[e.type,"DEATH"])),{warcall:e,victorious:[],defeated:[a.id],betrayals:[],casualties:d.casualties,feedEntries:[...o,...d.feed]}}function Oe(t,e,n,i,r){const s=[],c=e.hiddenRoles.find(h=>h.role==="ASSASSIN"),o=c?r.find(h=>h.id===c.who):r[0],l=r.find(h=>h.id!==(o==null?void 0:o.id));if(!o||!l)return s.push(p(t,n.cycle,`Attentat ${e.id} scheitert mangels Opfer`,["ASSASSINATION","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const a=$(o,[o]),d=$(l,[l]),f=(t.next()-.5)*4;if(a+f>d){const h=E(i,l,n.cycle);return i.rewardMerit(o.id,e.rewards.merit,n.cycle,"Gelungenes Attentat"),s.push(p(t,n.cycle,`${o.name} meuchelt ${l.name} in ${e.location}`,["ASSASSINATION","SUCCESS"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[],casualties:h.casualties,feedEntries:[...s,...h.feed]}}if(t.chance(.5)){const h=E(i,o,n.cycle);return s.push(p(t,n.cycle,`${o.name} stirbt beim gescheiterten Attentat auf ${l.name}`,["ASSASSINATION","DEATH"])),{warcall:e,victorious:[l.id],defeated:[o.id],betrayals:[],casualties:h.casualties,feedEntries:[...s,...h.feed]}}return s.push(p(t,n.cycle,`${l.name} wehrt ${o.name}s Angriff ab`,["ASSASSINATION","FAIL"])),{warcall:e,victorious:[l.id],defeated:[],betrayals:[],casualties:[],feedEntries:s}}function Te(t,e,n,i,r){const s=[],c=r.find(u=>u.id===e.initiator);if(!c)return s.push(p(t,n.cycle,`Überfall ${e.id} scheitert ohne Initiator`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const o=r.filter(u=>u.id!==c.id);if(o.length===0)return s.push(p(t,n.cycle,`${c.name} findet keine Gegner für den Überfall`,["OVERFALL","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const l=Math.max(1,Math.floor(o.length/2)),a=[c,...o.slice(0,l)],d=o.slice(l);if(d.length===0)return s.push(p(t,n.cycle,`${c.name} vertreibt Plünderer ohne Widerstand`,["OVERFALL","NO_DEF"])),I(i,a,n.cycle,Math.round(e.rewards.merit/2),"Leichter Überfall"),{warcall:e,victorious:a.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:s};const f=[];for(const u of a.slice(1))Ee(t,u,c)&&(d.push(u),a.splice(a.indexOf(u),1),f.push(u.id));const h=R(a,t),M=R(d,t),m=h>=M,S=m?d:a,y=m?a:d;I(i,y,n.cycle,e.rewards.merit,"Überfall-Erfolg");const v=t.pick(S),O=E(i,v,n.cycle);return s.push(p(t,n.cycle,`${y[0].name}s Seite siegt bei ${e.location}`,["OVERFALL",m?"SUCCESS":"FAIL"])),{warcall:e,victorious:y.map(u=>u.id),defeated:S.map(u=>u.id),betrayals:f,casualties:O.casualties,feedEntries:[...s,...O.feed]}}function Re(t,e,n,i,r){const s=[],c=r.find(u=>u.id===e.initiator);if(!c)return s.push(p(t,n.cycle,`Säuberung ${e.id} scheitert ohne König`,["PURGE","ABORTED"])),{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:s};const o=r.filter(u=>u.id===c.id||e.hiddenRoles.some(_=>_.who===u.id&&_.role==="LOYALIST")),l=r.filter(u=>!o.includes(u));if(l.length===0)return s.push(p(t,n.cycle,`${c.name} erzwingt neue Treueschwüre`,["PURGE","LOYALTY"])),I(i,o,n.cycle,Math.round(e.rewards.merit/2),"Treueeid"),{warcall:e,victorious:o.map(u=>u.id),defeated:[],betrayals:[],casualties:[],feedEntries:s};const a=l.filter(u=>t.chance(.4)),d=l.filter(u=>!a.includes(u)),f=d.map(u=>u.id);if(d.length===0)return s.push(p(t,n.cycle,`${c.name} erklärt ${a.length} Offiziere zu Vogelfreien`,["PURGE","EXILE"])),{warcall:e,victorious:o.map(u=>u.id),defeated:a.map(u=>u.id),betrayals:f,casualties:[],feedEntries:s};const h=R(o,t),M=R(d,t),m=h>=M,S=m?d:o,y=m?o:d,v=t.pick(S),O=E(i,v,n.cycle);return s.push(p(t,n.cycle,`${y[0].name} entscheidet die Säuberung`,["PURGE",m?"SUCCESS":"REBELLION"])),{warcall:e,victorious:y.map(u=>u.id),defeated:S.map(u=>u.id),betrayals:f,casualties:O.casualties,feedEntries:[...s,...O.feed]}}function ge(t,e,n,i,r){const s=[];r.forEach(o=>i.rewardMerit(o.id,Math.round(e.rewards.merit/2),n.cycle,"Feast-Bindung"));const c=p(t,n.cycle,`${r[0].name} richtet ein heikles Festmahl in ${e.location}`,["FEAST","BOND"]);if(s.push(c),r.length>1&&t.chance(.15)){const o=t.pick(r.slice(1)),l=t.pick(r.filter(d=>d.id!==o.id)),a=E(i,l,n.cycle);return s.push(p(t,n.cycle,`${o.name} vergiftet ${l.name} beim Fest`,["FEAST","BETRAYAL"])),{warcall:e,victorious:[o.id],defeated:[l.id],betrayals:[o.id],casualties:a.casualties,feedEntries:[...s,...a.feed]}}return{warcall:e,victorious:r.map(o=>o.id),defeated:[],betrayals:[],casualties:[],feedEntries:s}}function ke(t,e,n,i){const r=Se(i,e.participants);if(r.length===0)return{warcall:e,victorious:[],defeated:[],betrayals:[],casualties:[],feedEntries:[p(t,n.cycle,`Warcall ${e.id} entfällt mangels Teilnehmer`,["EMPTY"])]};switch(e.type){case"HUNT":return w(t,e,n,i,r,16,"Erfolgreiche Jagd");case"MONSTER_HUNT":return w(t,e,n,i,r,26,"Monster bezwungen");case"ASSASSINATION":return Oe(t,e,n,i,r);case"OVERFALL":return Te(t,e,n,i,r);case"PURGE":return Re(t,e,n,i,r);case"FEAST":default:return ge(t,e,n,i,r)}}function x(t,e){return`wc_${t.cycle}_${t.warcalls.length}_${Math.round(e.next()*1e6)}`}function Le(t){const e=t.next();return e<.5?"AGENDA":e<.8?"RANDOM":"PLAYER"}function Ie(t){return t.personality.aggression>.7?"OVERFALL":t.personality.opportunism>.6?"ASSASSINATION":t.rank==="König"?"PURGE":"FEAST"}function be(t){return t.pick(["HUNT","MONSTER_HUNT","FEAST","OVERFALL"])}function D(t,e,n,i,r){const s=e.officers.filter(d=>d.status==="ALIVE"&&d.id!==n.id),c=t.shuffle(s);if(c.length===0)return[n];const o=Math.max(1,Math.min(i,c.length)),l=t.int(1,o),a=c.slice(0,l);if(r){const d=e.officers.find(f=>f.id===e.playerId&&f.status==="ALIVE");d&&!a.some(f=>f.id===d.id)&&d.id!==n.id&&(a[a.length-1]=d)}return[n,...a]}function B(t,e,n){return e==="ASSASSINATION"?[{who:t.pick(n).id,role:"ASSASSIN"}]:e==="PURGE"?n.slice(1).map(i=>({who:i.id,role:t.chance(.5)?"LOYALIST":"TRAITOR"})):[]}function P(t){switch(t){case"FEAST":return{xp:10,merit:8,titles:[]};case"OVERFALL":return{xp:30,merit:20,titles:[]};case"ASSASSINATION":return{xp:35,merit:28,titles:[]};case"HUNT":return{xp:18,merit:14,titles:[]};case"MONSTER_HUNT":return{xp:45,merit:30,titles:["Bestienjäger"]};case"PURGE":return{xp:50,merit:35,titles:[]}}}function Ne(t,e,n){const i=Ie(n),r=D(t,e,n,i==="PURGE"?5:3,!1);return{id:x(e,t),type:i,source:"AGENDA",initiator:n.id,participants:r.map(s=>s.id),hiddenRoles:B(t,i,r),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(i),state:"ANNOUNCED"}}function Me(t,e){const n=e.officers.filter(c=>c.status==="ALIVE"),i=t.pick(n),r=be(t),s=D(t,e,i,3,!1);return{id:x(e,t),type:r,source:"RANDOM",initiator:i.id,participants:s.map(c=>c.id),hiddenRoles:B(t,r,s),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(r),state:"ANNOUNCED"}}function ve(t,e){const n=e.officers.find(s=>s.id===e.playerId&&s.status==="ALIVE");if(!n)return null;const i=n.rank==="Grunzer"?"HUNT":"OVERFALL",r=D(t,e,n,2,!0);return{id:x(e,t),type:i,source:"PLAYER",initiator:n.id,participants:r.map(s=>s.id),hiddenRoles:B(t,i,r),location:t.pick(N),startCycle:e.cycle,deadlineCycle:e.cycle+1,rewards:P(i),state:"ANNOUNCED"}}function $e(t,e){const n=e.warcalls.filter(c=>c.state!=="RESOLVED"),i=t.int(Y,q),r=Math.max(0,i-n.length),s=[];for(let c=0;c<r;c++){const o=Le(t),l=e.officers.filter(d=>d.status==="ALIVE");if(l.length<2)break;let a=null;if(o==="AGENDA"){const d=[...l].sort((f,h)=>h.personality.ambition-f.personality.ambition);a=Ne(t,e,d[0])}else o==="RANDOM"?a=Me(t,e):a=ve(t,e);a&&(s.push(a),e.warcalls.push(a))}return s}function Ce(t,e,n){const i=[];for(const r of e.warcalls){if(r.state==="RESOLVED"||e.cycle<r.deadlineCycle)continue;r.state="IN_PROGRESS";const s=ke(t,r,e,n);r.state="RESOLVED",i.push(s)}return i}const T=["Grunzer","Späher","Captain","Anführer","Herausforderer","König"];function xe(t){const e=T.indexOf(t);return e===-1||e>=T.length-1?null:T[e+1]}function De(t){const e=T.indexOf(t);return e<=0?null:T[e-1]}function b(t,e,n,i){return{id:`cycle_${e}_${Math.round(t.next()*1e9)}`,cycle:e,text:n,tags:i}}function Be(t,e){const n=[],i=[];return e.officers=e.officers.map(r=>{if(r.status!=="ALIVE")return r;const s=j[r.rank],c=s.promoteAtMerit!==null&&r.merit>=s.promoteAtMerit?xe(r.rank):null;if(c)return n.push({officerId:r.id,from:r.rank,to:c}),i.push(b(t,e.cycle,`${r.name} steigt zum ${c} auf`,["PROMOTION"])),L({...r,rank:c},{cycle:e.cycle,type:"PROMOTION",notes:`Aufstieg zu ${c}`});const o=s.demoteBelowMerit!==null&&r.merit<s.demoteBelowMerit?De(r.rank):null;return o?(n.push({officerId:r.id,from:r.rank,to:o}),i.push(b(t,e.cycle,`${r.name} fällt zum ${o} zurück`,["DEMOTION"])),L({...r,rank:o},{cycle:e.cycle,type:"DEMOTION",notes:`Rückstufung zu ${o}`})):r}),{changes:n,feed:i}}function Pe(t){return t.flatMap(e=>e.feedEntries)}function _e(t,e,n="DEBUG"){const i=new Ae(t,e),r=i.getAlive().length;e.cycle+=1;const s=Ce(t,e,i),c=Be(t,e),o=i.ensureRoster(e.cycle),l=$e(t,e),a=[];a.push(...Pe(s)),a.push(...c.feed),o.forEach(h=>{a.push(b(t,e.cycle,`${h.name} tritt als Rekrut bei`,["RECRUIT"]))}),l.forEach(h=>{a.push(b(t,e.cycle,`Neuer Warcall ${h.type} bei ${h.location}`,["WARCALL","NEW"]))}),e.feed=[...e.feed,...a].slice(-60);const f=i.detectCycleTrigger(r)??n;return{cycle:e.cycle,trigger:f,newWarcalls:l,resolved:s,hierarchyChanges:c.changes,replacements:o,feed:a}}function Fe(t){return Array.from({length:U},(n,i)=>i===0?k(t,{rank:"König",titles:["König"],relationships:{friends:[],rivals:[],loyalToKing:!0}}):i===1?k(t,{rank:"Grunzer",titles:[],relationships:{friends:[],rivals:[],loyalToKing:!1}}):k(t,{}))}class we{constructor(e){A(this,"state");A(this,"rng");this.rng=new K(e.seed);const n=Fe(this.rng),i=n[0].id,r=n[1].id;this.state={cycle:0,officers:n,warcalls:[],kingId:i,playerId:r,feed:[]}}runCycle(e="DEBUG"){return _e(this.rng,this.state,e)}}const Ge=C();class Ue extends Ge.Scene{constructor(){super("Play");A(this,"world");A(this,"info")}create(){this.world=new we({seed:Date.now()}),this.info=this.add.text(8,8,"Cycle 0",{fontSize:"14px"}).setDepth(10),this.input.keyboard.on("keydown-E",()=>{const n=this.world.runCycle();this.info.setText(`Cycle ${n.cycle} | Feed: ${n.feed.length} | Resolved: ${n.resolved.length}`),console.table(n.feed.slice(-5))}),this.add.text(8,28,"Drück E für nächsten Cycle",{fontSize:"12px"})}update(n,i){}}const G=C();class We extends G.Game{constructor(e){const n={type:G.AUTO,parent:e,width:960,height:540,backgroundColor:"#0b0d10",pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}},scene:[H,Ue]};super(n)}}new We(document.getElementById("app"));

